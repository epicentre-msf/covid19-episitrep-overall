---
title: 'MSF Covid-19 EpiSitrep worldwide overview'
description: |
  This document presents maps, tables and graphs to describe the current Covid-19 pandemic from the MSF perspective (not much text). Most, but not all, of these analyses are presented and commented in the MSF Intersection Covid-19 EpiSitrep edited by Epicentre (for information on the EpiSitrep, please contact Anais.BROBAN@epicentre.msf.org). 
  
  The R scripts for both worldwide and MSF linelist analyses are provided on the following Github repository https://github.com/epicentre-msf/covid19-episitrep-overall for epidemiologists in MSF to use (R skills required). The scripts will be updated from week to week as analysis progresses as requested. 
date: '`r Sys.Date()`'
author:
  - name: Francesco Grandesso
    affiliation: Epicentre (MSF)
output: 
  distill::distill_article:
    toc: TRUE
    toc_depth: 1
editor_options: 
  chunk_output_type: console
---


<!-- Setup and uploading functions -->
```{r setup, include = FALSE}

# Set environment
if (!exists('path.root')) {
  source(here::here('R', 'setup.r'), encoding = 'UTF-8')
}

knitr::opts_chunk$set(cache = FALSE, 
                      echo = FALSE, 
                      tidy = TRUE, 
                      collapse = TRUE, 
                      dpi = 150, 
                      fig.width = 8, 
                      fig.height = 5, 
                      fig.align = "center", 
                      warning = FALSE, 
                      message = FALSE, 
                      encoding = "UTF-8")


# Upload functions
source(file.path(path.R, 'utils_management.R'), encoding = 'UTF-8')
source(file.path(path.R, 'utils_vis.R')       , encoding = 'UTF-8')

# Default parameters for analysis
source(file.path(path.R, "set_time_frame.R")  , encoding = "UTF-8")

update_world_data <- FALSE
update_models <- FALSE


# Option to update ECDC data
get_updated_world_data <- ifelse(isTRUE(update_world_data) | 
                                   !file.exists(file.path(path.local.worldwide.data, 'last_save_date.RDS')), 
                                 TRUE, 
                                 ifelse(
                                   readRDS(file.path(path.local.worldwide.data, 'last_save_date.RDS')) != Sys.Date(), 
                                   TRUE, 
                                   FALSE))

# Option to update the trend models
update_models <- ifelse(isTRUE(get_updated_world_data) | 
                          isTRUE(update_models) | 
                          !file.exists(file.path(path.local.worldwide.data, 'models_trends.RData')), 
                        TRUE, 
                        FALSE)


# Option to update the trend models
update_test_data <- ifelse(isTRUE(get_updated_world_data) | 
                          isTRUE(update_models) | 
                          !file.exists(file.path(path.local.worldwide.data, 'models_trends.RData')), 
                        TRUE, 
                        FALSE)



# Choice for models to be used
model_for_trends   <- 'linear' # for trends
model_for_doubling <- 'linear' # for doubling time

period_trends <- 12
threshold_doubling_time <- 12

# Default parameters for graphics
RdAmGn <- c('#D95F02', '#E6AB02', '#1B9E77') # Three-colours palette (Red-Amber-Green) colour-blind safe
caption_world_map <- paste0('Analysis and graphic by Epicentre | Data source: ECDC as of ', format(date_max_report, '%d %b %Y'))

```


<!-- Import data -->
```{r GetData, include = FALSE}

source(file.path(path.R, 'run_get_world_data.R'), encoding = 'UTF-8')
source(file.path(path.R, 'run_model_trends.R')  , encoding = 'UTF-8')

```


# Data sources and definitions

This report uses the following data sources: 

  - [ECDC data](https://opendata.ecdc.europa.eu/covid19/casedistribution/csv) last updated `r format(max(df_ecdc$date, na.rm = TRUE), "%d %b %Y")`.
  -	MSF linelists compiled by Epicentre
  -	MSF [GIS Unit](https://mapcentre.msf.org/) (baseline country maps)
  -	FIND [Diagnostics Resource Centre Unit](https://www.finddx.org/covid-19/) for data on Covid-19 tests

Definitions of increasing, declining and stable trends and the definition of doubling time, as well as detailed information on the analysis methods, can be found [here](https://msfintl-my.sharepoint.com/:u:/g/personal/francesco_grandesso_epicentre_msf_org/EZqExKcP8axMj06voaLlveABpiicCfzkk5OWB-EaJvo9Fw?e=lwU1eM).

Additional graphics and tables are also available at the [Epicentre COVID-19 Epi Dashboard](https://reports.msf.net/public/covid19/).

**IMPORTANT NOTE:** Data and results presented here are possibly affected by bias related with factors such as the testing strategies used by each country and the performance of their surveillance systems. Results are to be interpreted in the light of this information.


<!-- Main common dataframes used in the analysis -->
```{r TblCount}

# --- --- --- --- --- 
# Breaks and labels 
# --- --- --- --- --- 

breaks_cases <- c(0, 1, 50, 100, 1000, 10000, 100000, 1000000, Inf)
labels_cases <- label_breaks(breaks_cases, big_numbers = TRUE) %>% gsub("\\<0-1\\>", "0", .)

breaks_deaths <- c(0, 1, 50, 100, 1000, 10000, 100000, Inf)
labels_deaths <- label_breaks(breaks_deaths, big_numbers = TRUE) %>% gsub("\\<0-1\\>", "0", .)


# --- --- --- --- --- 
# Cases 
# --- --- --- --- --- 

# Summary table of total cases
tbl_cases_count <- dfc_ecdc %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(cases = sum(cases, na.rm = TRUE)) %>% 
  mutate(brks = cut(cases, breaks_cases, labels = labels_cases, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of cases in the last 30 days 
tbl_cases_count_30d <- dfc_ecdc %>% 
  filter(between(date, left = date_max_report-29, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(cases = sum(cases, na.rm = TRUE)) %>% 
  mutate(brks = cut(cases, breaks_cases, labels = labels_cases, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of cases in the last 12 days 
tbl_cases_count_12d <- dfc_ecdc %>% 
  filter(between(date, left = date_max_report-11, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(cases = sum(cases, na.rm = TRUE)) %>% 
  mutate(brks = cut(cases, breaks_cases, labels = labels_cases, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()


# --- --- --- --- --- 
# Deaths
# --- --- --- --- --- 

# Summary table of total deaths
tbl_deaths_count <- dfc_ecdc %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  mutate(brks = cut(deaths, breaks_deaths, labels = labels_deaths, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of deaths in the last 30 days 
tbl_deaths_count_30d <- dfc_ecdc %>% 
  filter(between(date, left = date_max_report-29, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  mutate(brks = cut(deaths, breaks_deaths, labels = labels_deaths, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of deaths in the last 12 days 
tbl_deaths_count_12d <- dfc_ecdc %>% 
  filter(between(date, left = date_max_report-11, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  mutate(brks = cut(deaths, breaks_deaths, labels = labels_deaths, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

```


# Counts and trends of Covid-19 cases

**`r Words(length(tbl_cases_count %>% call_countries_with(100000, Inf, 'cases')))` countries with more than 100k cases**`r glue(" (in decreasing order): {tbl_cases_count %>% call_countries_with(100000, Inf, 'cases') %>% combine_words()}")` (Figure \@ref(fig:MapWorldCasesCount)). 

**`r Words(length(tbl_cases_count %>% call_countries_with(1000000, Inf, 'cases')))` countries with more than 1M cases** (in decreasing order): `r glue(" (in decreasing order): {tbl_cases_count %>% call_countries_with(1000000, Inf, 'cases') %>% combine_words()}")`. 

**`r Words(length(tbl_cases_count %>% filter(continent =='Africa') %>% call_countries_with(10000, Inf, 'cases')))` African countries with more than 10k cases**`r glue(" (in decreasing order): {tbl_cases_count %>% filter(continent =='Africa') %>% call_countries_with(10000, Inf, 'cases') %>% combine_words()}")`. 

**`r Words(length(tbl_cases_count %>% filter(continent =='Africa') %>% call_countries_with(1000, 9999, 'cases')))` African countries with more than 1000 cases**`r glue(" (in decreasing order): {tbl_cases_count %>% filter(continent =='Africa') %>% call_countries_with(1000, 9999, 'cases') %>% combine_words()}")`. 


**`r Words(length(tbl_cases_count %>% filter(continent == 'Africa') %>% call_countries_with(1, 49, 'cases')))` African countries with less than 50 cases**`r glue(" (in decreasing order): {tbl_cases_count %>% filter(continent == 'Africa') %>% call_countries_with(1, 49, 'cases') %>% combine_words()}")`. 


<!-- Map World cases -->
```{r MapWorldCasesCount, fig.width = 8, fig.height = 5, fig.cap = glue('Mapping of number of Covid-19 cases as of {format(max(df_ecdc$date, na.rm = TRUE), "%d %B %Y")}')}

map_world_cases_count <- plot_map_world_count(tbl_cases_count, 'cases')

map_world_cases_count + labs(title = NULL)

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_cases_count', '_', week_report, '.png')), 
       plot = map_world_cases_count, 
       scale = 1, 
       dpi = 320)

```


<!-- TABLE - Trends in number of cases -->
```{r TblCasesTrends, include = FALSE}

# This table display trends estimated with 4 different models
# It is not meant to appreciated differences among models
# It is not meant to be distributed

coeff_vars <-  c("coeff", "lwr", "upr")

tbl_cases_trends <- tbl_cases_count %>% 
  select(-brks) %>% 
  left_join(rename(model_cnt_cases_linear[[3]] , all_of(attach_prefix(coeff_vars, 'l_cnt_')))) %>% 
  left_join(rename(model_cml_cases_linear[[3]] , all_of(attach_prefix(coeff_vars, 'l_cml_')))) %>% 
  left_join(rename(model_cnt_cases_quasipoisson[[3]], all_of(attach_prefix(coeff_vars, 'p_cnt_')))) %>% 
  left_join(rename(model_cml_cases_quasipoisson[[3]], all_of(attach_prefix(coeff_vars, 'p_cml_')))) %>% 
  mutate(
    trend_linear = case_when(
      l_cnt_lwr > 0 ~ "Increasing", 
      l_cnt_upr < 0 ~ "Declining", 
      l_cnt_upr > 0 & l_cnt_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')),
    trend_quasipoisson = case_when(
      p_cnt_lwr > 0 ~ "Increasing", 
      p_cnt_upr < 0 ~ "Declining", 
      p_cnt_upr > 0 & p_cnt_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')))

write.csv(tbl_cases_trends, 
          file.path(path.local.worldwide.tables, paste0('tbl_cases_trends', '_', week_report, '.csv')), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- csv for MSF GIS -->
```{r}
tbl_cases_trends %>% 
  select(iso_a3, all_of(vars_trends(model_for_trends))) %>% 
  select(iso = iso_a3, trend) %>% 
  write.csv(file.path(path.local.worldwide.tables, paste0('epi-case-trends-', week_report, '.csv')), 
            row.names = FALSE, 
            fileEncoding = "UTF-8")

```

<!-- TABLE - Countries with increasing trend in number of cases -->
```{r list_increasing_trends, include = FALSE}

tbl_cases_increasing_trend <- tbl_cases_trends %>% 
  select(c(iso_a3 : cases), all_of(vars_trends(model_for_trends))) %>% 
  filter(trend == 'Increasing') %>% 
  arrange(continent, desc(coeff))

```


**Worldwide, a total of `r length(call_countries_increasing('cases'))` countries reported an increasing trend in cases** (Figure \@ref(fig:MapWorldCasesTrends)):

**Africa:** `r glue("({length(call_countries_increasing('cases', 'Africa'))}) {call_countries_increasing('cases', 'Africa') %>% combine_words()}")`. 

**Asia:** `r glue("({length(call_countries_increasing('cases', 'Asia'))}) {call_countries_increasing('cases', 'Asia') %>% combine_words()}")`. 

**Americas:** `r glue("({length(call_countries_increasing('cases', 'Americas'))}) {call_countries_increasing('cases', 'Americas') %>% combine_words()}")`. 

**Europe:** `r glue("({length(call_countries_increasing('cases', 'Europe'))}) {call_countries_increasing('cases', 'Europe') %>% combine_words()}")`. 

**Oceania:** `r glue("({length(call_countries_increasing('cases', 'Oceania'))}) {call_countries_increasing('cases', 'Oceania') %>% combine_words()}")`. 


<!-- Map cases trends -->
```{r MapWorldCasesTrends, fig.cap = glue('Mapping of cases trends estimated during the period from {format(date_max_report - (period_trends - 1), "%d %B %Y")} to {format(date_max_report, "%d %B %Y")} ({period_trends} days)')}

map_world_cases_trends <- plot_map_world_trend(tbl_cases_trends, 'cases')

map_world_cases_trends + labs(title = NULL)

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_cases_trends', '_', week_report, '.png')), 
       plot = map_world_cases_trends, 
       scale = 1, 
       dpi = 320)

```

<!-- Table cases trends -->
```{r TblCountriesCasesIncreasing}

tbl_countries_increasing_cases <- tbl_cases_trends %>% 
  select(c(iso_a3 : cases), all_of(vars_trends(model_for_trends))) %>% 
  left_join(tbl_cases_count_30d %>% select(iso_a3, cases_30d = cases), by = 'iso_a3') %>% 
  left_join(tbl_cases_count_12d %>% select(iso_a3, cases_12d = cases), by = 'iso_a3') %>% 
  filter(trend == 'Increasing') %>% 
  select(-c(iso_a3, region)) %>% 
  arrange(continent, desc(coeff)) %>% 
  mutate(
    coeff = round(exp(coeff), digits = 2), 
    coeff_ci = combine_ci(exp(lwr), exp(upr), digits = 2), 
    lwr = NULL,
    upr = NULL, 
    trend = NULL)

gtbl_countries_increasing_cases <- tbl_countries_increasing_cases %>% 
  gt(rowname_col = 'country', groupname_col = 'continent') %>% 
  cols_label(
    cases     = 'Total', 
    cases_30d = 'Last 30 days', 
    cases_12d = 'Last 12 days',  
    coeff     = 'Rate', 
    coeff_ci  = '95% CI') %>% 
  tab_spanner(
    label = 'Number of cases', 
    columns = starts_with('cases')) %>% 
  tab_spanner(
    label = 'Trend (12 days)', 
    columns = starts_with('coeff')) %>% 
  fmt_number(
    columns = vars(coeff), 
    decimals = 2) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(1),
    data_row.padding = px(1), 
    table_body.border.top.width = px(1))

gtbl_countries_increasing_cases %>% 
  tab_header(
    title = 'Countries with a significant increasing trend in cases in the last 12 days')

```


# Counts and trends of Covid-19 associated deaths

**Countries with more than 10k deaths** (in decreasing order): `r tbl_deaths_count %>% call_countries_with(10000, Inf, 'deaths') %>% combine_words()`.

**Countries with more than 100k deaths** (in decreasing order): `r tbl_deaths_count %>% call_countries_with(100000, Inf, 'deaths') %>% combine_words()` (Figure \@ref(fig:MapWorldDeathsCount)).

**African countries with less than 50 deaths** (in decreasing order): `r tbl_deaths_count %>% filter(continent == 'Africa') %>% call_countries_with(1, 49, 'deaths') %>% combine_words()`.


<!-- Map deaths count -->
```{r MapWorldDeathsCount, fig.cap = glue('Mapping of number of Covid-19 associated deaths as of {format(date_max_report, "%d %b %Y")}')}

map_world_deaths_count <- plot_map_world_count(tbl_deaths_count, 'deaths')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_deaths_count', '_', week_report, '.png')), 
       plot = map_world_deaths_count, 
       scale = 1, 
       dpi = 320)


map_world_deaths_count + labs(title = NULL)


```


<!-- TABLE - Trend in number of deaths -->
```{r}

# This table display trends estimated with 4 different models
# It is not meant to appreciated differences among models
# It is not meant to be distributed

tbl_deaths_trends <- tbl_deaths_count %>% 
  select(-brks) %>% 
  left_join(rename(model_cnt_deaths_linear[[3]] , all_of(attach_prefix(coeff_vars, 'l_cnt_')))) %>% 
  left_join(rename(model_cml_deaths_linear[[3]] , all_of(attach_prefix(coeff_vars, 'l_cml_')))) %>% 
  left_join(rename(model_cnt_deaths_quasipoisson[[3]], all_of(attach_prefix(coeff_vars, 'p_cnt_')))) %>% 
  left_join(rename(model_cml_deaths_quasipoisson[[3]], all_of(attach_prefix(coeff_vars, 'p_cml_')))) %>% 
  mutate(
    trend_linear = case_when(
      l_cnt_lwr > 0 ~ "Increasing", 
      l_cnt_upr < 0 ~ "Declining", 
      l_cnt_upr > 0 & l_cnt_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')),
    trend_quasipoisson = case_when(
      p_cnt_lwr > 0 ~ "Increasing", 
      p_cnt_upr < 0 ~ "Declining", 
      p_cnt_upr > 0 & p_cnt_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')))

write.csv(tbl_deaths_trends, 
          file.path(path.local.worldwide.tables, glue("tbl_deaths_trends_{week_report}.csv")), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- TABLE - Countries with increasing trend in number of deaths -->
```{r tbl_deaths_increasing_trend}

tbl_deaths_increasing_trend <- tbl_deaths_trends %>% 
  select(c(iso_a3 : deaths), all_of(vars_trends(model_for_trends))) %>% 
  filter(trend == 'Increasing') %>% 
  arrange(continent, desc(coeff))

```


**Worldwide, a total of `r length(call_countries_increasing('deaths'))` countries reported an increasing trend in deaths** (Figure \@ref(fig:MapWorldDeathsTrends)):

**Africa:** `r glue("({length(call_countries_increasing('deaths', 'Africa'))}):   {call_countries_increasing('deaths', 'Africa') %>% combine_words()}")`. 

**Asia:** `r glue("({length(call_countries_increasing('deaths', 'Asia'))}):     {call_countries_increasing('deaths', 'Asia') %>% combine_words()}")`. 

**Americas:** `r glue("({length(call_countries_increasing('deaths', 'Americas'))}): {call_countries_increasing('deaths', 'Americas') %>% combine_words()}")`. 

**Europe:** `r glue("({length(call_countries_increasing('deaths', 'Europe'))}):   {call_countries_increasing('deaths', 'Europe') %>% combine_words()}")`. 

**Oceania:** `r glue("({length(call_countries_increasing('deaths', 'Oceania'))}):  {call_countries_increasing('deaths', 'Oceania') %>% combine_words()}")`. 

<!-- Map deaths trends -->
```{r MapWorldDeathsTrends, fig.cap = glue('Mapping of deaths trends estimated during the period from {format(date_max_report - (period_trends - 1), "%d %B %Y")} to {format(date_max_report, "%d %B %Y")} ({period_trends} days)')}

map_world_deaths_trends <- plot_map_world_trend(tbl_deaths_trends, 'deaths')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_deaths_trends', '_', week_report, '.png')), 
       plot = map_world_deaths_trends, 
       scale = 1, 
       dpi = 320)


map_world_deaths_trends + labs(title = NULL)

```

<!-- Table deaths trends -->
```{r TblCountriesDeathsIncreasing}

tbl_countries_increasing_deaths <- tbl_deaths_increasing_trend %>% 
  left_join(tbl_deaths_count_12d %>% select(iso_a3, deaths_12d = deaths), by = 'iso_a3') %>% 
  select(-c(iso_a3, region)) %>% 
  arrange(continent, desc(coeff)) %>% 
  mutate(
    coeff = round(exp(coeff), digits = 2), 
    coeff_ci = combine_ci(exp(lwr), exp(upr), digits = 2), 
    lwr = NULL,
    upr = NULL, 
    trend = NULL)
  
gtbl_countries_increasing_deaths <- tbl_countries_increasing_deaths %>%   
  gt(rowname_col = 'country', groupname_col = 'continent') %>% 
  cols_label(
    deaths  = 'Total', 
    deaths_12d = 'Last 12 days', 
    coeff = 'Rate', 
    coeff_ci = '95% CI') %>% 
  tab_spanner(
    label = 'Number of deaths', 
    columns = starts_with('deaths')) %>% 
  tab_spanner(
    label = 'Trend', 
    columns = starts_with('coeff')) %>% 
  fmt_number(
    columns = vars(coeff), 
    decimals = 2) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(1),
    data_row.padding = px(1), 
    table_body.border.top.width = px(1))

gtbl_countries_increasing_deaths %>% 
  tab_header(
    title = 'Countries with a significant increasing trend in deaths')

```

<!-- BIG SUMMARY TABLE -->
```{r TblSummaryCasesAndDeaths, include = FALSE}

tbl_summary_cases_deaths <- df_countries %>% 
  left_join(tbl_cases_count %>% select(iso_a3, cases)) %>% 
  left_join(tbl_deaths_count %>% select(iso_a3, deaths)) %>% 
  left_join(tbl_cases_trends %>% 
              select(iso_a3, all_of(vars_trends(model_for_trends)))) %>% 
  mutate(
    trend_cases_coeff = round(exp(coeff), digits = 2), 
    trend_cases_ci = case_when(
      is.na(coeff) ~ NA_character_, 
      TRUE ~ combine_ci(exp(lwr), exp(upr), digits = 2))) %>% 
  select(-one_of('coeff','lwr', 'upr', 'trend')) %>% 
  left_join(tbl_deaths_trends %>% 
              select(iso_a3, all_of(vars_trends(model_for_trends)))) %>% 
  mutate(
    trend_deaths_coeff = round(exp(coeff), digits = 2), 
    trend_deaths_ci = case_when(
      is.na(coeff) ~ NA_character_, 
      TRUE ~ combine_ci(exp(lwr), exp(upr)))) %>% 
  select(-one_of('coeff','lwr', 'upr', 'trend')) %>% 
  mutate(
    cfr = round(deaths / cases * 100, digits = 1)) %>% 
  left_join(df_pop_country %>% select(iso_a3, pop)) %>% 
  mutate(
    cases_ar  = cases  / pop * 100000, 
    deaths_ar = deaths / pop * 100000) %>% 
  select(iso_a3, continent, region, country, 
         cases, deaths, cfr, 
         cases_ar, deaths_ar, 
         starts_with('trend_cases_'), starts_with('trend_deaths_')) %>% 
  left_join(tbl_cases_count_12d %>% select(iso_a3, cases_12d = cases)) %>% 
  left_join(tbl_deaths_count_12d %>% select(iso_a3, deaths_12d = deaths)) %>%
  group_by(continent, region) %>% 
  arrange(country, .by_group = TRUE) %>% 
  ungroup()

gtbl_summary_cases_deaths <- tbl_summary_cases_deaths %>% 
  gt(rowname_col = "country", 
  groupname_col = c('continent', 'region')) %>% 
  cols_hide(
    columns = vars(iso_a3)) %>% 
  cols_label(
    country = 'Country', 
    cases = 'Cases', 
    deaths = 'Deaths', 
    cfr = 'naïve CFR',
    cases_ar = 'cases',
    deaths_ar ='deaths', 
    cases_12d = 'Cases', 
    deaths_12d = 'Deaths', 
    trend_cases_coeff  = 'Rate', 
    trend_cases_ci     = "[95% CI]", 
    trend_deaths_coeff = 'Rate', 
    trend_deaths_ci    = "[95% CI]") %>% 
  cols_move(
    columns = vars(cases_12d), 
    after = vars(deaths_ar)) %>% 
  fmt_number(
    columns = vars(cases, deaths, cases_12d), 
    decimals = 0) %>% 
  fmt_number(
    columns = vars(cases_ar, deaths_ar), 
    decimals = 2) %>% 
  fmt_missing(
    columns = vars(trend_cases_ci, trend_deaths_ci), 
    missing_text = "---") %>% 
  tab_spanner(
    label = "Totals", 
    columns = vars(cases, deaths)) %>% 
  tab_spanner(
    label = html("Coumulative incidence<br>per 100,000 people"), 
    columns = ends_with('_ar')) %>% 
  tab_spanner(
    label = 'In the last 12 days', 
    columns = ends_with('_12d')) %>% 
  tab_spanner(
    label = "Trends of cases", 
    columns = starts_with('trend_cases_')) %>% 
  tab_spanner(
    label = "Trends of deaths", 
    columns = starts_with('trend_deaths_')) %>% 
  summary_rows(
    groups = TRUE, 
    columns = vars(cases, deaths, cases_12d, deaths_12d), 
    fns = list('Region total' = ~sum(., na.rm = TRUE)),
    decimals = 0) %>% 
  grand_summary_rows(
    columns = vars(cases, deaths, cases_12d, deaths_12d), 
    fns = list('Grand total' = ~sum(., na.rm = TRUE)), 
    decimals = 0) %>% 
  tab_header(title = glue('Worldwide Covid-19 cases and associated deaths, and trends as of {format(date_max_report, "%d %b %Y")}'),
             subtitle = html('<strong>Trends are estimate using data of the previous 12 days</strong><br>
                             Analysis carried out by Epicentre<br>
                             For information on the analysis methods click
<a href="https://msfintl-my.sharepoint.com/:u:/g/personal/francesco_grandesso_epicentre_msf_org/EZqExKcP8axMj06voaLlveABpiicCfzkk5OWB-EaJvo9Fw?e=lwU1eM">here</a><br><br>
                             <strong>NOTE to interprete the trends</strong><br>
                             A trend with rate greater than 1 indicates an increaasing trend<br>
                             A trend with rate of less than 1 indicates a declining trend')) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(1),
    data_row.padding = px(1), 
    table_body.border.top.width = px(1))

gtbl_summary_cases_deaths

gtsave(gtbl_summary_cases_deaths, 
       file.path(path.local.worldwide.tables, glue("gtbl_summary_cases_deaths_{week_report}.html")), 
       inline_css = TRUE) %>% 
  invisible()

if (Sys.info()[['effective_user']] == 'F-GRANDESSO') {
  gtsave(gtbl_summary_cases_deaths, 
       file.path("D:/OneDrive - MSF/covid-19/public/world_summary_tables", paste0( week_report, '_world_summary_cases_deaths', '.html')), 
       inline_css = TRUE) %>% 
  invisible()
}

```


# Cumulative incidences

<!-- Map of cumulative incidences -->
```{r TblCumulativeIncidences}

# Specific breaks for incidence
breaks_ar <- c(0, 10, 100, 1000, 10000, Inf)
labels_ar <- label_breaks(breaks_ar, big_numbers = TRUE) %>% gsub("\\<0-1\\>", "0", .)

tbl_attack_rates <- tbl_summary_cases_deaths %>% 
  select(iso_a3 : country, cases, deaths, cases_ar, deaths_ar) %>% 
  mutate(
    cases_brks  = cut(cases_ar, breaks_ar, labels = labels_ar, include.lowest = TRUE, right = FALSE), 
    deaths_brks = cut(deaths_ar, breaks_ar, labels = labels_ar, include.lowest = TRUE, right = FALSE)
  )

```


The cumulative number of cases are mapped in Figure \@ref(fig:MapWorldCasesCumulativeIncidence). The cumulative number of deaths are mapped in Figure \@ref(fig:MapWorldDeathsCumulativeIncidence). 

### Cumulative incidences of cases
<!-- Map of cumulative incidences of cases -->
```{r MapWorldCasesCumulativeIncidence, fig.cap = paste0('Cumulative incidence of Covid-19 reported cases since beginning of epidemic per 100,000 population, data until ', format(date_max_report, "%d %B %Y"))}

sf_attack_rates <- tbl_attack_rates %>% 
  inner_join(
    select(sf_world, iso_a3),
    by = "iso_a3"
  ) %>% 
  st_as_sf()

map_world_cases_attack_rates <- ggplot(sf_attack_rates) + 
  geom_sf(aes(fill = cases_brks), size = .1) + 
  scale_fill_brewer(
    name = "Cumulative incidence of cases / 100,000 population", palette = "Blues", 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels_ar), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "bottom")

map_world_cases_attack_rates 

ggsave(file.path(path.local.worldwide.graphs, glue("map_world_cases_attack_rates_{week_report}.png")), 
       plot = map_world_cases_attack_rates + labs(title = NULL), 
       width = 10 * cm_to_in, 
       height = 6.66 * cm_to_in, 
       scale = 1.3, 
       dpi = 320)

```


### Cumulative incidences of Covid associated deaths

<!-- Map of cumulative incidences of deaths -->
```{r MapWorldDeathsCumulativeIncidence, fig.cap = glue('Cumulative incidence of Covid-19 associated since beginning of epidemic, per 100,000 population, data until {format(date_max_report, "%d %B %Y")}')}

map_world_deaths_attack_rates <- ggplot(sf_attack_rates) + 
  geom_sf(aes(fill = deaths_brks), size = .1) + 
  scale_fill_brewer(
    name = "Cumulative incidence of deaths / 100,000 population", palette = "Reds", 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels_ar), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "bottom")

map_world_deaths_attack_rates 

ggsave(file.path(path.local.worldwide.graphs, glue("map_world_deaths_attack_rates_{week_report}.png")), 
       plot = map_world_deaths_attack_rates + labs(title = NULL), 
       width = 10 * cm_to_in, 
       height = 6.66 * cm_to_in, 
       scale = 1.3, 
       dpi = 320)

```


### Cumulative incidences versus incidences

<!-- Dots plot cumulative incidences versus incidences -->
```{r CumulativeIncidencesVersusIncidences,include = FALSE, fig.width = 9, fig.height = 8}
# New graph as requested by Fran
# to see how to display

tbl_inc_cml <- df_ecdc %>% 
  select(-c(deaths, population_2019, source)) %>% 
  group_by(iso_a3, country, continent, region) %>% 
  arrange(date) %>% 
  filter(between(date, left = date_max_report-29, right = date_max_report)) %>% 
  summarise(
    cml_count = max(cumsum(cases), na.rm = TRUE)) %>% 
  left_join(df_pop_country %>% select(iso_a3, pop)) %>% 
  mutate(
    cml_inc = cml_count / pop * 100000)


dotsgplot_inc <- function(tbl_inc = tbl_inc_cml, name_continent){

  temp_tbl <- tbl_inc %>% filter(continent == name_continent, cml_count != 0)
  countries_zero_count <- tbl_inc %>% filter(continent == name_continent, cml_count == 0) %>% pull(country)
  
  txt_countries_zero_count <- ifelse(length(countries_zero_count) == 0, 'none', combine_words(countries_zero_count))
  
  # The dots plot
  dotsgplot <- ggplot(temp_tbl) + 
    geom_point(aes(cml_count, cml_inc, col = region)) + 
    ggrepel::geom_text_repel(
      data = temp_tbl,
      aes(cml_count, cml_inc, label = country, colour = region),
      size = 3,
      show.legend = FALSE) + 
    scale_y_continuous(trans = 'log10', 
                       breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                       labels = scales::label_number_si()) + 
    scale_x_continuous(trans = 'log10', 
                       breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                       labels = scales::label_number_si()) + 
    labs(
      subtitle = name_continent, 
      caption = paste0("Countries with zero count: ",txt_countries_zero_count, ".\n", caption_world_map), 
      y = "Cumulative incidence of cases in the last 30 days per 100,000 population",
      x = "Cumulative number of cases in the last 30 days",
      color = NULL) + 
    theme_light()
    
  return(dotsgplot)
}


dotsgplot_inc_Africa <- dotsgplot_inc(name_continent = 'Africa')

ggsave(file.path(path.local.worldwide.graphs, paste0('dotsgplot_inc_Africa', '_', week_report, '.png')), 
         plot = dotsgplot_inc_Africa + labs(title = NULL), 
         width = 20 * cm_to_in, 
         height = 20 * cm_to_in, 
         scale = 1.3, 
         dpi = 320)


dotsgplot_inc_Asia <- dotsgplot_inc(name_continent = 'Asia')

ggsave(file.path(path.local.worldwide.graphs, paste0('dotsgplot_inc_Africa', '_', week_report, '.png')), 
         plot = dotsgplot_inc_Africa + labs(title = NULL), 
         width = 20 * cm_to_in, 
         height = 20 * cm_to_in, 
         scale = 1.1, 
         dpi = 320)


dotsgplot_inc_Americas <- dotsgplot_inc(name_continent = 'Americas')

ggsave(file.path(path.local.worldwide.graphs, paste0('dotsgplot_inc_Americas', '_', week_report, '.png')), 
         plot = dotsgplot_inc_Americas + labs(title = NULL), 
         width = 20 * cm_to_in, 
         height = 20 * cm_to_in, 
         scale = 1.1, 
         dpi = 320)


dotsgplot_inc_Europe <- dotsgplot_inc(name_continent = 'Europe')

ggsave(file.path(path.local.worldwide.graphs, paste0('dotsgplot_inc_Europe', '_', week_report, '.png')), 
         plot = dotsgplot_inc_Europe + labs(title = NULL), 
         width = 20 * cm_to_in, 
         height = 20 * cm_to_in, 
         scale = 1.1, 
         dpi = 320)


dotsgplot_inc_Oceania  <- dotsgplot_inc(name_continent = 'Oceania')

ggsave(file.path(path.local.worldwide.graphs, paste0('dotsgplot_inc_Oceania', '_', week_report, '.png')), 
         plot = dotsgplot_inc_Oceania + labs(title = NULL), 
         width = 20 * cm_to_in, 
         height = 20 * cm_to_in, 
         scale = 1.1, 
         dpi = 320)

```


# Doubling times

<!-- Doubling in cases -->
```{r estimate_doubling_cases}

doubling_vars <-  c("est", "lwr", "upr")

tbl_cases_doubling_time <- tbl_cases_count %>% 
  select(-brks) %>% 
  left_join(rename(model_cnt_cases_linear[['doubling_time']] , all_of(attach_prefix(doubling_vars, 'l_cnt_')))) %>% 
  left_join(rename(model_cml_cases_linear[['doubling_time']] , all_of(attach_prefix(doubling_vars, 'l_cml_')))) %>% 
  left_join(rename(model_cnt_cases_quasipoisson[['doubling_time']], all_of(attach_prefix(doubling_vars, 'p_cnt_')))) %>% 
  left_join(rename(model_cml_cases_quasipoisson[['doubling_time']], all_of(attach_prefix(doubling_vars, 'p_cml_'))))

write.csv(tbl_cases_doubling_time,
          file.path(path.local.worldwide.tables, paste0('tbl_cases_doubling_time', '_', week_report, '.csv')), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- Countries with doubling time in cases -->
```{r}

tbl_countries_doubling_time_cases <- tbl_cases_doubling_time %>% 
  select(iso_a3 : cases, vars_doubling_time(model_for_doubling, 'cases')) %>% 
  right_join(tbl_cases_increasing_trend %>% 
               select(iso_a3)) %>% 
  filter(between(cases_est, 0, threshold_doubling_time))

```

<!-- Doubling in deaths -->
```{r estimate_doubling_deaths}

tbl_deaths_doubling_time <- tbl_deaths_count %>% 
  select(iso_a3, continent, region, country, deaths) %>% 
  left_join(rename(model_cnt_deaths_linear[['doubling_time']] , all_of(attach_prefix(doubling_vars, 'l_cnt_')))) %>% 
  left_join(rename(model_cml_deaths_linear[['doubling_time']] , all_of(attach_prefix(doubling_vars, 'l_cml_')))) %>% 
  left_join(rename(model_cnt_deaths_quasipoisson[['doubling_time']], all_of(attach_prefix(doubling_vars, 'p_cnt_')))) %>% 
  left_join(rename(model_cml_deaths_quasipoisson[['doubling_time']], all_of(attach_prefix(doubling_vars, 'p_cml_'))))

write.csv(tbl_deaths_doubling_time, 
          file.path(path.local.worldwide.tables, paste0('tbl_deaths_doubling_time', '_', week_report, '.csv')), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- Countries with doubling time in deaths -->
```{r}
# Categorise the doubling time
tbl_countries_doubling_time_deaths <- tbl_deaths_doubling_time %>% 
  select(iso_a3 : deaths, vars_doubling_time(model_for_doubling, 'deaths')) %>% 
  right_join(tbl_deaths_increasing_trend %>% 
               select(iso_a3)) %>% 
  filter(between(deaths_est, 0, threshold_doubling_time))

```

<!-- Combine countries with doubling time in cases and in deaths -->
```{r tbl_rank_doubling}

tbl_doubling <- tbl_cases_doubling_time %>% 
  filter(!is.na(country)) %>% 
  select(c(iso_a3 : cases), vars_doubling_time(model_for_doubling, 'cases')) %>% 
  mutate(
    cases_ci95 = case_when(
      !is.na(cases_est) ~ combine_ci(cases_lwr, cases_upr), 
      TRUE ~ NA_character_),
    cases_est = round(cases_est, digits = 1), 
    cases_lwr = NULL, 
    cases_upr = NULL) %>% 
  left_join(tbl_deaths_doubling_time %>% 
  filter(!is.na(country)) %>% 
  select(c(iso_a3, deaths), vars_doubling_time(model_for_doubling, 'deaths')) %>% 
  mutate(
    deaths_ci95 = case_when(
      !is.na(deaths_est) ~ combine_ci(deaths_lwr, deaths_upr), 
      TRUE ~ NA_character_),
    deaths_est = round(deaths_est, digits = 1), 
    deaths_lwr = NULL, 
    deaths_upr = NULL)) %>% 
  right_join(full_join(tbl_cases_increasing_trend %>% 
                         select(iso_a3, trend_cases = trend), 
                       tbl_deaths_increasing_trend %>% 
                         select(iso_a3, trend_deaths = trend)))

tbl_cfr_doubling <- tbl_doubling %>%
  mutate(
    cfr = round(deaths / cases * 100, digits = 1)) %>% 
  select(c(iso_a3 : country), cases, deaths, cfr, cases_est, cases_ci95, deaths_est, deaths_ci95) 


tbl_cfr_doubling_rank <- tbl_cfr_doubling %>% 
  filter(between(cases_est, left = 0, right = threshold_doubling_time) | 
           between(deaths_est, left = 0, right = threshold_doubling_time)) %>% 
  arrange(cases_est)

```


### Countries with doubling time in cases less than `r (threshold_doubling_time)` days

A sharp increasing of cases (doubling time of less than `r threshold_doubling_time` days) (Figure \@ref(fig:MapWorldCasesDoubling)) is observed in: 

**Africa:** `r glue("({length(call_countries_doubling('cases_est', 'Africa'))}) {call_countries_doubling('cases_est', 'Africa') %>% combine_words()}")`. 

**Asia:** `r glue("({length(call_countries_doubling('cases_est', 'Asia'))}) {call_countries_doubling('cases_est', 'Asia') %>% combine_words()}")`. 

**Americas:** `r glue("({length(call_countries_doubling('cases_est', 'Americas'))}) {call_countries_doubling('cases_est', 'Americas') %>% combine_words()}")`. 

**Europe:** `r glue("({length(call_countries_doubling('cases_est', 'Europe'))}) {call_countries_doubling('cases_est', 'Europe') %>% combine_words()}")`. 

**Oceania:** `r glue("({length(call_countries_doubling('cases_est', 'Oceania'))}) {call_countries_doubling('cases_est', 'Oceania') %>% combine_words()}")`. 


<!-- Map doubling cases -->
```{r MapWorldCasesDoubling, fig.cap = glue('Doubling time of the number of Covid-19 cases estimated in the last 12 days (only countries with increasing trends are displayed)')}

breaks <- c(0, 4, 8, 12, Inf)
labels <- label_breaks(breaks)

# Categorise the doubling time
df_doubling_cases <- tbl_cases_doubling_time %>% 
  select(c(iso_a3:cases), doubling_time = 'l_cml_est') %>% 
  left_join(tbl_cases_trends %>% 
              select(iso_a3, trend = trend_linear), 
            by = 'iso_a3') %>% 
  mutate(
    doubling_time = case_when(
      (trend != 'Increasing' | is.na(trend)) ~ NA_real_,
      TRUE ~ doubling_time), 
    brks = cut(doubling_time, breaks, labels = labels, include.lowest = TRUE)) %>% 
  select(c(iso_a3:cases), trend, doubling_time, brks)


# Join the dataframe with the sf
sf_doubling_cases <- df_doubling_cases %>% 
  inner_join(
    select(sf_world, iso_a3),
    by = "iso_a3"
  ) %>% 
  st_as_sf()

# plot the map
RdYl <- c('#993404','#D95F0E','#FE9929','#FED98E','#FFFFD4')

map_world_doubling_cases <- ggplot(sf_doubling_cases) + 
  geom_sf(aes(fill = brks), size = .1) + 
  scale_fill_manual(
    name = "Doubling time (days)", 
    values = RdYl, 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(title = 'Cases doubling time', caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom")

map_world_doubling_cases + labs(title = NULL) 

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_doubling_cases', '_', week_report, '.png')), 
       plot = map_world_doubling_cases, 
       scale = 1, 
       dpi = 320)

```


### Countries with doubling time in deaths less than `r (threshold_doubling_time)` days

A sharp increasing of deaths (doubling time of less than `r threshold_doubling_time` days) (Figure \@ref(fig:MapWorldDeathsDoubling)) is observed in: 

**Africa:** `r glue("({length(call_countries_doubling('deaths_est', 'Africa'))}) {call_countries_doubling('deaths_est', 'Africa') %>% combine_words()}")`. 

**Asia:** `r glue("({length(call_countries_doubling('deaths_est', 'Asia'))}) {call_countries_doubling('deaths_est', 'Asia') %>% combine_words()}")`. 

**Americas:** `r glue("({length(call_countries_doubling('deaths_est', 'Americas'))}) {call_countries_doubling('deaths_est', 'Americas') %>% combine_words()}")`. 

**Europe:** `r glue("({length(call_countries_doubling('deaths_est', 'Europe'))}) {call_countries_doubling('deaths_est', 'Europe') %>% combine_words()}")`. 

**Oceania:** `r glue("({length(call_countries_doubling('deaths_est', 'Oceania'))}) {call_countries_doubling('deaths_est', 'Oceania') %>% combine_words()}")`. 

<!-- Map doubling deaths -->
```{r MapWorldDeathsDoubling, fig.cap = paste0("Doubling time of the number of Covid-19 associated deaths estimated in the last ", threshold_doubling_time, " (only countries with increasing trends are displayed)")}

# Categorise the doubling time
df_doubling_deaths <- tbl_deaths_doubling_time %>% 
  select(c(iso_a3:deaths), doubling_time = 'l_cml_est') %>% 
  left_join(tbl_deaths_trends %>% 
              select(iso_a3, trend = trend_linear), 
            by = 'iso_a3') %>% 
  mutate(
    doubling_time = case_when(
      (trend != 'Increasing' | is.na(trend)) ~ NA_real_,
      TRUE ~ doubling_time), 
    brks = cut(doubling_time, breaks, labels = labels, include.lowest = TRUE)) %>% 
  select(c(iso_a3:deaths), doubling_time, brks)

# Join the dataframe with the sf
sf_doubling_deaths <- df_doubling_deaths %>% 
  inner_join(
    select(sf_world, iso_a3),
    by = "iso_a3"
  ) %>% 
  st_as_sf()

# plot the map
map_world_doubling_deaths <- ggplot(sf_doubling_deaths) + 
  geom_sf(aes(fill = brks), size = .1) + 
  scale_fill_manual(
    name = "Doubling time (days)", 
    values = RdYl, 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(title = 'Deaths doubling time', caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom")

map_world_doubling_deaths

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_doubling_deaths', '_', week_report, '.png')), 
       plot = map_world_doubling_deaths, 
       scale = 1, 
       dpi = 320)

```


### Summary table of countries with doubling time in cases or deaths less than `r threshold_doubling_time` days

```{r}
#  The tbl_cfr_doubling_rank is made above

gtbl_cfr_doubling_rank <- tbl_cfr_doubling_rank %>% 
  arrange(cases_est) %>% 
  gt(rowname_col = 'country', groupname_col = 'continent') %>% 
  cols_hide(
    columns = vars(iso_a3, region)) %>% 
  cols_label(
    country = 'Country', 
    cases = 'Cases', 
    deaths = 'Deaths', 
    cfr = 'naïve CFR', 
    cases_est = 'days', 
    cases_ci95 = "[95% CI]", 
    deaths_est = 'days', 
    deaths_ci95 = "[95% CI]") %>% 
  fmt_number(
    columns = vars(cases, deaths), 
    decimals = 0) %>% 
  fmt_missing(
    columns = vars(cases_est, cases_ci95, deaths_est, deaths_ci95), 
    missing_text = "---") %>% 
  tab_spanner(
    label = "Totals", 
    columns = vars(cases, deaths)) %>% 
  tab_spanner(
    label = "Doubling time of cases", 
    columns = vars(cases_est, cases_ci95)) %>% 
  tab_spanner(
    label = "Doubling time of deaths", 
    columns = vars(deaths_est, deaths_ci95)) %>% 
  tab_footnote(
    footnote = "Total number of deaths reported so far, divided by the total number of cases.",
    locations = cells_column_labels(
      columns = vars(cfr))) %>%  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(2),
    data_row.padding = px(2), 
    table_body.border.top.width = px(2))

gtsave(gtbl_cfr_doubling_rank, 
       file.path(path.local.worldwide.tables, paste0('gtbl_cfr_doubling_rank', '_', week_report,'.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_cfr_doubling_rank

```


### Countries with critical doubling time of cases
<!-- Dot plot doubling time over number of days with increasing trend -->
```{r DotsHotspotCases, fig.cap = glue('Distribution of doubling time of Covid-19 cases according to length in days since the first significant increasing trend reported (only countries with doubling time of less than {threshold_doubling_time} days as of {format(date_max_report, "%d %B %Y")} are displayed)')}

# Identify the date of a significant positive trend (We might need to sue cusum at one point)
tbl_cases_date_pos_trend <- tibble(iso_a3 = as.character(), 
                                   date_lwr_pos = as.Date(NA))

for (country_iso in names(lst_coeffs_cases)) {
  dta_lwr_pos <- lst_coeffs_cases[[country_iso]] %>% 
    mutate(
      lwr_pos = lwr > 0) %>% 
    filter(lwr_pos)
  
  if (nrow(dta_lwr_pos) == 0) {
    tbl_cases_date_pos_trend <- tbl_cases_date_pos_trend %>% 
      add_row(iso_a3 = country_iso, 
              date_lwr_pos = as.Date(NA))
  } else {
    tbl_cases_date_pos_trend <- tbl_cases_date_pos_trend %>% 
      add_row(iso_a3  = country_iso, 
              date_lwr_pos = min(as.Date(dta_lwr_pos$date)))
  }
}

# Manual entry
tbl_cases_date_pos_trend <- tbl_cases_date_pos_trend %>% 
  mutate(
    date_lwr_pos = case_when(
      iso_a3 == 'COM' ~ as.Date('2020-05-19'),
      iso_a3 == 'NIC' ~ as.Date('2020-05-22'), 
      TRUE ~ date_lwr_pos
    )
  )

# The table
tbl_hot_countries <- tbl_cfr_doubling %>% 
  left_join(tbl_cases_date_pos_trend) %>% 
  mutate(
    nb_days = as.numeric(date_max_report - date_lwr_pos)
  ) %>% 
   filter(between(cases_est, 0, threshold_doubling_time))

# The dots plot
dots_hotspot_cases <- ggplot(tbl_hot_countries) + 
  geom_point(aes(nb_days, cases_est, col = continent)) + 
  ggrepel::geom_text_repel(
    data = tbl_hot_countries,
    aes(nb_days, cases_est, label = country, colour = continent),
    size = 3,
    show.legend = FALSE) + 
  ylim(0, threshold_doubling_time) + 
  labs(
    y = "Doubling time in number of cases",
    x = "Number of days since a significant increasing trend was found",
    color = NULL
  ) + 
  theme_light()

ggsave(file.path(path.local.worldwide.graphs, paste0('dots_hotspot_cases', '_', week_report, '.png')), 
       plot = dots_hotspot_cases, 
       width = 6, 
       height = 4, 
       scale = 1.1, 
       dpi = 320)


dots_hotspot_cases

```


# Number of Covid-19 diagnostic tests performed

```{r, include = FALSE}

# Table of cumulative number of tests and assess reliability
tbl_tests <- tibble(iso_a3    = character(), 
                    tests_cml = numeric(), 
                    reliable  = character())

for (i in names(lst_tests)) {
  
  tst <- lst_tests[[i]] %>% 
    filter(between(date, left = date_max_report - (period_trends - 1), right = date_max_report))
  if (sum(is.na(tst$new_tests)) == period_trends | nrow(tst) == 0) {
    tbl_tests <- tbl_tests %>% 
      add_row(iso_a3 = i, 
              tests_cml = sum(tst$new_tests, na.rm = TRUE),
              reliable = NA_character_)
  } else {
    if (sum(tst$new_tests == 0, na.rm = TRUE) > 6 | sum(is.na(tst$new_tests)) > period_trends/2) {
      tbl_tests <- tbl_tests %>% 
        add_row(iso_a3 = i, 
                tests_cml = sum(tst$new_tests, na.rm = TRUE),
                reliable = 'No')
    } else {
      tbl_tests <- tbl_tests %>% 
        add_row(iso_a3 = i, 
                tests_cml = sum(tst$new_tests, na.rm = TRUE), 
                reliable = 'Yes')
    }
  }
}

# Final table
tbl_tests_inc <- df_countries %>% 
  left_join(df_pop_country %>% select(iso_a3, pop)) %>% 
  left_join(tbl_tests) %>% 
  left_join(tbl_cases_count_12d %>% select(iso_a3, cases_12d = cases)) %>% 
  right_join(tbl_cases_increasing_trend %>% select(iso_a3, coeff)) %>% 
  mutate(
    cases_inc_12d = cases_12d / pop * 100000, 
    tests_prop    = cases_12d / tests_cml, 
    tests_ratio   = tests_cml / cases_12d, 
    tests_rate    = tests_cml / pop * 100000
  )

```

<!-- Plot test proportion -->
```{r DotsTestsProportion, fig.cap = 'Relation between the proportion of positive tests in the last 12 days and the cumulative number of cases reported'}

tbl_tests_inc_reliable <- tbl_tests_inc %>% 
  filter(reliable == 'Yes')

dots_prop_tests <- ggplot(tbl_tests_inc_reliable, aes(tests_prop, cases_inc_12d)) + 
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "red", size = 0.5) + 
  geom_point(aes(colour = continent)) + 
  ggrepel::geom_text_repel(
    aes(tests_prop, cases_inc_12d, label = country, colour = continent),
    size = 3,
    show.legend = FALSE) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_y_log10(labels = scales::label_number_si()) + 
  labs(
    y = "Cumulative number of cases per 100,000 people in the last 12 days (log scale)",
    x = glue('Proportion of Covid positive tests in the last 12 days'), 
    colour = 'Continent', 
    caption = glue('Analysis and graphic by Epicentre | Data source: FIND as of {format(date_max_report, "%d %b %Y")}')) + 
  theme_light()
  
ggsave(file.path(path.local.worldwide.graphs, paste0('dots_prop_tests', '_', week_report, '.png')), 
       plot = dots_prop_tests, 
       width = 8, 
       height = 6, 
       scale = 1, 
       dpi = 320)

dots_prop_tests
```

```{r}

# Table of missing data
tbl_tests_country_non_reliable <- tbl_tests_inc %>% 
  filter(reliable == 'No') %>% 
  arrange(country) %>% 
  pull(country)

tbl_tests_country_no_data <- tbl_tests_inc %>% 
  filter(is.na(reliable)) %>% 
  arrange(country) %>% 
  pull(country)

tbl_no_tests <- cbind_diff(list(not_reliable_data = tbl_tests_country_non_reliable, 
                                 no_data = tbl_tests_country_no_data))


gtbl_no_tests <- tbl_no_tests %>% 
  gt() %>% 
  cols_label(
   not_reliable_data = 'Not reliable data', 
   no_data = 'No data available') %>% 
  cols_align(
    align = 'left', 
    columns = vars(not_reliable_data, no_data)) %>% 
  fmt_missing(
    columns = vars(not_reliable_data, no_data), 
    missing_text = "") %>% 
  tab_style(
    style = list(
      cell_fill(color = '#C7FFFF'), 
      cell_borders(color = '#C7FFFF')), 
    locations = cells_body(
    columns = vars(not_reliable_data))) %>% 
  tab_style(
    style = list(
      cell_fill(color = '#C7FFFF')), 
    locations = cells_column_labels(
    columns = vars(not_reliable_data))) %>% 
  tab_style(
    style = list(
      cell_fill(color = '#EAC5AD'), 
      cell_borders(color = '#EAC5AD')), 
    locations = cells_body(
    columns = vars(no_data))) %>% 
  tab_style(
    style = list(
      cell_fill(color = '#EAC5AD')), 
    locations = cells_column_labels(
    columns = vars(no_data))) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(1))

gtsave(gtbl_no_tests, 
       file.path(path.local.worldwide.tables, paste0('gtbl_no_tests', '_', week_report,'.png'))) %>% 
  invisible()


gtbl_no_tests

```


<!-- Plot test ratio -->
```{r DotsTestsRatio, fig.cap = glue('Relation between the number of tests carried out in the last 12 days (as ratio of the number of confirmed cases) and the cumulative number of cases reported')}

dots_ratio_tests <- ggplot(tbl_tests_inc, aes(tests_ratio, cases_inc_12d)) + 
  geom_point(aes(tests_ratio, cases_inc_12d, colour = continent)) + 
  geom_point(data = tbl_tests_inc %>% filter(reliable == 'No'), 
             pch = 21, fill = NA, size = 4, colour = "red", stroke = 1) + 
  geom_point(data = tbl_tests_inc %>% filter(tests_cml == 0), 
             pch = 21, fill = NA, size = 4, colour = "black", stroke = 1) + 
  ggrepel::geom_text_repel(
    aes(tests_ratio, cases_inc_12d, label = country, colour = continent),
    size = 3,
    show.legend = FALSE) + 
  scale_x_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) +
  scale_y_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) + 
  labs(
    y = "Cumulative number of cases per 100,000 people (log scale)",
    x = "Ratio of the number of tests done over the number of cases confirmed (log scale)", 
    colour = 'Continent', 
    caption = 'NOTE: \nBlack circles = No data on the number of tests performed\nRed circles = Unreliable data on the number of tests performed') + 
  theme_light() + 
  theme(
    plot.caption = element_text(hjust = 0))

dots_ratio_tests

ggsave(file.path(path.local.worldwide.graphs, glue("dots_ratio_tests_{week_report}.png")), 
       plot = dots_ratio_tests, 
       width = 8, 
       height = 6, 
       scale = 1, 
       dpi = 320)
```

<!-- Plot test rate -->
```{r DotsTestsRate, fig.cap = glue('Relation between the number of tests carried out in the last 12 days (as rate of the country population) and the cumulative number of cases reported')}

dots_rate_tests <- ggplot(tbl_tests_inc, aes(tests_rate, cases_inc_12d)) + 
  geom_point(aes(tests_rate, cases_inc_12d, colour = continent)) + 
  geom_point(data = tbl_tests_inc %>% filter(reliable == 'No'), 
             pch = 21, fill = NA, size = 4, colour = "red", stroke = 1) + 
  geom_point(data = tbl_tests_inc %>% filter(tests_cml == 0), 
             pch = 21, fill = NA, size = 4, colour = "black", stroke = 1) + 
  ggrepel::geom_text_repel(
    aes(tests_rate, cases_inc_12d, label = country, colour = continent),
    size = 3, 
    show.legend = FALSE) + 
  scale_x_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) +
  scale_y_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) + 
  labs(
    y = "Cumulative number of cases per 100,000 people (log scale)",
    x = "Number of tests done per 100,000 people (log scale)", 
    colour = 'Continent', 
    caption = 'NOTE: \nBlack circles = No data on the number of tests performed\nRed circles = Unreliable data on the number of tests performed') + 
  theme_light() + 
  theme(
    plot.caption = element_text(hjust = 0))

dots_rate_tests

ggsave(file.path(path.local.worldwide.graphs, paste0('dots_rate_tests', '_', week_report, '.png')), 
       plot = dots_rate_tests, 
       width = 8, 
       height = 6, 
       scale = 1, 
       dpi = 320)

```



<!-- === === === === === === === === -->
<!-- Graphs and table for EpiSitrep  -->
<!-- === === === === === === === === -->

<!-- Table Ranking doubling time -->
```{r save_gtbl_rank_doubling, include = FALSE}
gtsave(gtbl_cfr_doubling_rank %>% 
         tab_options(
           column_labels.font.size = px(10), 
           table.font.size = px(10)),
       file.path(path.local.worldwide.tables, paste0('gtbl_cfr_doubling_rank', '_', week_report, '.png')), 
       vwidth = 720,
       vheight = 720*1.414) %>% 
  invisible()

```

<!-- Map world cases grid -->
```{r MapWorldCasesGrid, include = FALSE}

map_world_cases_grid <- grid.arrange(map_world_cases_count + labs(caption = ''), 
                                     map_world_cases_trends, 
                                     ncol = 2)
ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_cases_grid', '_', week_report, '.png')), 
       plot = map_world_cases_grid, 
       scale = 1.6, 
       width = 7, 
       height = 3)

```

<!-- Map world deaths grid -->
```{r MapWorldDeathsGrid, include = FALSE}

map_world_deaths_grid <- grid.arrange(map_world_deaths_count + labs(caption = ''), 
                                      map_world_deaths_trends, ncol = 2)
ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_deaths_grid', '_', week_report, '.png')), 
       plot = map_world_deaths_grid, 
       scale = 1.6, 
       width = 7, 
       height = 3)

```

<!-- Map world doubling time grid -->
```{r MapWorldDoublingGrid, include = FALSE}

map_world_doubling_grid <- grid.arrange(map_world_doubling_cases + labs(caption = ''), 
                                        map_world_doubling_deaths, ncol = 2)
ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_doubling_grid', '_', week_report, '.png')), 
       plot = map_world_doubling_grid, 
       scale = 1.6, 
       width = 7, 
       height = 3)

```


<!-- Save results -->
```{r save_results, include = FALSE}

rm(list = lsf.str())
save.image(file.path(path.local.worldwide.data, paste0('episitrep_worldwide_analyses', '_', week_report, '.RData')))

```
