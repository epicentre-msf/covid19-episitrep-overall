---
title: "Covid-19 worldwide overview for MSF"
author: Francesco Grandesso (Epicentre) <francesco.GRANDESSO@epicentre.msf.org>
date: "Edited: `r format(Sys.Date(), '%d %B %Y')`"
output: 
  rmdformats::readthedown:
    highlight: "tango"
    lightbox: TRUE
    gallery: TRUE
    css: styles_blues.css
    use_bookdown: TRUE
editor_options: 
  chunk_output_type: console
---


<!-- Setup and uploading functions -->
```{r setup, include = FALSE}

# Set environment
if (!exists('path.root')) {
  source(here::here('R', 'setup.r'), encoding = 'UTF-8')
}

knitr::opts_chunk$set(cache = FALSE, 
                      echo = FALSE, 
                      tidy = TRUE, 
                      collapse = TRUE, 
                      dpi = 150, 
                      fig.width = 8, 
                      fig.height = 5, 
                      fig.align = "center", 
                      warning = FALSE, 
                      message = FALSE, 
                      encoding = "UTF-8")


# Upload functions
source(file.path(path.R, "utils_get_data.R")  , encoding = "UTF-8")
source(file.path(path.R, 'utils_management.R'), encoding = 'UTF-8')
source(file.path(path.R, "utils_modelling.R") , encoding = "UTF-8")
source(file.path(path.R, 'utils_vis.R')       , encoding = 'UTF-8')


# Set the left and right censoring for date of consultation. 
# The right-censoring create also the week value and the folders where to save the outputs
dates_and_week <- set_date_frame(create_folders = TRUE)

date_min_report <- dates_and_week[[1]]
date_max_report <- dates_and_week[[2]]
week_report     <- dates_and_week[[3]]


# Default parameters for graphics
RdAmGn <- c('#D95F02', '#E6AB02', '#1B9E77') # Three-colours palette (Red-Amber-Green) colour-blind safe
caption_world_map <- paste0('Analysis and graphic by Epicentre | Data source: ECDC as of ', format(date_max_report, '%d %b %Y'))

```

---
subtitle: "Data as of week `r glue::glue("{format(date_max_report, '%V')}, ending {weekdays(date_max_report)} {format(date_max_report, '%d %B %Y')}")`"
---

<!-- Import data -->
```{r get-data, include = FALSE}

# === === === === === === === 
# ECDC data
# === === === === === === === 

# Get ECDC data either from the web or from the saved RDS file
dta_ecdc <- covidutils::get_ecdc_data() %>% 
  prepare_ecdc_data()

saveRDS(dta_ecdc, file.path(path.local.worldwide.data, 'dta_ECDC.RDS'))

# ECDC data right censored until date_max
dta_ecdc_right_censored <- dta_ecdc %>% 
  tidyr::drop_na(iso_a3) %>% 
  filter(between(date, left = NULL, right = date_max_report))

# ECDC split data in a list of countries with iso_a3 as key
lst_dta_ecdc <- dta_ecdc_right_censored %>% 
  multisplit("iso_a3")


# === === === === === === === 
# Geo and population data
# === === === === === === === 

sf_world         <- readRDS(file.path(path.local.data, paste0('sf_world','.RDS')))
df_countries     <- readRDS(file.path(path.local.data, paste0('df_countries','.RDS')))
df_pop_country   <- readRDS(file.path(path.local.data, paste0('df_pop_country','.RDS')))
df_pop_region    <- readRDS(file.path(path.local.data, paste0('df_pop_region','.RDS')))
df_pop_continent <- readRDS(file.path(path.local.data, paste0('df_pop_continent','.RDS')))



# === === === === === === === 
# TESTS dataset from FIND
# === === === === === === === 
  
rds_tests <- get_FIND_data()

dta_tests <- rds_tests[[1]]

iso_tests <- read.csv(file.path(path.local.data, 'iso-a3_for_tests.csv'), stringsAsFactors = FALSE)
  
lst_tests <- dta_tests %>% 
  select(country = name, date = time, new_tests = new_tests_orig) %>% 
  filter(date <= date_max_report) %>% 
  mutate(
    country = case_when(
      country == "N/A" ~ NA_character_,
      TRUE ~ country)
  ) %>% 
  tidyr::drop_na(country) %>% 
  full_join(iso_tests, by = 'country') %>% 
  arrange(iso_a3, date) %>% 
  multisplit("iso_a3")


# Fill possible gaps in tests time-series
for (i in names(lst_tests)) {
  
  tests_dta <- lst_tests[[i]]
  
  if (nrow(tests_dta) > 1) {
      
      tests_dta <- tests_dta %>% 
        tidyr::complete(date = seq.Date(min(date, na.rm = TRUE), 
                                        date_max_report, by = 1), 
                        fill = list(new_tests = NA_real_))
    }
    lst_tests[[i]] <- tests_dta
  }

```

```{r get-trends}

trend_models <- get_trend_models(periods_trend = c(12, 30), force = FALSE)

model_cnt_cases_linear_short <- trend_models$model_cnt_cases_linear_short
model_cnt_cases_linear_long  <- trend_models$model_cnt_cases_linear_long

model_cnt_deaths_linear_short <- trend_models$model_cnt_deaths_linear_short
model_cnt_deaths_linear_long  <- trend_models$model_cnt_deaths_linear_long

lst_coeffs_cases  <- trend_models$lst_coeffs_cases
lst_coeffs_deaths <- trend_models$lst_coeffs_deaths

period_trend <- trend_models$periods_trend[[1]]


# Choice for models to be used
model_for_trend   <- 'linear' # for trends
model_for_doubling <- 'linear' # for doubling time

threshold_doubling_time <- 12

```

<!-- Main data frames used in the analysis -->
```{r tbl-count}

# --- --- --- --- --- 
# Breaks and labels 
# --- --- --- --- --- 

breaks_cases <- c(0, 1, 50, 100, 1000, 10000, 100000, 1000000, Inf)
labels_cases <- label_breaks(breaks_cases) %>% gsub("\\<0-1\\>", "0", .)

breaks_deaths <- c(0, 1, 50, 100, 1000, 10000, 100000, Inf)
labels_deaths <- label_breaks(breaks_deaths) %>% gsub("\\<0-1\\>", "0", .)


# --- --- --- --- --- 
# Cases 
# --- --- --- --- --- 

# Summary table of total cases
tbl_case_count <- dta_ecdc_right_censored %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(cases = sum(cases, na.rm = TRUE)) %>% 
  mutate(brks = cut(cases, breaks_cases, labels = labels_cases, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of cases in the last 30 days 
tbl_case_count_30d <- dta_ecdc_right_censored %>% 
  filter(between(date, left = date_max_report-29, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(cases = sum(cases, na.rm = TRUE)) %>% 
  mutate(brks = cut(cases, breaks_cases, labels = labels_cases, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of cases in the last 12 days 
tbl_case_count_12d <- dta_ecdc_right_censored %>% 
  filter(between(date, left = date_max_report-11, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(cases = sum(cases, na.rm = TRUE)) %>% 
  mutate(brks = cut(cases, breaks_cases, labels = labels_cases, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# --- --- --- --- --- 
# Deaths
# --- --- --- --- --- 

# Summary table of total deaths
tbl_death_count <- dta_ecdc_right_censored %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  mutate(brks = cut(deaths, breaks_deaths, labels = labels_deaths, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of deaths in the last 30 days 
tbl_death_count_30d <- dta_ecdc_right_censored %>% 
  filter(between(date, left = date_max_report-29, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  mutate(brks = cut(deaths, breaks_deaths, labels = labels_deaths, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()

# Summary table of deaths in the last 12 days 
tbl_death_count_12d <- dta_ecdc_right_censored %>% 
  filter(between(date, left = date_max_report-11, right = date_max_report)) %>% 
  group_by(iso_a3, continent, region, country) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  mutate(brks = cut(deaths, breaks_deaths, labels = labels_deaths, include.lowest = TRUE, right = FALSE)) %>% 
  ungroup()


n_cases_12d <- tbl_case_count_12d %>% select(cases) %>% sum()
n_deaths_12d <- tbl_death_count_12d %>% select(deaths) %>% sum()

```



<!-- THE REPORT STARTS HERE -->


# About this report

This document presents maps, tables and graphs to provide an overview the current Covid-19 pandemic from the MSF perspective (not much text). Most, but not all, of these analyses are presented and commented in the MSF Intersection Covid-19 EpiSitrep edited by Epicentre (for information on the EpiSitrep, please contact Anais.BROBAN@epicentre.msf.org). 
  
The R scripts are available at the following Github repository https://github.com/epicentre-msf/covid19-episitrep-overall for epidemiologists in MSF to use (R skills required). The scripts are updated from week to week as analysis progresses as requested. 

This document uses the following data sources: 

  - [ECDC data](https://opendata.ecdc.europa.eu/covid19/casedistribution/csv) last updated `r format(max(dta_ecdc$date, na.rm = TRUE), "%d %b %Y")`.   
  -	FIND [SARS-COV-2 Test Tracker](https://www.finddx.org/covid-19/test-tracker/) for data on Covid-19 tests

Definitions of increasing, declining and stable trends and the definition of doubling time, as well as detailed information on the analysis methods, can be found [here](https://reports.msf.net/secure/app_direct/covid19-additional-analysis/analysis_methods_2020-08-20.html).

Additional graphics and tables are also available at the [Epicentre COVID-19 Epi Dashboard](https://reports.msf.net/public/covid19/).

Reports of previous weeks are available [here](https://reports.msf.net/secure/app_direct/covid19-additional-analysis/addtional_episitrep_outputs_worldwide/archive/).

**IMPORTANT NOTE:** Data and results presented here are possibly affected by bias related with factors such as the testing strategies used by each country and the performance of their surveillance systems. Results are to be interpreted in the light of this information.


# Covid-19 cases and trends

## Cases counts 

**`r Words(length(tbl_case_count %>% call_countries_with(100000, Inf, 'cases')))` countries with more than 100k cases**`r glue(" (in decreasing order): {tbl_case_count %>% call_countries_with(100000, Inf, 'cases') %>% combine_words()}")` (Figure \@ref(fig:map-world-cases-count)). 

**`r Words(length(tbl_case_count %>% call_countries_with(1000000, Inf, 'cases')))` countries with more than 1M cases**`r glue(" (in decreasing order): {tbl_case_count %>% call_countries_with(1000000, Inf, 'cases') %>% combine_words()}")`. 

**`r Words(length(tbl_case_count %>% filter(continent =='Africa') %>% call_countries_with(10000, Inf, 'cases')))` African countries with more than 10k cases**`r glue(" (in decreasing order): {tbl_case_count %>% filter(continent =='Africa') %>% call_countries_with(10000, Inf, 'cases') %>% combine_words()}")`. 

**`r Words(length(tbl_case_count %>% filter(continent =='Africa') %>% call_countries_with(1000, 9999, 'cases')))` African countries with more than 1000 cases**`r glue(" (in decreasing order): {tbl_case_count %>% filter(continent =='Africa') %>% call_countries_with(1000, 9999, 'cases') %>% combine_words()}")`. 


**`r Words(length(tbl_case_count %>% filter(continent == 'Africa') %>% call_countries_with(1, 49, 'cases')))` African countries with less than 50 cases**`r glue(" (in decreasing order): {tbl_case_count %>% filter(continent == 'Africa') %>% call_countries_with(1, 49, 'cases') %>% combine_words()}")`. 


<!-- Map World cases -->
```{r map-world-cases-count, fig.cap = glue('Mapping of number of Covid-19 cases as of {format(max(dta_ecdc$date, na.rm = TRUE), "%d %B %Y")}')}

map_world_case_count <- plot_map_world_count(tbl_case_count, 'cases')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_case_count', '_', week_report, '.png')), 
       plot = map_world_case_count, 
       scale = 1, 
       dpi = 320)


map_world_case_count + labs(title = NULL)

```


## Case trends

<!-- TABLE - Trends in number of cases -->
```{r tbl-case-trend, include = FALSE}

coeff_vars <-  c("coeff", "lwr", "upr")

tbl_case_trend_30d <- tbl_case_count_30d %>% 
  select(-brks) %>% 
  left_join(rename(model_cnt_cases_linear_long[[3]] , all_of(attach_prefix(coeff_vars, 'l_cnt_30d_')))) %>% 
  mutate(
    trend_linear_30d = case_when(
      l_cnt_30d_lwr > 0 ~ "Increasing", 
      l_cnt_30d_upr < 0 ~ "Declining", 
      l_cnt_30d_upr > 0 & l_cnt_30d_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')))


tbl_case_trend <- tbl_case_count %>% 
  select(-brks) %>% 
  left_join(rename(model_cnt_cases_linear_short[[3]] , all_of(attach_prefix(coeff_vars, 'l_cnt_')))) %>% 
  mutate(
    trend_linear = case_when(
      l_cnt_lwr > 0 ~ "Increasing", 
      l_cnt_upr < 0 ~ "Declining", 
      l_cnt_upr > 0 & l_cnt_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')))

write.csv(tbl_case_trend, 
          file.path(path.local.worldwide.tables, paste0('tbl_case_trend', '_', week_report, '.csv')), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- csv for MSF GIS -->
```{r csv-for-MSF-GIS, include = FALSE}
tbl_case_trend %>% 
  select(iso_a3, all_of(vars_trends(model_for_trend))) %>% 
  select(iso = iso_a3, trend) %>% 
  write.csv(file.path(path.local.worldwide.tables, paste0('epi-case-trends-', week_report, '.csv')), 
            row.names = FALSE, 
            fileEncoding = "UTF-8")

```

<!-- TABLE - Countries with increasing trend in number of cases -->
```{r list-increasing-trends, include = FALSE}

tbl_case_increasing_trend <- tbl_case_trend %>% 
  select(c(iso_a3 : cases), all_of(vars_trends(model_for_trend))) %>% 
  filter(trend == 'Increasing') %>% 
  arrange(continent, desc(coeff))

```


**Worldwide, a total of `r length(call_countries_increasing('cases'))` countries reported an increasing trend in cases** (Figure \@ref(fig:map-world-case-trend)):

**Africa:** (`r length(call_countries_increasing('cases', 'Africa'))`)`r glue(": {call_countries_increasing('cases', 'Africa') %>% combine_words()}")`. 

**Asia:** (`r length(call_countries_increasing('cases', 'Asia'))`)`r glue(": {call_countries_increasing('cases', 'Asia') %>% combine_words()}")`. 

**Americas:** (`r length(call_countries_increasing('cases', 'Americas'))`)`r glue(": {call_countries_increasing('cases', 'Americas') %>% combine_words()}")`. 

**Europe:** (`r length(call_countries_increasing('cases', 'Europe'))`)`r glue(": {call_countries_increasing('cases', 'Europe') %>% combine_words()}")`. 

**Oceania:** (`r length(call_countries_increasing('cases', 'Oceania'))`)`r glue(": {call_countries_increasing('cases', 'Oceania') %>% combine_words()}")`. 


<!-- Map cases counts and trends in the last 12 days -->
```{r map-world-case-trend, fig.width = 8, fig.height = 10, fig.cap = glue('Cases count and trend during the period from {format(date_max_report - (period_trend - 1), "%d %B %Y")} to {format(date_max_report, "%d %B %Y")} ({period_trend} days)')}

map_world_case_count_12d <- plot_map_world_count(tbl_case_count_12d, 'cases') + 
  labs(title = 'Case count (12 days)')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_case_count_12d', '_', week_report, '.png')), 
       plot = map_world_case_count_12d, 
       scale = 1, 
       dpi = 320)


map_world_case_trend <- plot_map_world_trend(tbl_case_trend, 'cases') + 
  labs(title = 'Case trend (12 days)')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_case_trend', '_', week_report, '.png')), 
       plot = map_world_case_trend, 
       scale = 1, 
       dpi = 320)


# This graph is only for the html (to change with package patchwork)
ggarrange(map_world_case_count_12d + labs(title = '', caption = ''), 
          map_world_case_trend  + labs(title = ''), 
          labels = c("Case count (12 days)", "Case trend (12 days)"), 
          ncol = 1)

```


```{r, include = FALSE}
# This graph is only for the EpiSitrep

map_world_case_count_trend_grid <- ggarrange(
  map_world_case_trend  + labs(title = '', caption = ''),  
  ggarrange(
    map_world_case_count + labs(title = '', caption = ''),
    map_world_case_count_12d  + labs(title = '', caption = ''), 
    labels = c("Cumulative case counts", "Case count (12 days)"), 
    common.legend = TRUE, 
    legend = 'bottom', 
    ncol = 2), 
  labels = c("Case trend (12 days)"),
  nrow = 2) %>% 
  annotate_figure(bottom = text_grob(caption_world_map, hjust = 1, x = 1, size = 10))

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_case_count_trend_grid', '_', week_report, '.png')), 
       plot = map_world_case_count_trend_grid, 
       scale = 1.1, 
       width = 9, 
       height = 8, 
       dpi = 320)

```


<!-- Table cases trends -->
```{r tbl-countries-cases-increasing}

tbl_countries_increasing_cases <- tbl_case_trend %>% 
  select(c(iso_a3 : cases), all_of(vars_trends(model_for_trend))) %>% 
  left_join(tbl_case_count_30d %>% select(iso_a3, cases_30d = cases), by = 'iso_a3') %>% 
  left_join(tbl_case_count_12d %>% select(iso_a3, cases_12d = cases), by = 'iso_a3') %>% 
  left_join(tbl_case_trend_30d %>% select(iso_a3, coeff_30d = l_cnt_30d_coeff, lwr_30d = l_cnt_30d_lwr, upr_30d = l_cnt_30d_upr, trend_30d = trend_linear_30d), by = 'iso_a3') %>%
  filter(trend == 'Increasing' | trend_30d == 'Increasing') %>% 
  select(-c(iso_a3, region)) %>% 
  arrange(continent, desc(coeff)) %>% 
  mutate(
    coeff = round(exp(coeff), digits = 2), 
    coeff_ci = combine_ci(exp(lwr), exp(upr), digits = 2), 
    lwr = NULL,
    upr = NULL) %>% 
  mutate(
    coeff_30d = round(exp(coeff_30d), digits = 2), 
    coeff_ci_30d = combine_ci(exp(lwr_30d), exp(upr_30d), digits = 2), 
    lwr_30d = NULL,
    upr_30d = NULL) %>% 
  mutate(
    coeff_ci = case_when(
      coeff_ci == '[NA - NA]' ~ NA_character_, 
      TRUE ~ coeff_ci), 
    coeff_ci_30d = case_when(
      coeff_ci_30d == '[NA - NA]' ~ NA_character_, 
      TRUE ~ coeff_ci_30d)) %>% 
  select(continent, country, cases, cases_30d, cases_12d, coeff_30d, coeff_ci_30d, coeff, coeff_ci, trend, trend_30d)


gtbl_countries_increasing_cases <- tbl_countries_increasing_cases %>% 
  gt(rowname_col = 'country', groupname_col = 'continent') %>% 
  cols_hide(
    columns = vars(trend, trend_30d)) %>% 
  cols_label(
    cases     = 'Total', 
    cases_30d = 'Last 30 days', 
    cases_12d = 'Last 12 days',  
    coeff     = 'Rate', 
    coeff_ci  = '95% CI', 
    coeff_30d = 'Rate',
    coeff_ci_30d = '95% CI') %>% 
  tab_spanner(
    label = 'Number of cases', 
    columns = starts_with('cases')) %>% 
  tab_spanner(
    label = 'Trend (30 days)', 
    columns = vars(coeff_30d, coeff_ci_30d)) %>% 
  tab_spanner(
    label = 'Trend (12 days)', 
    columns = vars(coeff, coeff_ci)) %>% 
  fmt_number(
    columns = starts_with('cases'), 
    decimals = 0) %>% 
  fmt_number(
    columns = vars(coeff, coeff_30d), 
    decimals = 2) %>% 
  fmt_missing(
    columns = vars(coeff, coeff_ci), 
    missing_text = "---") %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[1], alpha = 0.8), 
      cell_text(weight = 'bold')), 
    locations = cells_body(
      columns = vars(coeff, coeff_ci), 
      rows = trend == 'Increasing')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[2], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff, coeff_ci), 
      rows = trend == 'Stable')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[3], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff, coeff_ci), 
      rows = trend == 'Declining')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[1], alpha = 0.8), 
      cell_text(weight = 'bold')), 
    locations = cells_body(
      columns = vars(coeff_30d, coeff_ci_30d), 
      rows = trend_30d == 'Increasing')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[2], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff_30d, coeff_ci_30d), 
      rows = trend_30d == 'Stable')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[3], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff_30d, coeff_ci_30d), 
      rows = trend_30d == 'Declining')) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(1),
    data_row.padding = px(1), 
    table_body.border.top.width = px(1))

gtbl_countries_increasing_cases %>% 
  tab_header(
    title = 'Countries with a significant increasing trend in cases in the last 30 or 12 days')

```


# Covid-19 associated deaths and trends

## Deaths counts

**Countries with more than 10k deaths** (in decreasing order): `r tbl_death_count %>% call_countries_with(10000, Inf, 'deaths') %>% combine_words()`.

**Countries with more than 100k deaths** (in decreasing order): `r tbl_death_count %>% call_countries_with(100000, Inf, 'deaths') %>% combine_words()` (Figure \@ref(fig:map-world-deaths-count)).

**African countries with less than 50 deaths** (in decreasing order): `r tbl_death_count %>% filter(continent == 'Africa') %>% call_countries_with(1, 49, 'deaths') %>% combine_words()`.


<!-- Map deaths count -->
```{r map-world-deaths-count, fig.cap = glue('Number of Covid-19 associated deaths as of {format(date_max_report, "%d %b %Y")}')}

map_world_death_count <- plot_map_world_count(tbl_death_count, 'deaths')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_death_count', '_', week_report, '.png')), 
       plot = map_world_death_count, 
       scale = 1, 
       dpi = 320)


map_world_death_count + labs(title = NULL)

```


## Deaths trends
<!-- TABLE - Trend in number of deaths -->
```{r}

# This table display trends estimated in the last 30 days (only count linear models)

tbl_death_trend_30d <- tbl_death_count_30d %>% 
  select(-brks) %>% 
  left_join(rename(model_cnt_deaths_linear_long[[3]] , all_of(attach_prefix(coeff_vars, 'l_cnt_30d_')))) %>% 
  mutate(
    trend_linear_30d = case_when(
      l_cnt_30d_lwr > 0 ~ "Increasing", 
      l_cnt_30d_upr < 0 ~ "Declining", 
      l_cnt_30d_upr > 0 & l_cnt_30d_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')))


tbl_death_trend <- tbl_death_count %>% 
  select(-brks) %>% 
  left_join(rename(model_cnt_deaths_linear_short[[3]] , all_of(attach_prefix(coeff_vars, 'l_cnt_')))) %>% 
  mutate(
    trend_linear = case_when(
      l_cnt_lwr > 0 ~ "Increasing", 
      l_cnt_upr < 0 ~ "Declining", 
      l_cnt_upr > 0 & l_cnt_lwr < 0 ~ "Stable", 
      TRUE ~ NA_character_) %>% 
      factor(levels = c('Increasing', 'Stable', 'Declining')))

write.csv(tbl_death_trend, 
          file.path(path.local.worldwide.tables, paste0('tbl_death_trend', '_', week_report, '.csv')), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- TABLE - Countries with increasing trend in number of deaths -->
```{r tbl-deaths-increasing-trend}

tbl_death_increasing_trend <- tbl_death_trend %>% 
  select(c(iso_a3 : deaths), all_of(vars_trends(model_for_trend))) %>% 
  filter(trend == 'Increasing') %>% 
  arrange(continent, desc(coeff))

```


**Worldwide, a total of `r length(call_countries_increasing('deaths'))` countries reported an increasing trend in deaths** (Figure \@ref(fig:map-world-deaths-trends)):

**Africa:** (`r length(call_countries_increasing('deaths', 'Africa'))`)`r glue(": {call_countries_increasing('deaths', 'Africa') %>% combine_words()}")`. 

**Asia:** (`r length(call_countries_increasing('deaths', 'Asia'))`)`r glue(": {call_countries_increasing('deaths', 'Asia') %>% combine_words()}")`. 

**Americas:** (`r length(call_countries_increasing('deaths', 'Americas'))`)`r glue(": {call_countries_increasing('deaths', 'Americas') %>% combine_words()}")`. 

**Europe:** (`r length(call_countries_increasing('deaths', 'Europe'))`)`r glue(": {call_countries_increasing('deaths', 'Europe') %>% combine_words()}")`. 

**Oceania:** (`r length(call_countries_increasing('deaths', 'Oceania'))`)`r glue(":  {call_countries_increasing('deaths', 'Oceania') %>% combine_words()}")`. 

<!-- Map deaths counts and trends in the last 12 days -->
```{r map-world-deaths-trends, fig.width = 8, fig.height = 10, fig.cap = glue('Mapping of Covid-19 associated deaths and trends during the period from {format(date_max_report - (period_trend - 1), "%d %B %Y")} to {format(date_max_report, "%d %B %Y")} ({period_trend} days)')}

map_world_death_count_12d <- plot_map_world_count(tbl_death_count_12d, 'deaths') + 
  labs(title = 'Death count (12 days)')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_death_count_12d', '_', week_report, '.png')), 
       plot = map_world_death_count_12d, 
       scale = 1, 
       dpi = 320)

map_world_death_trend <- plot_map_world_trend(tbl_death_trend, 'deaths') + 
  labs(title = 'Death trend (12 days)')

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_death_trend', '_', week_report, '.png')), 
       plot = map_world_death_trend, 
       scale = 1, 
       dpi = 320)


# This graph is only for the html
ggarrange(map_world_death_count_12d + labs(title = '', caption = ''), 
          map_world_death_trend  + labs(title = ''), 
          labels = c("Death count (12 days)", "Death trends (12 days)"), 
          ncol = 1)

```

```{r, include = FALSE}
# This graph is only for the EpiSitrep

map_world_death_count_trend_grid <- ggarrange(
  map_world_death_trend  + labs(title = '', caption = ''),  
  ggarrange(
    map_world_death_count + labs(title = '', caption = ''),
    map_world_death_count_12d  + labs(title = '', caption = ''), 
    labels = c("Cumulative death count", "Death count (12 days)"), 
    common.legend = TRUE, 
    legend = 'bottom', 
    ncol = 2), 
  labels = c("Death trend (12 days)"),
  nrow = 2) %>% 
  annotate_figure(bottom = text_grob(caption_world_map, hjust = 1, x = 1, size = 10))

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_death_count_trend_grid', '_', week_report, '.png')), 
       plot = map_world_death_count_trend_grid, 
       scale = 1.1, 
       width = 9, 
       height = 8, 
       dpi = 320)

```


<!-- Table deaths trends -->
```{r tbl-countries-deaths-increasing}

tbl_countries_increasing_deaths <- tbl_death_trend %>% 
  select(c(iso_a3 : deaths), all_of(vars_trends(model_for_trend))) %>% 
  left_join(tbl_death_count_30d %>% select(iso_a3, deaths_30d = deaths), by = 'iso_a3') %>% 
  left_join(tbl_death_count_12d %>% select(iso_a3, deaths_12d = deaths), by = 'iso_a3') %>% 
  left_join(tbl_death_trend_30d %>% select(iso_a3, coeff_30d = l_cnt_30d_coeff, lwr_30d = l_cnt_30d_lwr, upr_30d = l_cnt_30d_upr, trend_30d = trend_linear_30d), by = 'iso_a3') %>%
  filter(trend == 'Increasing' | trend_30d == 'Increasing') %>% 
  select(-c(iso_a3, region)) %>% 
  arrange(continent, desc(coeff)) %>% 
  mutate(
    coeff = round(exp(coeff), digits = 2), 
    coeff_ci = combine_ci(exp(lwr), exp(upr), digits = 2), 
    lwr = NULL,
    upr = NULL) %>% 
  mutate(
    coeff_30d = round(exp(coeff_30d), digits = 2), 
    coeff_ci_30d = combine_ci(exp(lwr_30d), exp(upr_30d), digits = 2), 
    lwr_30d = NULL,
    upr_30d = NULL) %>% 
  mutate(
    coeff_ci = case_when(
      coeff_ci == '[NA - NA]' ~ NA_character_, 
      TRUE ~ coeff_ci), 
    coeff_ci_30d = case_when(
      coeff_ci_30d == '[NA - NA]' ~ NA_character_, 
      TRUE ~ coeff_ci_30d)) %>% 
  select(continent, country, deaths, deaths_30d, deaths_12d, coeff_30d, coeff_ci_30d, coeff, coeff_ci, trend, trend_30d)

gtbl_countries_increasing_deaths <- tbl_countries_increasing_deaths %>% 
  gt(rowname_col = 'country', groupname_col = 'continent') %>% 
  cols_hide(
    columns = vars(trend, trend_30d)) %>% 
  cols_label(
    deaths     = 'Total', 
    deaths_30d = 'Last 30 days', 
    deaths_12d = 'Last 12 days',  
    coeff     = 'Rate', 
    coeff_ci  = '95% CI', 
    coeff_30d = 'Rate',
    coeff_ci_30d = '95% CI') %>% 
  tab_spanner(
    label = 'Number of deaths', 
    columns = starts_with('deaths')) %>% 
  tab_spanner(
    label = 'Trend (30 days)', 
    columns = vars(coeff_30d, coeff_ci_30d)) %>% 
  tab_spanner(
    label = 'Trend (12 days)', 
    columns = vars(coeff, coeff_ci)) %>% 
  fmt_number(
    columns = starts_with('deaths'), 
    decimals = 0) %>% 
  fmt_number(
    columns = vars(coeff, coeff_30d), 
    decimals = 2) %>% 
  fmt_missing(
    columns = vars(coeff, coeff_ci), 
    missing_text = "---") %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[1], alpha = 0.8), 
      cell_text(weight = 'bold')), 
    locations = cells_body(
      columns = vars(coeff, coeff_ci), 
      rows = trend == 'Increasing')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[2], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff, coeff_ci), 
      rows = trend == 'Stable')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[3], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff, coeff_ci), 
      rows = trend == 'Declining')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[1], alpha = 0.8), 
      cell_text(weight = 'bold')), 
    locations = cells_body(
      columns = vars(coeff_30d, coeff_ci_30d), 
      rows = trend_30d == 'Increasing')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[2], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff_30d, coeff_ci_30d), 
      rows = trend_30d == 'Stable')) %>% 
  tab_style(
    style = list(
      cell_fill(color = RdAmGn[3], alpha = 0.8)), 
    locations = cells_body(
      columns = vars(coeff_30d, coeff_ci_30d), 
      rows = trend_30d == 'Declining')) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(1),
    data_row.padding = px(1), 
    table_body.border.top.width = px(1))


gtbl_countries_increasing_deaths %>% 
  tab_header(
    title = 'Countries with a significant increasing trend in deaths in cases in the last 30 or 12 days')

```

<!-- BIG SUMMARY TABLE -->
```{r tbl-summary-cases-and-deaths, include = FALSE}

tbl_summary_cases_deaths <- df_countries %>% 
  left_join(select(tbl_case_count, iso_a3, cases)) %>% 
  left_join(select(tbl_death_count, iso_a3, deaths)) %>% 
  left_join(select(tbl_case_trend, iso_a3, all_of(vars_trends(model_for_trend)))) %>% 
  mutate(
    trend_cases_coeff = round(exp(coeff), digits = 2), 
    trend_cases_ci = case_when(
      is.na(coeff) ~ NA_character_, 
      TRUE ~ combine_ci(exp(lwr), exp(upr), digits = 2))) %>% 
  select(-one_of('coeff','lwr', 'upr', 'trend')) %>% 
  left_join(select(tbl_death_trend, iso_a3, all_of(vars_trends(model_for_trend)))) %>% 
  mutate(
    trend_deaths_coeff = round(exp(coeff), digits = 2), 
    trend_deaths_ci = case_when(
      is.na(coeff) ~ NA_character_, 
      TRUE ~ combine_ci(exp(lwr), exp(upr), digits = 2))) %>% 
  select(-one_of('coeff','lwr', 'upr', 'trend')) %>% 
  mutate(
    cfr = round(deaths / cases * 100, digits = 1)) %>% 
  left_join(select(df_pop_country, iso_a3, pop)) %>% 
  mutate(
    cases_ip  = cases  / pop * 100000, 
    deaths_ip = deaths / pop * 100000) %>% 
  select(iso_a3, continent, region, country, 
         cases, deaths, cfr, 
         cases_ip, deaths_ip, 
         starts_with('trend_cases_'), starts_with('trend_deaths_')) %>% 
  left_join(select(tbl_case_count_12d, iso_a3, cases_12d = cases)) %>% 
  left_join(select(tbl_death_count_12d, iso_a3, deaths_12d = deaths)) %>%
  group_by(continent, region) %>% 
  arrange(country, .by_group = TRUE) %>% 
  ungroup()

gtbl_summary_cases_deaths <- tbl_summary_cases_deaths %>% 
  gt(rowname_col = "country", 
  groupname_col = c('continent', 'region')) %>% 
  cols_hide(
    columns = vars(iso_a3)) %>% 
  cols_label(
    country = 'Country', 
    cases = 'Cases', 
    deaths = 'Deaths', 
    cfr = html('naïve<br>CFR'),
    cases_ip = 'cases',
    deaths_ip ='deaths', 
    cases_12d = 'Cases', 
    deaths_12d = 'Deaths', 
    trend_cases_coeff  = 'Rate', 
    trend_cases_ci     = "[95% CI]", 
    trend_deaths_coeff = 'Rate', 
    trend_deaths_ci    = "[95% CI]") %>% 
  cols_move(
    columns = vars(cases_12d), 
    after = vars(deaths_ip)) %>% 
  fmt_number(
    columns = starts_with(c('cases', 'deaths')), 
    decimals = 0) %>% 
  fmt_missing(
    columns = starts_with(c('trend_cases', 'trend_deaths')), 
    missing_text = "---") %>% 
  tab_spanner(
    label = "Totals", 
    columns = vars(cases, deaths)) %>% 
  tab_spanner(
    label = html("Incidence proportion<br>per 100,000 people"), 
    columns = ends_with('_ip')) %>% 
  tab_spanner(
    label = 'In the last 12 days', 
    columns = ends_with('_12d')) %>% 
  tab_spanner(
    label = "Trends of cases", 
    columns = starts_with('trend_cases_')) %>% 
  tab_spanner(
    label = "Trends of deaths", 
    columns = starts_with('trend_deaths_')) %>% 
  summary_rows(
    groups = TRUE, 
    columns = vars(cases, deaths, cases_12d, deaths_12d), 
    fns = list('Region total' = ~sum(., na.rm = TRUE)),
    decimals = 0) %>% 
  grand_summary_rows(
    columns = vars(cases, deaths, cases_12d, deaths_12d), 
    fns = list('Grand total' = ~sum(., na.rm = TRUE)), 
    decimals = 0) %>% 
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = starts_with(c('cases','deaths')))) %>% 
  tab_style(
    style = list(
      cell_text(align = "left")),
    locations = cells_column_labels(columns = ends_with('_ci'))) %>%   
  tab_header(title = glue('Worldwide Covid-19 cases and associated deaths, and trends as of {format(date_max_report, "%d %b %Y")}'),
             subtitle = html('<strong>Trends are estimate using data of the previous 12 days</strong><br>
                             Analysis carried out by Epicentre<br>
                             For information on the analysis methods click <a href="https://reports.msf.net/secure/app_direct/covid19-additional-analysis/analysis_methods_2020-08-20.html">here</a><br>
                             Tables of previous weeks are available <a href="https://reports.msf.net/secure/app_direct/covid19-additional-analysis/tables_world_summary/archive/">here</a><br><br>
                             <strong>NOTE to interprete the trends</strong><br>
                             A trend with rate greater than 1 indicates an increaasing trend<br>
                             A trend with rate of less than 1 indicates a declining trend')) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(1),
    data_row.padding = px(1), 
    table_body.border.top.width = px(1))

gtbl_summary_cases_deaths

gtsave(gtbl_summary_cases_deaths, 
       file.path(path.local.worldwide.tables, paste0(week_report, '_world_summary_cases_deaths', '.html')), 
       inline_css = TRUE) %>% 
  invisible()

```


# Incidence proportions

```{r, include = FALSE}
## Table used in the maps of both cases and deaths incidence proportions

## Breaks for incidence proportions
breaks_ip <- c(0, 10, 100, 1000, 10000, Inf)
labels_ip <- label_breaks(breaks_ip) %>% gsub("\\<0-1\\>", "0", .)

tbl_inc_prop <- tbl_summary_cases_deaths %>% 
  select(iso_a3 : country, cases, deaths, cases_ip, deaths_ip) %>% 
  mutate(
    cases_brks  = cut(cases_ip, breaks_ip, labels = labels_ip, include.lowest = TRUE, right = FALSE), 
    deaths_brks = cut(deaths_ip, breaks_ip, labels = labels_ip, include.lowest = TRUE, right = FALSE))

```


The incidence proportions of cases are mapped in Figure \@ref(fig:map-world-cases-incidence-proportion). The incidence proportion of deaths are mapped in Figure \@ref(fig:map-world-deaths-incidence-proportion). 

## Incidence proportions of cases
<!-- Map of incidences proportion of cases -->
```{r map-world-cases-incidence-proportion, fig.cap = paste('Incidence proportion of Covid-19 reported cases since beginning of epidemic per 100,000 population, data until', format(date_max_report, "%d %B %Y"))}

sf_inc_prop <- tbl_inc_prop %>% 
  inner_join(
    select(sf_world, iso_a3),
    by = "iso_a3"
  ) %>% 
  st_as_sf()

map_world_case_attack_rates <- ggplot(sf_inc_prop) + 
  geom_sf(aes(fill = cases_brks), size = .1) + 
  scale_fill_brewer(
    name = "Incidence proportion of cases / 100,000 population", palette = "Blues", 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels_ip), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "bottom")

map_world_case_attack_rates 

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_case_attack_rates', '_', week_report, '.png')), 
       plot = map_world_case_attack_rates + labs(title = NULL), 
       width = 10 * cm_to_in, 
       height = 6.66 * cm_to_in, 
       scale = 1.3, 
       dpi = 320)

```


## Incidence proportions of Covid associated deaths

<!-- Map of incidence proportion of deaths -->
```{r map-world-deaths-incidence-proportion, fig.cap = paste('Incidence proportion of Covid-19 associated deaths since the beginning of epidemic per 100,000 population, data until', format(date_max_report, "%d %B %Y"))}

map_world_death_attack_rates <- ggplot(sf_inc_prop) + 
  geom_sf(aes(fill = deaths_brks), size = .1) + 
  scale_fill_brewer(
    name = "Incidence proportion of deaths / 100,000 population", palette = "Reds", 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels_ip), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "bottom")

map_world_death_attack_rates 

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_death_attack_rates', '_', week_report, '.png')), 
       plot = map_world_death_attack_rates + labs(title = NULL), 
       width = 10 * cm_to_in, 
       height = 6.66 * cm_to_in, 
       scale = 1.3, 
       dpi = 320)

```


## Cases count _versus_ incidence proportion

<!-- Dots plot cumulative incidences versus incidence -->
```{r counts-versus-incidence-proportion}
# New graph as requested by Fran
# to see how to display

scatter_plot_inc <- function(tbl_inc, var_x, var_y, label_log_x = TRUE, label_log_y = TRUE){
  
  var_x <- sym(var_x)
  var_y <- sym(var_y)

  temp_tbl <- tbl_inc %>% filter(!!var_x != 0)
  countries_zero_count <- tbl_inc %>% filter(!!var_x == 0) %>% pull(country)
  
  txt_countries_zero_count <- ifelse(length(countries_zero_count) == 0, 'none', combine_words(countries_zero_count))
  
  
  scatterplot <- ggplot(temp_tbl) + 
    geom_point(aes(!!var_x, !!var_y, col = region)) + 
    ggrepel::geom_text_repel(
      data = temp_tbl,
      aes(!!var_x, !!var_y, label = country, colour = region),
      size = 3,
      show.legend = FALSE) + 
    labs(caption = paste0("Countries with zero count: ", txt_countries_zero_count, ".\n", caption_world_map), 
         color = NULL) + 
    theme_light()

  scatterplot <- if(label_log_x) {
    scatterplot + 
      scale_x_continuous(trans = 'log10', 
                         breaks = scales::trans_breaks("log10", function(x) 10^x), 
                         labels = scales::label_number_si()) + 
      labs(x = paste(var_x, "(log scale)"))
    } else {
      scatterplot
    }
  
  scatterplot <- if(label_log_y) {
    scatterplot + 
      scale_y_continuous(trans = 'log10', 
                         breaks = scales::trans_breaks("log10", function(x) 10^x), 
                         labels = scales::label_number_si()) + 
      labs(y = paste(var_y, "(log scale)"))
    } else {
      scatterplot
    }
    
  return(scatterplot)
}


label_x_axis <-  "Total number of cases\n(log scale)"
label_y_axis <- "Incidence proportion of cases per 100,000 population\n(log scale)"


scatter_plot_inc_Africa <- scatter_plot_inc(tbl_inc_prop %>% filter(continent == 'Africa'), var_x = 'cases', var_y = 'cases_ip') + 
  labs(title = 'Africa', 
       x = label_x_axis, 
       y = label_y_axis)

ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Africa', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Africa + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Asia <- scatter_plot_inc(tbl_inc_prop %>% filter(continent == 'Asia'), var_x = 'cases', var_y = 'cases_ip') + 
  labs(title = 'Asia', 
       x = label_x_axis, 
       y = label_y_axis)

ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Asia', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Asia + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Americas <- scatter_plot_inc(tbl_inc_prop %>% filter(continent == 'Americas'), var_x = 'cases', var_y = 'cases_ip') + 
  labs(title = 'Americas',
       x = label_x_axis, 
       y = label_y_axis)

ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Americas', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Americas + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Europe <- scatter_plot_inc(tbl_inc_prop %>% filter(continent == 'Europe'), var_x = 'cases', var_y = 'cases_ip') + 
  labs(title = 'Europe', 
       x = label_x_axis, 
       y = label_y_axis)

ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Europe', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Europe + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Oceania  <- scatter_plot_inc(tbl_inc_prop %>% filter(continent == 'Oceania'), var_x = 'cases', var_y = 'cases_ip') + 
  labs(title = 'Oceania', 
       x = label_x_axis, 
       y = label_y_axis)

ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Oceania', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Oceania + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Africa
scatter_plot_inc_Asia
scatter_plot_inc_Americas
scatter_plot_inc_Europe

```



## Incidence proportions: Overall _versus_ last 30 days

<!-- Dots plot 30 days cumulative incidence versus 30 days incidence -->
```{r incidence-proportion-overall-versus-30-days}
# New graph as requested by Fran
# to see how to display

tbl_inc_prop_30d <- dta_ecdc %>% 
  group_by(iso_a3, country, continent, region) %>% 
  arrange(date) %>% 
  filter(between(date, left = date_max_report - 29, right = date_max_report)) %>% 
  summarise(
    cases = max(cumsum(cases), na.rm = TRUE)) %>% 
  left_join(df_pop_country %>% select(iso_a3, pop)) %>% 
  mutate(
    cases_ip = cases / pop * 100000)

tbl_inc_prop_all_and_30d <- select(tbl_inc_prop, iso_a3 : country, overall = cases_ip) %>% 
  left_join(select(tbl_inc_prop_30d, iso_a3, last_30d = cases_ip))


lab_x_axis <- "Incidence proportion of cases per 100,000 population\nsince the beginning of the epidemic (log scale)"
lab_y_axis <- "Incidence proportion of cases per 100,000 population\nin the last 30 days (log scale)"

scatter_plot_inc_Africa <- scatter_plot_inc(tbl_inc_prop_all_and_30d %>% filter(continent == 'Africa'), var_x = 'overall', var_y = 'last_30d') + 
  labs(title = 'Africa', 
       x = lab_x_axis, 
       y = lab_y_axis)

ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Africa_30-days', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Africa + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Asia <- scatter_plot_inc(tbl_inc_prop_all_and_30d %>% filter(continent == 'Asia'), var_x = 'overall', var_y = 'last_30d') + 
  labs(title = 'Asia', 
       x = lab_x_axis, 
       y = lab_y_axis)


ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Asia_30-days', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Africa + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Americas <- scatter_plot_inc(tbl_inc_prop_all_and_30d %>% filter(continent == 'Americas'), var_x = 'overall', var_y = 'last_30d') + 
  labs(title = 'Americas', 
       x = lab_x_axis, 
       y = lab_y_axis)


ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Americas_30-days', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Americas + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Europe <- scatter_plot_inc(tbl_inc_prop_all_and_30d %>% filter(continent == 'Europe'), var_x = 'overall', var_y = 'last_30d') + 
  labs(title = 'Europe', 
       x = lab_x_axis, 
       y = lab_y_axis)


ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Europe_30-days', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Europe + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Oceania  <- scatter_plot_inc(tbl_inc_prop_all_and_30d %>% filter(continent == 'Oceania'), var_x = 'overall', var_y = 'last_30d') + 
  labs(title = 'Oceania', 
       x = lab_x_axis, 
       y = lab_y_axis)


ggsave(file.path(path.local.worldwide.graphs, paste0('scatter_plot_inc_Oceania_30-days', '_', week_report, '.png')), 
         plot = scatter_plot_inc_Oceania + labs(title = NULL), 
         width = 15 * cm_to_in, 
         height = 15 * cm_to_in, 
         scale = 1, 
         dpi = 320)


scatter_plot_inc_Africa
scatter_plot_inc_Asia
scatter_plot_inc_Americas
scatter_plot_inc_Europe

```




# Doubling times

<!-- Doubling in cases -->
```{r doubling-cases}

tbl_case_doubling_time <- tbl_case_count %>% 
  select(-brks) %>% 
  left_join(model_cnt_cases_linear_short[['doubling_time']])

write.csv(tbl_case_doubling_time,
          file.path(path.local.worldwide.tables, paste0('tbl_case_doubling_time', '_', week_report, '.csv')), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- Countries with doubling time in cases -->
```{r}

tbl_countries_doubling_time_cases <- tbl_case_doubling_time %>% 
  right_join(tbl_case_increasing_trend %>% select(iso_a3)) %>% 
  filter(between(est, 0, threshold_doubling_time))

```

<!-- Doubling in deaths -->
```{r estimate-doubling-deaths}

tbl_death_doubling_time <- tbl_death_count %>% 
  select(iso_a3, continent, region, country, deaths) %>% 
  left_join(model_cnt_deaths_linear_short[['doubling_time']])

write.csv(tbl_death_doubling_time, 
          file.path(path.local.worldwide.tables, paste0('tbl_death_doubling_time', '_', week_report, '.csv')), 
          na = "", 
          row.names = FALSE, 
          fileEncoding = "UTF-8")

```

<!-- Countries with doubling time in deaths -->
```{r}
# Categorise the doubling time
tbl_countries_doubling_time_deaths <- tbl_death_doubling_time %>% 
  right_join(tbl_death_increasing_trend %>% select(iso_a3)) %>% 
  filter(between(est, 0, threshold_doubling_time))

```

<!-- Combine countries with doubling time in cases and in deaths -->
```{r tbl-doubling-rank}

tbl_doubling <- tbl_case_doubling_time %>% 
  filter(!is.na(country)) %>% 
  rename(cases_est = est, cases_lwr = lwr, cases_upr = upr) %>% 

  full_join(tbl_death_doubling_time %>% 
  filter(!is.na(country)) %>% 
  rename(deaths_est = est, deaths_lwr = lwr, deaths_upr = upr)) %>% 
  right_join(full_join(tbl_case_increasing_trend %>% select(iso_a3, trend_cases = trend), 
                       tbl_death_increasing_trend %>% select(iso_a3, trend_deaths = trend)))

tbl_doubling_cfr <- tbl_doubling %>%
  mutate(
    cfr = round(deaths / cases * 100, digits = 1)) %>% 
  select(c(iso_a3 : country), cases, deaths, cfr, cases_est, cases_lwr, cases_upr, deaths, deaths_est, deaths_lwr, deaths_upr, trend_cases, trend_deaths) 


tbl_doubling_cfr_rank <- tbl_doubling_cfr %>% 
  filter(between(cases_est, left = 0, right = threshold_doubling_time) | 
           between(deaths_est, left = 0, right = threshold_doubling_time)) %>% 
  arrange(cases_est)
    
```


## Countries with doubling time in cases less than `r (threshold_doubling_time)` days

A sharp increasing of cases (doubling time of less than `r threshold_doubling_time` days) (Figure \@ref(fig:map-world-cases-doubling)) is observed in: 

**Africa:** (`r length(call_countries_doubling('cases_est', 'Africa'))`)`r glue(": {call_countries_doubling('cases_est', 'Africa') %>% combine_words()}")`. 

**Asia:** (`r length(call_countries_doubling('cases_est', 'Asia'))`)`r glue(": {call_countries_doubling('cases_est', 'Asia') %>% combine_words()}")`. 

**Americas:** (`r length(call_countries_doubling('cases_est', 'Americas'))`)`r glue(": {call_countries_doubling('cases_est', 'Americas') %>% combine_words()}")`. 

**Europe:** (`r length(call_countries_doubling('cases_est', 'Europe'))`)`r glue(": {call_countries_doubling('cases_est', 'Europe') %>% combine_words()}")`. 

**Oceania:** (`r length(call_countries_doubling('cases_est', 'Oceania'))`)`r glue(": {call_countries_doubling('cases_est', 'Oceania') %>% combine_words()}")`. 


<!-- Map doubling cases -->
```{r map-world-cases-doubling, fig.cap = glue('Doubling time of the number of Covid-19 cases estimated in the last 12 days (only countries with increasing trends are displayed)')}

breaks <- c(0, 4, 8, 12, Inf)
labels <- label_breaks(breaks)

# Categorise the doubling time
df_doubling_cases <- tbl_case_doubling_time %>% 
  select(c(iso_a3:est), doubling_time = 'est') %>% 
  left_join(tbl_case_trend %>% 
              select(iso_a3, trend = trend_linear), 
            by = 'iso_a3') %>% 
  mutate(
    doubling_time = case_when(
      (trend != 'Increasing' | is.na(trend)) ~ NA_real_,
      TRUE ~ doubling_time), 
    brks = cut(doubling_time, breaks, labels = labels, include.lowest = TRUE)) %>% 
  select(c(iso_a3:cases), trend, doubling_time, brks)


# Join the dataframe with the sf
sf_doubling_cases <- df_doubling_cases %>% 
  inner_join(
    select(sf_world, iso_a3),
    by = "iso_a3"
  ) %>% 
  st_as_sf()

# plot the map
RdYl <- c('#993404','#D95F0E','#FE9929','#FED98E','#FFFFD4')

map_world_doubling_cases <- ggplot(sf_doubling_cases) + 
  geom_sf(aes(fill = brks), size = .1) + 
  scale_fill_manual(
    name = "Doubling time (days)", 
    values = RdYl, 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(title = 'Doubling time of cases', caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom")

map_world_doubling_cases + labs(title = NULL) 

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_doubling_cases', '_', week_report, '.png')), 
       plot = map_world_doubling_cases, 
       scale = 1, 
       dpi = 320)

```


## Countries with doubling time in deaths less than `r (threshold_doubling_time)` days

A sharp increasing of deaths (doubling time of less than `r threshold_doubling_time` days) (Figure \@ref(fig:map-world-deaths-doubling)) is observed in: 

**Africa:** (`r length(call_countries_doubling('deaths_est', 'Africa'))`)`r glue(": {call_countries_doubling('deaths_est', 'Africa') %>% combine_words()}")`. 

**Asia:** (`r length(call_countries_doubling('deaths_est', 'Asia'))`)`r glue(": {call_countries_doubling('deaths_est', 'Asia') %>% combine_words()}")`. 

**Americas:** (`r length(call_countries_doubling('deaths_est', 'Americas'))`)`r glue(": {call_countries_doubling('deaths_est', 'Americas') %>% combine_words()}")`. 

**Europe:** (`r length(call_countries_doubling('deaths_est', 'Europe'))`)`r glue(": {call_countries_doubling('deaths_est', 'Europe') %>% combine_words()}")`. 

**Oceania:** (`r length(call_countries_doubling('deaths_est', 'Oceania'))`)`r glue(": {call_countries_doubling('deaths_est', 'Oceania') %>% combine_words()}")`. 

<!-- Map doubling deaths -->
```{r map-world-deaths-doubling, fig.cap = paste0("Doubling time of the number of Covid-19 associated deaths estimated in the last ", threshold_doubling_time, " (only countries with increasing trends are displayed)")}

# Categorise the doubling time
df_doubling_deaths <- tbl_death_doubling_time %>% 
  select(c(iso_a3:deaths), doubling_time = 'est') %>% 
  left_join(tbl_death_trend %>% 
              select(iso_a3, trend = trend_linear), 
            by = 'iso_a3') %>% 
  mutate(
    doubling_time = case_when(
      (trend != 'Increasing' | is.na(trend)) ~ NA_real_,
      TRUE ~ doubling_time), 
    brks = cut(doubling_time, breaks, labels = labels, include.lowest = TRUE)) %>% 
  select(c(iso_a3:deaths), doubling_time, brks)

# Join the dataframe with the sf
sf_doubling_deaths <- df_doubling_deaths %>% 
  inner_join(
    select(sf_world, iso_a3),
    by = "iso_a3"
  ) %>% 
  st_as_sf()

# plot the map
map_world_doubling_deaths <- ggplot(sf_doubling_deaths) + 
  geom_sf(aes(fill = brks), size = .1) + 
  scale_fill_manual(
    name = "Doubling time (days)", 
    values = RdYl, 
    drop = FALSE, 
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(70 / length(labels), units = "mm"),
      title.hjust = 0.5,
      nrow = 1,
      label.position = "bottom",
      title.position = 'top')) +
  labs(title = 'Doubling time of deaths', caption = caption_world_map) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom")

map_world_doubling_deaths

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_doubling_deaths', '_', week_report, '.png')), 
       plot = map_world_doubling_deaths, 
       scale = 1, 
       dpi = 320)

```


## Summary table of countries with doubling time in cases or deaths less than `r threshold_doubling_time` days

```{r}
#  The tbl_cfr_doubling_rank is made above

gtbl_doubling_cfr_rank <- tbl_doubling_cfr_rank %>% 
  arrange(cases_est) %>% 
  mutate(
    cases_ci95 = case_when(
      is.na(cases_est) | cases_est <= 0 ~ NA_character_, 
      cases_est > 0 & cases_upr <= 0 ~ 'Non significant', 
      TRUE ~ combine_ci(cases_lwr, cases_upr)),
    cases_est = case_when(
      cases_est <= 0 ~ NA_real_, 
      TRUE ~ round(cases_est, digits = 1)), 
    cases_lwr = NULL, 
    cases_upr = NULL, 
    deaths_ci95 = case_when(
      is.na(deaths_est) | deaths_est <= 0 ~ NA_character_, 
      deaths_est > 0 & deaths_upr <= 0 ~ 'Non significant', 
      TRUE ~ combine_ci(deaths_lwr, deaths_upr)),
    deaths_est = case_when(
      deaths_est <= 0 ~ NA_real_, 
      TRUE ~ round(deaths_est, digits = 1)), 
    deaths_lwr = NULL, 
    deaths_upr = NULL) %>% 
  gt(rowname_col = 'country', groupname_col = 'continent') %>% 
  cols_hide(
    columns = vars(iso_a3, region, trend_cases, trend_deaths)) %>% 
  cols_label(
    country = 'Country', 
    cases = 'Cases', 
    deaths = 'Deaths', 
    cfr = 'naïve CFR', 
    cases_est = 'days', 
    cases_ci95 = "[95% CI]", 
    deaths_est = 'days', 
    deaths_ci95 = "[95% CI]") %>% 
  fmt_number(
    columns = vars(cases, deaths), 
    decimals = 0) %>% 
  fmt_missing(
    columns = vars(cases_est, cases_ci95, deaths_est, deaths_ci95), 
    missing_text = "---") %>% 
  tab_spanner(
    label = "Totals", 
    columns = vars(cases, deaths)) %>% 
  tab_spanner(
    label = "Doubling time of cases", 
    columns = vars(cases_est, cases_ci95)) %>% 
  tab_spanner(
    label = "Doubling time of deaths", 
    columns = vars(deaths_est, deaths_ci95)) %>% 
  tab_footnote(
    footnote = "Total number of deaths reported so far, divided by the total number of cases.",
    locations = cells_column_labels(
      columns = vars(cfr))) %>%  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    row_group.padding = px(2),
    data_row.padding = px(2), 
    table_body.border.top.width = px(2))


gtsave(gtbl_doubling_cfr_rank %>% 
         tab_options(
           column_labels.font.size = px(10), 
           table.font.size = px(10)),
       file.path(path.local.worldwide.tables, paste0('gtbl_cfr_doubling_rank', '_', week_report, '.png')), 
       vwidth = 720,
       vheight = 720 * 1.414) %>% 
  invisible()

gtbl_doubling_cfr_rank

```


## Countries with critical doubling time of cases
<!-- Dot plot doubling time over number of days with increasing trend -->
```{r dots-hotspot-cases, fig.cap = glue('Distribution of doubling time of Covid-19 cases according to length in days since the first significant increasing trend reported (only countries with doubling time of less than {threshold_doubling_time} days as of {format(date_max_report, "%d %B %Y")} are displayed)')}

# Identify the date of a significant positive trend (We might need to sue cusum at one point)
tbl_case_date_pos_trend <- tibble(iso_a3 = as.character(), 
                                   date_lwr_pos = as.Date(NA))

for (country_iso in names(lst_coeffs_cases)) {
  dta_lwr_pos <- lst_coeffs_cases[[country_iso]] %>% 
    mutate(
      lwr_pos = lwr > 0) %>% 
    filter(lwr_pos)
  
  if (nrow(dta_lwr_pos) == 0) {
    tbl_case_date_pos_trend <- tbl_case_date_pos_trend %>% 
      add_row(iso_a3 = country_iso, 
              date_lwr_pos = as.Date(NA))
  } else {
    tbl_case_date_pos_trend <- tbl_case_date_pos_trend %>% 
      add_row(iso_a3  = country_iso, 
              date_lwr_pos = min(as.Date(dta_lwr_pos$date)))
  }
}

# Manual entry
tbl_case_date_pos_trend <- tbl_case_date_pos_trend %>% 
  mutate(
    date_lwr_pos = case_when(
      iso_a3 == 'COM' ~ as.Date('2020-05-19'),
      iso_a3 == 'NIC' ~ as.Date('2020-05-22'), 
      TRUE ~ date_lwr_pos
    )
  )

# The table
tbl_hot_countries <- tbl_doubling_cfr %>% 
  left_join(tbl_case_date_pos_trend) %>% 
  mutate(
    nb_days = as.numeric(date_max_report - date_lwr_pos)
  ) %>% 
   filter(between(cases_est, 0, threshold_doubling_time))

# The dots plot
dots_hotspot_cases <- ggplot(tbl_hot_countries) + 
  geom_point(aes(nb_days, cases_est, col = continent)) + 
  ggrepel::geom_text_repel(
    data = tbl_hot_countries,
    aes(nb_days, cases_est, label = country, colour = continent),
    size = 3,
    show.legend = FALSE) + 
  ylim(0, threshold_doubling_time) + 
  labs(
    y = "Doubling time in number of cases",
    x = "Number of days since a significant increasing trend was found",
    color = NULL
  ) + 
  theme_light()

ggsave(file.path(path.local.worldwide.graphs, paste0('dots_hotspot_cases', '_', week_report, '.png')), 
       plot = dots_hotspot_cases, 
       width = 6, 
       height = 4, 
       scale = 1.1, 
       dpi = 320)


dots_hotspot_cases

```


# Number of diagnostic tests performed

```{r, include = FALSE}

# Table of cumulative number of tests and assess reliability
tbl_tests <- tibble(iso_a3    = character(), 
                    tests_cml = numeric(), 
                    reliable  = character())

for (i in names(lst_tests)) {
  
  tst <- lst_tests[[i]] %>% 
    filter(between(date, left = date_max_report - (period_trend - 1), right = date_max_report))
  if (sum(is.na(tst$new_tests)) == period_trend | nrow(tst) == 0) {
    tbl_tests <- tbl_tests %>% 
      add_row(iso_a3 = i, 
              tests_cml = sum(tst$new_tests, na.rm = TRUE),
              reliable = NA_character_)
  } else {
    if (sum(tst$new_tests == 0, na.rm = TRUE) > 6 | sum(is.na(tst$new_tests)) > period_trend/2) {
      tbl_tests <- tbl_tests %>% 
        add_row(iso_a3 = i, 
                tests_cml = sum(tst$new_tests, na.rm = TRUE),
                reliable = 'No')
    } else {
      tbl_tests <- tbl_tests %>% 
        add_row(iso_a3 = i, 
                tests_cml = sum(tst$new_tests, na.rm = TRUE), 
                reliable = 'Yes')
    }
  }
}

# Final table
tbl_tests_inc <- df_countries %>% 
  left_join(df_pop_country %>% select(iso_a3, pop)) %>% 
  left_join(tbl_tests) %>% 
  left_join(tbl_case_count_12d %>% select(iso_a3, cases_12d = cases)) %>% 
  right_join(tbl_case_increasing_trend %>% select(iso_a3, coeff)) %>% 
  mutate(
    cases_inc_12d = cases_12d / pop * 100000, 
    tests_prop    = cases_12d / tests_cml, 
    tests_ratio   = tests_cml / cases_12d, 
    tests_rate    = tests_cml / pop * 100000) %>% 
  mutate(
    reliable = case_when(
      (tests_prop > 1 & tests_prop != Inf) ~ 'No', 
      TRUE ~ reliable))

```

<!-- Plot test proportion -->
```{r dots-tests-proportion, fig.cap = 'Relation between the proportion of positive tests in the last 12 days and the cumulative number of cases reported'}

tbl_tests_inc_reliable <- tbl_tests_inc %>% 
  filter(reliable == 'Yes')

dots_prop_tests <- ggplot(tbl_tests_inc_reliable, aes(tests_prop, cases_inc_12d)) + 
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "red", size = 0.5) + 
  geom_point(aes(colour = continent)) + 
  ggrepel::geom_text_repel(
    aes(tests_prop, cases_inc_12d, label = country, colour = continent),
    size = 3,
    show.legend = FALSE) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_y_log10(labels = scales::label_number_si()) + 
  labs(
    y = "Cumulative number of cases per 100,000 people in the last 12 days (log scale)",
    x = glue('Proportion of Covid positive tests in the last 12 days'), 
    colour = 'Continent', 
    caption = glue('Analysis and graphic by Epicentre | Data source: FIND as of {format(date_max_report, "%d %b %Y")}')) + 
  theme_light()
  
ggsave(file.path(path.local.worldwide.graphs, paste0('dots_prop_tests', '_', week_report, '.png')), 
       plot = dots_prop_tests, 
       width = 8, 
       height = 6, 
       scale = 1, 
       dpi = 320)

dots_prop_tests

```

```{r}

# Table of missing data
tbl_tests_country_non_reliable <- tbl_tests_inc %>% 
  filter(reliable == 'No') %>% 
  arrange(country) %>% 
  pull(country)

tbl_tests_country_no_data <- tbl_tests_inc %>% 
  filter(is.na(reliable)) %>% 
  arrange(country) %>% 
  pull(country)

tbl_no_tests <- cbind_diff(list(not_reliable_data = tbl_tests_country_non_reliable, 
                                 no_data = tbl_tests_country_no_data))


gtbl_no_tests <- tbl_no_tests %>% 
  gt() %>% 
  cols_label(
   not_reliable_data = 'No reliable data', 
   no_data = 'No data available') %>% 
  cols_align(
    align = 'left', 
    columns = vars(not_reliable_data, no_data)) %>% 
  fmt_missing(
    columns = vars(not_reliable_data, no_data), 
    missing_text = "") %>% 
  tab_style(
    style = list(
      cell_fill(color = '#C7FFFF'), 
      cell_borders(color = '#C7FFFF')), 
    locations = cells_body(
    columns = vars(not_reliable_data))) %>% 
  tab_style(
    style = list(
      cell_fill(color = '#C7FFFF')), 
    locations = cells_column_labels(
    columns = vars(not_reliable_data))) %>% 
  tab_style(
    style = list(
      cell_fill(color = '#EAC5AD'), 
      cell_borders(color = '#EAC5AD')), 
    locations = cells_body(
    columns = vars(no_data))) %>% 
  tab_style(
    style = list(
      cell_fill(color = '#EAC5AD')), 
    locations = cells_column_labels(
    columns = vars(no_data))) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(1))

gtsave(gtbl_no_tests, 
       file.path(path.local.worldwide.tables, paste0('gtbl_no_tests', '_', week_report,'.png'))) %>% 
  invisible()


gtbl_no_tests

```


<!-- Plot test ratio -->
```{r dots-tests-ratio, fig.cap = glue('Relation between the number of tests carried out in the last 12 days (as ratio of the number of confirmed cases) and the cumulative number of cases reported')}

dots_ratio_tests <- ggplot(tbl_tests_inc, aes(tests_ratio, cases_inc_12d)) + 
  geom_point(aes(tests_ratio, cases_inc_12d, colour = continent)) + 
  geom_point(data = tbl_tests_inc %>% filter(reliable == 'No'), 
             pch = 21, fill = NA, size = 4, colour = "red", stroke = 1) + 
  geom_point(data = tbl_tests_inc %>% filter(tests_cml == 0), 
             pch = 21, fill = NA, size = 4, colour = "black", stroke = 1) + 
  ggrepel::geom_text_repel(
    aes(tests_ratio, cases_inc_12d, label = country, colour = continent),
    size = 3,
    show.legend = FALSE) + 
  scale_x_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) +
  scale_y_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) + 
  labs(
    y = "Cumulative number of cases per 100,000 people (log scale)",
    x = "Ratio of the number of tests done over the number of cases confirmed (log scale)", 
    colour = 'Continent', 
    caption = 'NOTE: \nBlack circles = No data on the number of tests performed\nRed circles = Unreliable data on the number of tests performed') + 
  theme_light() + 
  theme(
    plot.caption = element_text(hjust = 0))

dots_ratio_tests

ggsave(file.path(path.local.worldwide.graphs, glue("dots_ratio_tests_{week_report}.png")), 
       plot = dots_ratio_tests, 
       width = 8, 
       height = 6, 
       scale = 1, 
       dpi = 320)
```

<!-- Plot test rate -->
```{r dots-tests-rate, fig.cap = glue('Relation between the number of tests carried out in the last 12 days (as rate of the country population) and the cumulative number of cases reported')}

dots_rate_tests <- ggplot(tbl_tests_inc, aes(tests_rate, cases_inc_12d)) + 
  geom_point(aes(tests_rate, cases_inc_12d, colour = continent)) + 
  geom_point(data = tbl_tests_inc %>% filter(reliable == 'No'), 
             pch = 21, fill = NA, size = 4, colour = "red", stroke = 1) + 
  geom_point(data = tbl_tests_inc %>% filter(tests_cml == 0), 
             pch = 21, fill = NA, size = 4, colour = "black", stroke = 1) + 
  ggrepel::geom_text_repel(
    aes(tests_rate, cases_inc_12d, label = country, colour = continent),
    size = 3, 
    show.legend = FALSE) + 
  scale_x_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) +
  scale_y_continuous(trans = 'log10', 
                     breaks = scales::trans_breaks("log10", function(x) round(10^x, 0)), 
                     labels = scales::trans_format("log10", function(x) round(10^x, 0))) + 
  labs(
    y = "Cumulative number of cases per 100,000 people (log scale)",
    x = "Number of tests done per 100,000 people (log scale)", 
    colour = 'Continent', 
    caption = 'NOTE: \nBlack circles = No data on the number of tests performed\nRed circles = Unreliable data on the number of tests performed') + 
  theme_light() + 
  theme(
    plot.caption = element_text(hjust = 0))

dots_rate_tests

ggsave(file.path(path.local.worldwide.graphs, paste0('dots_rate_tests', '_', week_report, '.png')), 
       plot = dots_rate_tests, 
       width = 8, 
       height = 6, 
       scale = 1, 
       dpi = 320)

```



<!-- === === === === === === === === -->
<!-- Graphs and table for EpiSitrep  -->
<!-- === === === === === === === === -->

<!-- Map world cases grid -->
```{r map-world-cases-grid, include = FALSE}

map_world_case_grid <- grid.arrange(map_world_case_count + labs(caption = ''), 
                                     map_world_case_trend, 
                                     ncol = 2)
ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_case_grid', '_', week_report, '.png')), 
       plot = map_world_case_grid, 
       scale = 1.6, 
       width = 7, 
       height = 3)

```

<!-- Map world deaths grid -->
```{r map-world-deaths-grid, include = FALSE}

map_world_death_grid <- grid.arrange(map_world_death_count + labs(caption = ''), 
                                      map_world_death_trend, ncol = 2)
ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_death_grid', '_', week_report, '.png')), 
       plot = map_world_death_grid, 
       scale = 1.6, 
       width = 7, 
       height = 3)

```

<!-- Map world doubling time grid -->
```{r map-world-doubling-grid, include = FALSE}

map_world_doubling_grid <- ggarrange(
  map_world_doubling_cases + labs(caption = ''), 
  map_world_doubling_deaths + labs(caption = ''), 
  common.legend = TRUE, 
  legend = 'bottom', 
  ncol = 2) %>% 
  annotate_figure(bottom = text_grob(caption_world_map, hjust = 1, x = 1, size = 10))

ggsave(file.path(path.local.worldwide.graphs, paste0('map_world_doubling_grid', '_', week_report, '.png')), 
       plot = map_world_doubling_grid, 
       scale = 1.6, 
       width = 7, 
       height = 3)

```


<!-- Save results -->
```{r save-results, include = FALSE}

rm(list = lsf.str())
save.image(file.path(path.local.worldwide.data, paste0('episitrep_worldwide_analyses', '_', week_report, '.RData')))

```
