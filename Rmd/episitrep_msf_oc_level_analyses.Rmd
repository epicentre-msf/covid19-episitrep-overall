---
title: "Covid-19 MSF data analysis - OC level"
params:
  OC: OCP
author:
  - name: Francesco Grandesso
    url: mailto:francesco.GRANDESSO@epicentre.msf.org
    affiliation: Epicentre
    affiliation_url: https://epicentre.msf.org/
  - name: Paul Campbell
    url: mailto:paul.CAMPBELL@epicentre.msf.org
    affiliation: Epicentre
    affiliation_url: https://epicentre.msf.org/
  - name: Mathilde Mousset
    url: mailto:mathilde.MOUSSET@epicentre.msf.org
    affiliation: Epicentre
    affiliation_url: https://epicentre.msf.org/
date: '`r Sys.Date()`'
output:
  distill::distill_article:
    toc: TRUE
    toc_depth: 1
editor_options:
  chunk_output_type: console
---

<!-- Setup environment and upload functions -->

```{r setup, warning = FALSE, message = FALSE, include = FALSE}

if (!exists('path.root')) {
  source(here::here('R', 'setup.r'), encoding = 'UTF-8')
}

source(file.path(path.R, 'utils_management.R'), encoding = 'UTF-8')
source(file.path(path.R, 'utils_get_data.R')  , encoding = 'UTF-8')
source(file.path(path.R, 'utils_vis.R')       , encoding = 'UTF-8')


# Set the left and right censoring for date of consultation. 
# The right-censoring create also the week value and the folders where to save the outputs
dates_and_week <- set_date_frame(create_folders = TRUE)

date_min_report <- dates_and_week[[1]]
date_max_report <- dates_and_week[[2]]
week_report     <- dates_and_week[[3]]


# If week folder not created already by overall sitrep, create it.
path.local.week.oc <- file.path(path.local, week_report, "oc")

path.local.msf.data.oc   <- file.path(path.local.week.oc, params$OC, 'data')
path.local.msf.graphs.oc <- file.path(path.local.week.oc, params$OC, 'graphs')
path.local.msf.graphs.oc.per.project <- file.path(path.local.week.oc, params$OC, 'graphs', 'per_project')
path.local.msf.tables.oc <- file.path(path.local.week.oc, params$OC, 'tables')

if (!dir.exists(path.local.week.oc)) {
  dir.create(path.local.week.oc,   showWarnings = FALSE, recursive = TRUE)
}

if (!dir.exists(path.local.msf.data.oc)) {
  dir.create(path.local.msf.data.oc,   showWarnings = FALSE, recursive = TRUE)
}
if (!dir.exists(path.local.msf.graphs.oc)) {
  dir.create(path.local.msf.graphs.oc, showWarnings = FALSE, recursive = TRUE)
}
if (!dir.exists(path.local.msf.graphs.oc.per.project)) {
  dir.create(path.local.msf.graphs.oc.per.project, showWarnings = FALSE, recursive = TRUE)
}
if (!dir.exists(path.local.msf.tables.oc)) {
  dir.create(path.local.msf.tables.oc, showWarnings = FALSE, recursive = TRUE)
}



caption_graph <- glue('Analysis and graphic by Epicentre | Data source: MSF linelists as of {format(date_max_report, "%d %b %Y")}')


knitr::opts_chunk$set(cache = FALSE,
                      echo = FALSE,
                      tidy = TRUE,
                      collapse = TRUE,
                      dpi = 150,
                      fig.width = 8,
                      fig.height = 5,
                      fig.align = "center",
                      warning = FALSE,
                      message = FALSE,
                      encoding = "UTF-8")

```

<!-- Import and manage data -->

```{r get-data, include = FALSE}

## Import the list of countries
df_countries <- readRDS(file.path(path.local.data, 'df_countries.RDS'))

## Import MSF linelist --- --- --- 


dta_linelist <- get_msf_linelist(force = TRUE) %>% 
  clean_msf_dta() %>% 
  prepare_msf_dta(shorten_var_names = TRUE) %>% 
  rename(iso_a3 = country) %>% 
  left_join(df_countries %>% select(continent, region, iso_a3, country), by = 'iso_a3') %>% 
  mutate(
    country   = as.factor(country), 
    continent = as.factor(continent)) %>% 
  filter(between(date_consultation, 
                 left = date_min_report, right = date_max_report) | is.na(date_consultation)) %>%  # Filter date limits using date of consultation
  filter(across(
    .cols = ends_with(params$OC),
    .fns  = ~ .x == TRUE))


## Import aggregated data --- --- --- 
dta_weekly_aggregated <- get_msf_aggregated(force = TRUE)
dta_project_aggregated_dates <- get_msf_aggregated_dates(force = TRUE)

### Remove temporarily Quito that grouped the whole activity in a single week
dta_weekly_aggregated <- dta_weekly_aggregated %>% 
  filter(project != 'Quito-Fixed & mobile brigades')


### Expand the aggregated
dta_aggregated_expanded <- dta_weekly_aggregated %>% 
  filter(!project %in% c('Lesvos-Moria', 'Lesvos-Moria Ped')) %>% 
  select(-week) %>% 
  mutate(
    date = as.Date(date), 
    epi_week_consultation = make_epiweek_date(date) %>% as.Date(), 
    country = case_when(
      country == 'DRC' ~ 'Democratic Republic of the Congo', 
      country == "Côte d'Ivoire" ~ 'Côte d’Ivoire', 
      TRUE ~ country)) %>% 
  left_join(df_countries, by = 'country') %>% 
  pivot_longer(cols = c('confirmed', 'probable', 'suspected', 'non_cases', 'unknown'), 
               names_to = 'covid_status') %>% 
  filter(!is.na(value)) %>% 
  mutate(obs = purrr::map(value, ~rep_len(1, .x))) %>%
  unnest(cols = c(obs)) %>%
  select(-c(value, obs)) %>% 
  mutate(
    covid_status = factor(covid_status, 
                          levels = c('confirmed', 'probable', 'suspected',
                                     'non_cases', 'unknown'), 
                          labels = c('Confirmed', 'Probable', 'Suspected',
                                     'Not a case', 'Unknown'))) %>% 
  rename('OC' = oc, 
         'site_name' = project) %>% 
  filter(between(date, left = date_min_report, right = date_max_report) | is.na(date)) %>% 
  filter(OC == params$OC)


# The dataset with linelist and the expanded aggregated data together
dta_linelist_with_aggregated <- dta_linelist %>% 
  select(continent, region, country, site_name, iso_a3, OC, epi_week_consultation, 
         covid_status, project) %>% 
  add_row(dta_aggregated_expanded %>% 
            select(continent, region, country, site_name, iso_a3, 
                   OC, epi_week_consultation, covid_status) %>% 
            mutate(
              country = paste(country, '(*)'), 
              site_name = paste(site_name, '(*)'))) %>% 
  mutate(
    project = case_when(
      is.na(project) ~ site_name,
      TRUE           ~ project),
    covid_status = recode(covid_status, "(Unknown)" = "Unknown")
  )


tbl_aggregated_expanded_with_dates <- dta_aggregated_expanded %>% 
  distinct(sheet, OC, country, site_name) %>% 
  full_join(dta_project_aggregated_dates, by = 'sheet') %>% 
  mutate(
    country = case_when(
      country == 'DRC' ~ 'Democratic Republic of the Congo', 
      country == "Côte d'Ivoire" ~ 'Côte d’Ivoire', 
      TRUE ~ country)) %>% 
  pivot_longer(
    cols = date_first:date_last, 
    names_to = "type_date", 
    values_to = "date_consultation") %>% 
  left_join(df_countries, by = 'country') %>% 
  mutate(
    country = paste(country, '(*)'),
    site_name = paste(site_name, '(*)'))
```


# Overview `r params$OC`

This section will present **information of completeness of data** (number of MSF projects that are active on Covid-19 care, reporting individual data (linelist), reporting aggregated data and not reporting data). Number of projects will be listed by continent and region. 

At the date the required data are not yet available. And this section will be updated as soon as they will be available.

```{r numbers, include = FALSE}
nb_msf_sites_linelist   <- length(unique(dta_linelist$site_name))              # Nb of sites using the linelist
nb_msf_sites_aggregated <- length(unique(dta_aggregated_expanded$site_name))   # Nb of sites using aggregated data
nb_msf_sites            <- nb_msf_sites_linelist + nb_msf_sites_aggregated     # Sum of the two above


call_msf_countries <- unique(c(as.character(dta_linelist$country), as.character(dta_aggregated_expanded$country))) %>% 
  sort() # List of countries reporting data
nb_msf_countries <- length(call_msf_countries)

nb_msf_obs_linelist   <- dta_linelist %>% count() %>% pull(n)         # Nb of observations in the linelist
nb_msf_obs_aggregated <- dta_aggregated_expanded %>% count() %>% pull(n)  # Nb of observations in aggreagated data
nb_msf_obs            <- nb_msf_obs_linelist + nb_msf_obs_aggregated

nb_msf_confirmed <- sum(dta_linelist_with_aggregated$covid_status == 'Confirmed', na.rm = TRUE)
nb_msf_probable  <- sum(dta_linelist_with_aggregated$covid_status == 'Probable' , na.rm = TRUE)
nb_msf_suspected <- sum(dta_linelist_with_aggregated$covid_status == 'Suspected', na.rm = TRUE)


nb_msf_confirmed_linelist <- sum(dta_linelist$covid_status == 'Confirmed', na.rm = TRUE)

nb_msf_confirmed_with_comorbidity <- with(dta_linelist, sum(covid_status == 'Confirmed' & Comcond_count > 0, na.rm = TRUE))

nb_msf_conf_prob_susp <- with(dta_linelist, sum(covid_status %in% c('Confirmed', 'Probable', 'Suspected') & outcome_status %in% c('Cured', 'Died'), na.rm = TRUE))

nb_msf_conf_prob_susp_who_died <- with(dta_linelist, sum(covid_status %in% c('Confirmed', 'Probable', 'Suspected') & outcome_status == 'Died', na.rm = TRUE))

nb_msf_conf_above65 <- with(dta_linelist, sum(covid_status == 'Confirmed' & age_in_years >=65 & outcome_status %in% c('Cured', 'Died'), na.rm = TRUE))

nb_msf_conf_above65_who_died <- with(dta_linelist, sum(covid_status == 'Confirmed' & age_in_years >=65 & outcome_status == 'Died', na.rm = TRUE))

median_age_all <- dta_linelist %>% 
  pull(age_in_years) %>% 
  median(na.rm = TRUE)

median_age_all_by_sex <- dta_linelist %>% 
  group_by(sex) %>% 
  summarise(
    age_median = median(age_in_years, na.rm = TRUE))

median_age_confirmed <- dta_linelist %>% 
  filter(covid_status == 'Confirmed') %>% 
  pull(age_in_years) %>% 
  median(na.rm = TRUE)

median_age_confirmed_by_sex <- dta_linelist %>% 
  filter(covid_status == 'Confirmed') %>% 
  group_by(sex) %>% 
  summarise(
    age_median = median(age_in_years, na.rm = TRUE))

median_age_confirmed_died <- dta_linelist %>% 
  filter(covid_status == 'Confirmed' & outcome_status == 'Died') %>% 
  pull(age_in_years) %>% 
  median(na.rm = TRUE)
```

**Number of MSF sites**: `r nb_msf_sites` (`r nb_msf_sites_linelist` sites with linelist data and `r nb_msf_sites_aggregated` with aggregated data).

**Total patients consulted/admitted**: `r format(nb_msf_obs, big.mark = ',')` in `r length(call_msf_countries)` countries (`r combine_words(call_msf_countries)`).

**Number of consultation reported through the linelist**: `r format(nb_msf_obs_linelist, big.mark = ',')`.

**Number of consultation reported through the aggregated data reporting**: `r format(nb_msf_obs_aggregated, big.mark = ',')`.

Of all consultations/admissions patients were in relation with the Covid-19 infection:

-   `r format(nb_msf_confirmed, big.mark = ',')` confirmed
-   `r format(nb_msf_probable , big.mark = ',')` probable
-   `r format(nb_msf_suspected, big.mark = ',')` suspected

------------------------------------------------------------------------

# All patients consulted/admitted

This section provides an overview of **all patients that attended an MSF supported Covid-19 health facility**: number of patients consulted, but not admitted and number of consulted and admitted to the health facility.

Other results are presented by Covid status (confirmed, probable, suspected, not a case and unknown) and listed by country or site and grouped by continent.

## Time & place

### Weekly number of consultations (including admission) by Covid status

Aggregated data included

<!-- Histograms of patients Covid status -->

```{r hist-covid-status, fig.cap = 'Weekly number of consultations (including admission) by Covid status'}
# DONE by Paul

tbl_epicurve_status <- dta_linelist_with_aggregated %>%
  count(covid_status, epi_week_consultation)

hist_epicurve_status <- tbl_epicurve_status %>% 
  ggplot(aes(epi_week_consultation, n, fill = covid_status)) +
  geom_col() +
  ggthemes::scale_fill_tableau(name = "Status", palette = "Tableau 20") +
  scale_x_date(name = "Week of Consultation", 
               date_breaks = "2 week", date_labels = "%V", 
               expand = expansion(mult = c(0.01, 0.01)),
               sec.axis = ggplot2::sec_axis(trans = ~ as.Date(.))) + #labels = function(x) format(x, "%b-%Y")
  scale_y_continuous(name = "Patients", expand = expansion(mult = c(0, 0.02))) +
  theme_light() + 
  theme(legend.position = 'top', panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())

ggsave(filename = paste0('hist_epicurve_status', '_', week_report, '.png'),
       path = path.local.msf.graphs.oc,
       plot = hist_epicurve_status, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)


hist_epicurve_status
```

<!-- Histograms BY CONTINENT of patients Covid status -->

```{r hist-covid-status-facet-continent, fig.cap = 'Weekly number of consultations (including admission) by Covid status, in each continent where MSF is operating'}
# DONE by Francesco (copied from the Paul graph just above)

tbl_epicurve_status_continent <- dta_linelist_with_aggregated %>%
  count(continent, covid_status, epi_week_consultation)


hist_epicurve_status_continent <- tbl_epicurve_status_continent %>% 
  ggplot(aes(epi_week_consultation, n, fill = covid_status)) +
  facet_wrap(vars(continent), scales = 'free_y') +
  geom_col() +
  ggthemes::scale_fill_tableau(name = NULL, palette = "Tableau 20") +
  scale_x_date(name = "Week of Consultation", date_breaks = "2 week", date_labels = "%V", expand = expansion(mult = c(0.01, 0.01)),
               sec.axis = ggplot2::sec_axis(trans = ~ as.Date(.))) + #labels = function(x) format(x, "%b-%Y")
  scale_y_continuous(name = "Patients", expand = expansion(mult = c(0, 0.02))) +
  labs(y = "Patients", caption = 'NOTE: free y axis scale among graphics') +
  theme_light() +
  theme(legend.position = 'top', panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())

ggsave(file.path(path.local.msf.graphs.oc, paste0('hist_epicurve_status_continent', '_', week_report, '.png')),
       plot = hist_epicurve_status_continent, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

hist_epicurve_status_continent
```

### Weekly number of admissions

Aggregated data excluded

<!-- Histogram OVERALL of number of consultation/admissions -->

```{r hist-consultations-sdmissions, fig.cap = paste('Weekly number of consultations and admissions in an MSF supported COvid-19 health service as of', format(date_max_report, "%d %B %Y"))}
# DONE by Paul

tbl_epicurve_consultation <- dta_linelist %>%
  filter(merge_admit != "Unknown") %>% 
  count(epi_week_consultation, merge_admit) %>%
  drop_na() %>%
  mutate(merge_admit = recode(merge_admit, "Yes" = "Admitted", "No" = "Not Admitted"))

tbl_admit_prop <- dta_linelist %>%
  filter(merge_admit != "Unknown") %>% 
  drop_na(epi_week_consultation) %>%
  group_by(epi_week_consultation) %>%
  summarise(
    n = n(),
    total = sum(merge_admit %in% c("Yes", "No")),
    admitted = sum(merge_admit == "Yes"),
    admit_prop = admitted / total
  ) %>%
  ungroup()

n_max <- max(tbl_admit_prop$n, na.rm = TRUE)
cfr_max <- rounder(max(tbl_admit_prop$admit_prop, na.rm = TRUE), .1)
cfr_max <- ifelse(cfr_max > 1, 1, cfr_max)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

missing_consultation <- sum(is.na(dta_linelist$epi_week_consultation))
missing_admission    <- sum(dta_linelist$merge_admit == "Unknown")

hist_epicurve_consult_admit <- tbl_epicurve_consultation %>% 
  ggplot(aes(epi_week_consultation, n)) +
  geom_col(aes(fill = merge_admit)) +
  geom_line(data = tbl_admit_prop,
            aes(y = admit_prop / scaling_factor, colour = "Admitted %"),
            key_glyph = "timeseries", size = 1) +
  ggthemes::scale_fill_tableau(name = NULL, palette = "Tableau 20") +
  scale_x_date(name = "Week of Consultation", date_breaks = "2 weeks", date_labels = "%V", 
               sec.axis = ggplot2::sec_axis(trans = ~ .), expand = expansion(mult = c(0.01, 0.01))) +
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Admitted", labels = scales::percent_format(accuracy = 1)),
                     expand = expansion(mult = c(0, 0.02))) +
  labs(y = "Patients", colour = NULL, caption = glue::glue("Missing data: Consultation Date {missing_consultation}, Admission: {missing_admission}")) + 
  theme_light() + 
  theme(legend.position = "top", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())


ggsave(file.path(path.local.msf.graphs.oc, paste0('hist_epicurve_consult_admit', '_', week_report, '.png')),
       plot = hist_epicurve_consult_admit, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)


hist_epicurve_consult_admit
```

<!-- Histogram BY CONTINENT of number of consultation/admissions -->

```{r hist-consultations-admissions-facet-continent, fig.cap = paste('Weekly number of consultations and admissions in an MSF supported COvid-19 health service by continent as of', format(date_max_report, "%d %B %Y"))}
# DONE by Paul

tbl_epicurve_consultation_continent <- dta_linelist %>%
  filter(merge_admit != "Unknown") %>% 
  count(continent, epi_week_consultation, merge_admit) %>%
  drop_na() %>%
  mutate(merge_admit = recode(merge_admit, "Yes" = "Admitted", "No" = "Not Admitted"))

tbl_admit_prop_continent <- dta_linelist %>%
  filter(merge_admit != "Unknown") %>% 
  drop_na(epi_week_consultation) %>%
  group_by(continent, epi_week_consultation) %>%
  summarise(
    n = n(),
    total = sum(merge_admit %in% c("Yes", "No")),
    admitted = sum(merge_admit == "Yes"),
    admit_prop = admitted / total
  ) %>%
  ungroup()

n_max <- max(tbl_admit_prop_continent$n, na.rm = TRUE)
cfr_max <- rounder(max(tbl_admit_prop_continent$admit_prop, na.rm = TRUE), .1)
cfr_max <- ifelse(cfr_max > 1, 1, cfr_max)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

missing_consultation <- sum(is.na(dta_linelist$epi_week_consultation))
missing_admission    <- sum(dta_linelist$merge_admit == "Unknown")

hist_epicurve_consult_admit_continent <- tbl_epicurve_consultation_continent %>% 
  ggplot(aes(epi_week_consultation, n)) +
  facet_wrap(~continent) +
  geom_col(aes(fill = merge_admit)) +
  geom_line(data = tbl_admit_prop_continent,
            aes(y = admit_prop / scaling_factor, colour = "Admitted %"),
            key_glyph = "timeseries", size = 0.5) +
  ggthemes::scale_fill_tableau(name = NULL, palette = "Tableau 20") +
  scale_x_date(name = "Week of Consultation", date_breaks = "3 week", date_labels = "%V", 
               sec.axis = ggplot2::sec_axis(trans = ~ .), expand = expansion(mult = c(0.01, 0.01))) +
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Admitted", labels = scales::percent_format(accuracy = 1)),
                     expand = expansion(mult = c(0, 0.02))) +
  labs(y = "Patients", colour = NULL, caption = glue::glue("Missing data: Consultation Date {missing_consultation}, Admission: {missing_admission}")) + 
  theme_light() + 
  theme(legend.position = "top", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank()) 


ggsave(file.path(path.local.msf.graphs.oc, paste0('hist_epicurve_consult_admit_continent', '_', week_report, '.png')),
       plot = hist_epicurve_consult_admit_continent,
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

hist_epicurve_consult_admit_continent
```

```{r gtbl-consultation-continent, layout = "l-body-outset"}
tbl_consultation_continent <- dta_linelist %>%
  filter(merge_admit != "Unknown") %>% 
  mutate(merge_admit = recode(merge_admit, "Yes" = "Admitted", "No" = "Not Admitted")) %>% 
  count(continent, merge_admit) %>% 
  pivot_wider(names_from = merge_admit, values_from = n) %>% 
  adorn_totals(c('col', 'row')) %>% 
  mutate(
    admitted_percent = Admitted / Total* 100)

gtbl_consultation_continent <- tbl_consultation_continent %>% 
  gt(rowname_col = "continent") %>% 
  cols_label(
    admitted_percent = "Admitted (%)") %>% 
  fmt_number(
    columns = vars(Admitted, `Not Admitted`, Total), 
    decimals = 0) %>% 
  fmt_number(
    columns = vars(admitted_percent), 
    decimals = 1) %>% 
  cols_align(
    align = 'right', 
    columns = vars(Admitted, `Not Admitted`, Total, admitted_percent)) %>% 
  cols_width(
    vars(Admitted, `Not Admitted`, Total) ~ px(120), 
    everything() ~ px(100)) %>% 
  tab_options(
    column_labels.font.weight = "bold") %>% 
  tab_header(title = "Number of admissions by continent")

gtbl_consultation_continent
```

### Summary tables of patients consulted/admitted to an MSF supported COvid-19 health facility

```{=html}
<!-- === SUMMARY TABLE BY COUNTRY === 
Counts of patients consulted/admitted to an MSF supported health facility by Covid status (confirmed, probable, suspected, not a case and unknown) listed by country-->
```
```{r, tbl-covid-status-country, layout = "l-page"}
# DONE by Francesco
tbl_countries_covid_status <- dta_linelist_with_aggregated %>%
  select(continent, country, site_name, covid_status) %>%
  group_by(continent, country) %>%
  summarise(
    total = n(),
    n_confirmed = sum(covid_status == 'Confirmed'),
    n_probable  = sum(covid_status == 'Probable'),
    n_suspected = sum(covid_status == 'Suspected'),
    n_not_case  = sum(covid_status == 'Not a case'),
    n_unknown   = sum(covid_status == '(Unknown)'),
    p_confirmed = n_confirmed / total,
    p_probable  = n_probable  / total,
    p_suspected = n_suspected / total,
    p_not_case  = n_not_case  / total,
    p_unknown   = n_unknown   / total) %>%
  ungroup() %>%
  arrange(continent, country)

tbl_countries_dates <- dta_linelist %>%
  select(continent, country, site_name, date_consultation) %>%
  add_row(tbl_aggregated_expanded_with_dates %>% select(continent, country, site_name, date_consultation)) %>%  
  group_by(country) %>%
  summarise(
    date_adm_first = format(min(date_consultation, na.rm = TRUE), '%d-%m-%Y'),
    date_adm_last  = format(max(date_consultation, na.rm = TRUE), '%d-%m-%Y'))

gtbl_countries_covid_status <- tbl_countries_covid_status %>%
  left_join(tbl_countries_dates) %>%
  gt(rowname_col = "country",
     groupname_col = "continent") %>%
  cols_label(
    country     = 'Country',
    total       = 'Total',
    n_confirmed = 'n',
    n_probable  = 'n',
    n_suspected = 'n',
    n_not_case  = 'n',
    n_unknown   = 'n',
    p_confirmed = '(%)',
    p_probable  = '(%)',
    p_suspected = '(%)',
    p_not_case  = '(%)',
    p_unknown   = '(%)',
    date_adm_first = 'First',
    date_adm_last  = 'Last') %>%
  tab_spanner(
    label = html('Dates of<br>consultation/hospitalisation'),
    columns = vars(date_adm_first, date_adm_last)) %>%
  tab_spanner(
    label = html('Confirmed'),
    columns = ends_with('_confirmed')) %>%
  tab_spanner(
    label = html('Probable'),
    columns = ends_with('_probable')) %>%
  tab_spanner(
    label = html('Suspected'),
    columns = ends_with('_suspected')) %>%
  tab_spanner(
    label = html('Not a case'),
    columns = ends_with('_not_case')) %>%
  tab_spanner(
    label = html('(Unknown)'),
    columns = ends_with('_unknown')) %>%
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100,
    pattern = "({x})") %>%
  fmt_missing(
    columns = starts_with('date_adm_'),
    missing_text = "Unknown") %>%
  cols_align(
    align = 'right',
    columns = vars(total)) %>%
  cols_align(
    align = 'left',
    columns = starts_with('p_')) %>%
  cols_align(
    align = 'center',
    columns = starts_with('date_adm_')) %>%
  tab_style(
    style = list(
      cell_text(align = "left")),
    locations = cells_column_labels(columns = starts_with('p_'))) %>%
  summary_rows(
    groups = TRUE,
    columns = vars(total, n_confirmed, n_probable, n_suspected, n_not_case, n_unknown),
    fns = list('Country Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>%
  grand_summary_rows(
    columns = vars(total, n_confirmed, n_probable, n_suspected, n_not_case, n_unknown),
    fns = list('Grand Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
  tab_source_note(
    source_note = "(*) These data were reported as aggregated only and are not included in further analysis below") %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    grand_summary_row.text_transform = 'uppercase',
    data_row.padding = px(1),
    row_group.padding = px(1),
    summary_row.padding = px(1),
    grand_summary_row.padding = px(1))

gtsave(gtbl_countries_covid_status,
       file.path(path.local.msf.tables.oc, paste0('gtbl_countries_covid_status', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_countries_covid_status,
       file.path(path.local.msf.tables.oc, paste0(week_report, '_SUMMARY-TABLE_MSF-countries_by_patients_Covid-status.html'))) %>%
  invisible()


gtbl_countries_covid_status %>% 
  tab_header(
    title = html(paste('SUMMARY TABLE<br>
                 Counts of patients consulted/admitted to an MSF supported COvid-19 health service by Covid status listed by country as of', format(date_max_report, "%d %b %Y"))))
```

```{=html}
<!-- 
=== SUMMARY TABLE BY SITE === 
Not in the EpiSitrep -- Too long
Output in html file that will be available through a link
-->
```
```{r tbl-covid-status-site, layout = "l-page"}
# DONE by Francesco

tbl_sites_covid_status <- dta_linelist_with_aggregated %>%
  mutate(country = gsub(" \\(\\*\\)", "", country)) %>%
  group_by(country, site_name) %>%
  summarise(
    total = n(),
    n_confirmed = sum(covid_status == 'Confirmed'),
    n_probable  = sum(covid_status == 'Probable'),
    n_suspected = sum(covid_status == 'Suspected'),
    n_not_case  = sum(covid_status == 'Not a case'),
    n_unknown   = sum(covid_status == '(Unknown)'),
    p_confirmed = n_confirmed / total,
    p_probable  = n_probable  / total,
    p_suspected = n_suspected / total,
    p_not_case  = n_not_case  / total,
    p_unknown   = n_unknown   / total) %>%
  ungroup()

tbl_site_dates <- dta_linelist %>%
  select(continent, country, site_name, date_consultation) %>%
  add_row(tbl_aggregated_expanded_with_dates %>% select(continent, country, site_name, date_consultation)) %>%
  group_by(site_name) %>%
  summarise(
    date_adm_first = format(min(date_consultation, na.rm = TRUE), '%d-%m-%Y'),
    date_adm_last  = format(max(date_consultation, na.rm = TRUE), '%d-%m-%Y'))

gtbl_sites_covid_status <- tbl_sites_covid_status %>%
  left_join(tbl_site_dates) %>%
  gt(rowname_col = "site_name",
     groupname_col = "country") %>%
  cols_label(
    site_name   = 'Site',
    total       = 'Total',
    n_confirmed = 'n',
    n_probable  = 'n',
    n_suspected = 'n',
    n_not_case  = 'n',
    n_unknown   = 'n',
    p_confirmed = '(%)',
    p_probable  = '(%)',
    p_suspected = '(%)',
    p_not_case  = '(%)',
    p_unknown   = '(%)',
    date_adm_first = 'First',
    date_adm_last  = 'Last') %>%
  tab_spanner(
    label = html('Dates of<br>consultation/hospitalisation'),
    columns = vars(date_adm_first, date_adm_last)) %>%
  tab_spanner(
    label = html('Confirmed'),
    columns = ends_with('_confirmed')) %>%
  tab_spanner(
    label = html('Probable'),
    columns = ends_with('_probable')) %>%
  tab_spanner(
    label = html('Suspected'),
    columns = ends_with('_suspected')) %>%
  tab_spanner(
    label = html('Not a case'),
    columns = ends_with('_not_case')) %>%
  tab_spanner(
    label = html('(Unknown)'),
    columns = ends_with('_unknown')) %>%
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100,
    pattern = "({x})") %>%
  fmt_missing(
    columns = starts_with('date_adm_'),
    missing_text = "Unknown") %>%
  cols_align(
    align = 'right',
    columns = vars(total)) %>%
  cols_align(
    align = 'left',
    columns = starts_with('p_')) %>%
  cols_align(
    align = 'center',
    columns = starts_with('date_adm_')) %>%
  tab_style(
    style = list(
      cell_text(align = "left")),
    locations = cells_column_labels(columns = starts_with('p_'))) %>%
  summary_rows(
    groups = TRUE,
    columns = vars(total, n_confirmed, n_probable, n_suspected, n_not_case, n_unknown),
    fns = list('Country Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>%
  grand_summary_rows(
    columns = vars(total, n_confirmed, n_probable, n_suspected, n_not_case, n_unknown),
    fns = list('Grand Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    grand_summary_row.text_transform = 'uppercase',
    data_row.padding = px(1),
    row_group.padding = px(1),
    summary_row.padding = px(1),
    grand_summary_row.padding = px(1))

gtsave(gtbl_sites_covid_status,
       file.path(path.local.msf.tables.oc, paste0('gtbl_sites_covid_status', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_sites_covid_status %>% 
         tab_header(
           title = html(paste('SUMMARY TABLE<br>
           Counts of patients consulted/admitted to an MSF supported COvid-19 health service by Covid status as of', format(date_max_report, "%d %b %Y"))),
           subtitle = 'Sites with (*) reported aggregated data'),
       file.path(path.local.msf.tables.oc, paste0(week_report, '_SUMMARY-TABLE_MSF-sites_by_patients_Covid-status.html'))) %>%
  invisible()
```

```{=html}
<!-- 
Table by continent (or region) 

- Proportion of positive tests
- Proportion of suspect cases sent home after screening
- Proportion of asymptomatic among the tested positive
-->
```


## Patients' characteristics

### Age distribution by sex of patients consulted/admitted

```{r gtbl-age-distribution-by-sex-all}

dta_age_sex <- dta_linelist %>% 
  select(covid_status, age_in_years, age_5gp, sex) %>%
  drop_na() %>% 
  transform(sex = factor(sex, levels = c('F', 'M'), labels = c('Female', 'Male')))

tbl_age_distribution_by_sex_all <- dta_age_sex %>% 
  group_by(sex) %>% 
  summarise(
    age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)), 
    age_mean    = format(round(mean(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1), 
    age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1)) %>% 
  add_row(
    dta_age_sex %>% 
      summarise(
        sex = 'All', 
        age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)), 
        age_mean    = format(round(mean(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1), 
        age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1)))


gtbl_age_distribution_by_sex_all <- tbl_age_distribution_by_sex_all %>% 
  gt() %>% 
  cols_label(
    sex = 'Sex', 
    age_min_max = 'Min-Max', 
    age_mean = 'Mean', 
    age_median = 'Median') %>% 
  tab_header(
    title = 'Age distribution of all patients consulted/admitted') %>% 
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(1),
    row_group.padding = px(1))


gtbl_age_distribution_by_sex_all
```

```{r gtbl-age-sex-continent}
dta_age_sex <- dta_linelist %>% 
  mutate(sex = factor(sex, levels = c('F', 'M'), labels = c('Female', 'Male')) %>% fct_explicit_na())

tbl_age_sex <- dta_age_sex %>% 
  group_by(sex) %>% 
  summarise(
    age_median = median(age_in_years, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = sex, values_from = age_median) %>% 
  mutate(
    continent = 'Total')

tbl_age_sex_continent <- dta_age_sex %>% 
  group_by(continent, sex) %>% 
  summarise(
    age_median = median(age_in_years, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = sex, values_from = age_median)


gtbl_age_sex_continent <- tbl_age_sex_continent %>% 
  add_row(tbl_age_sex) %>% 
  gt(rowname_col = 'continent') %>% 
  fmt_number(
    columns = 2:4, 
    decimals = 0) %>% 
  tab_header(
    title = 'Median age (years) of patients by continent, all patients consulted/admitted') %>% 
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2),
    row_group.padding = px(2))

gtbl_age_sex_continent
```

### Sex ratio

```{r}
tbl_sex_ratio <- dta_linelist %>% 
  select(continent, sex) %>% 
  transform(sex = factor(sex, levels = c('M', 'F'), labels = c('Male', 'Female')) %>% fct_explicit_na()) %>% 
  group_by(continent) %>% 
  count(sex) %>% 
  pivot_wider(names_from = sex, values_from = n) %>% 
  adorn_totals() %>% 
  mutate(
    ratio_mf = round(Male/Female, 1))

gtbl_sex_ratio <- tbl_sex_ratio %>% 
  gt(rowname_col = 'continent') %>% 
  cols_label(
    ratio_mf = 'Male/Female ratio') %>% 
  tab_header(
    title = 'Sex ratio of all patients consulted/admitted by continent') %>% 
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2),
    row_group.padding = px(2))

gtbl_sex_ratio
```

### Summary table of patients consulted/admitted by type of case

<!-- Table age (median, IQR, min-max), sex and presence of at least one morbidity, by Covid status -->

```{r tbl-all-general-characteristics, layout = "l-page"}
# DONE by Francesco
## This is a complicated table, there might be a simpler way that this one

tbl_general_by_status <- dta_linelist %>% 
  select(covid_status, age_in_years, age_5gp, sex, Comcond_01) %>% 
  group_by(covid_status) %>%
  summarise(
    age_total   = paste0(sum(!is.na(age_in_years)) , '/',  n()),  
    age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)),
    age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1),
    age_gp1     = freq_prct(age_5gp, '0-4'),
    age_gp2     = freq_prct(age_5gp, '5-14'),
    age_gp3     = freq_prct(age_5gp, '15-44'),
    age_gp4     = freq_prct(age_5gp, '45-64'),
    age_gp5     = freq_prct(age_5gp, '65+'),
    sex_total   = paste0(sum(!is.na(sex)) , '/',  n()),
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE),
    sex_ratio   = format(round(sum(sex == 'M', na.rm = TRUE)/sum(sex == 'F', na.rm = TRUE), digits = 1), nsmall = 1),
    comorbidity_total = paste0(sum(!is.na(Comcond_01)) , '/',  n()),
    comorbidity_presence = freq_prct(Comcond_01, 1))


tbl_general_total <- dta_linelist %>% 
  select(covid_status, age_in_years, age_5gp, sex, Comcond_01) %>% 
  summarise(
    age_total   = paste0(sum(!is.na(age_in_years)) , '/',  n()),  
    age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)),
    age_median  = format(round(median(age_in_years, na.rm = TRUE), digits = 1), nsmall = 1),
    age_gp1     = freq_prct(age_5gp, '0-4'),
    age_gp2     = freq_prct(age_5gp, '5-14'),
    age_gp3     = freq_prct(age_5gp, '15-44'),
    age_gp4     = freq_prct(age_5gp, '45-64'),
    age_gp5     = freq_prct(age_5gp, '65+'),
    sex_total   = paste0(sum(!is.na(sex)) , '/',  n()),
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE),
    sex_ratio   = format(round(sum(sex == 'M', na.rm = TRUE)/sum(sex == 'F', na.rm = TRUE), digits = 1), nsmall = 1),
    comorbidity_total = paste0(sum(!is.na(Comcond_01)) , '/',  n()),
    comorbidity_presence = freq_prct(Comcond_01, 1)) %>% 
  mutate(
    covid_status = 'Total')

tbl_general <- tbl_general_by_status %>% 
  add_row(tbl_general_total) %>% 
  mutate(
    covid_status = factor(covid_status, levels = c('Confirmed', 'Probable', 'Suspected', 'Not a case', '(Unknown)', 'Total')))

vars_age <- tibble(levels = tbl_general %>% select(starts_with('age_')) %>% names(),
                   labels = c('Totals with age information, n/N', 'Minimum - maximum', 'Median', '0 - 4, n (%)', '5 - 14, n (%)', '15 - 44, n (%)', '45 - 64, n (%)', '65+, n (%)'))

vars_sex <- tibble(levels = tbl_general %>% select(starts_with('sex_')) %>% names(),
                   labels = c('Totals with sex information, n/N', 'Men, n', 'Women, n', 'Sex ratio (M/F)'))

vars_comorbidities <- tibble(levels = tbl_general %>% select(starts_with('comorbidity_')) %>% names(),
                             labels = c('Totals with comorbidity information, n/N', 'Presence of at least one comorbidity, n (%)'))

gtbl_general <- tbl_general %>%
  gather(characteristics, values, -covid_status, factor_key = TRUE) %>%
  spread(covid_status, values) %>%
  mutate(type_characteristic = case_when(
    characteristics ==  'total' ~ NA_character_,
    characteristics %in% vars_age$levels ~ 'Age (in years)',
    characteristics %in% vars_sex$levels ~ 'Sex',
    characteristics %in% vars_comorbidities$levels ~ 'Comorbidities')) %>%
  mutate(
    characteristics = factor(characteristics,
                             levels = c(vars_age$levels, vars_sex$levels, vars_comorbidities$levels),
                             labels = c(vars_age$labels, vars_sex$labels, vars_comorbidities$labels))) %>%
  gt(rowname_col = "characteristics",
     groupname_col = "type_characteristic") %>%
  cols_label(
    characteristics = 'Characteristics') %>%
  cols_align(
    align = 'left',
    columns = vars(characteristics)) %>%
  cols_align(
    align = 'center',
    columns = vars(Confirmed, Probable, Suspected, `Not a case`, `(Unknown)`)) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_general,
       file.path(path.local.msf.tables.oc, paste0('gtbl_general','_', week_report, '.png'))) %>%
  invisible()


gtsave(gtbl_general %>% 
         tab_header(
           title = paste('Characteristics of patients consulted in in an MSF supported Covid-19 health service by continent as of', format(date_max_report, "%d %B %Y"))), 
       file.path(path.local.msf.tables.oc, paste0('gtbl_general', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_general %>% 
  tab_header(
    title = paste('Characteristics of patients consulted/admitted by type of case as of', format(date_max_report, "%d %B %Y")))
```

### Age/sex pyramid by continent

<!-- Age/sex pyramid by continent -->

```{r pyramid-age-all-continent, fig.cap = 'Age pyramid of patients consulted/admitted to an MSF supported Covid-19 health service by continent', fig.width = 8, fig.height = 8}
# Done by Paul

missing_age_sex <- dta_linelist %>% 
  summarise(age = sum(is.na(age_in_years)), sex = sum(is.na(sex)))

tbl_pyramid_continent <- dta_linelist %>% 
  drop_na(sex, age_in_years) %>% 
  count(continent, sex, age_9gp) %>% 
  mutate(n = if_else(sex == "M", -n, n))

pyramid_age_sex_all_continent <- ggplot(tbl_pyramid_continent, aes(x = age_9gp, y = n, fill = sex)) +
  facet_wrap(~continent, ncol = 2, scales = "free_x") +
  geom_col() +
  geom_hline(yintercept = 0, colour = "black") +
  geom_text(aes(label = abs(n), hjust = if_else(n >= 0, 1.1, -0.1)), colour = "white", size = 3.5) +
  coord_flip() +
  scale_fill_manual(name = NULL, values = c("#4E79A7FF", "#A0CBE8FF"), breaks = c("M", "F"), labels = c("Males", "Females")) +
  scale_y_continuous(label = abs, limits = pyramid_limits) + 
  theme(legend.position = "top") +
  labs(x = "Age Group", y = "Patients consulted/admitted", caption = glue::glue("Missing Data: Age {missing_age_sex$age}, Sex {missing_age_sex$sex}")) 

ggsave(file.path(path.local.msf.graphs.oc, paste0('pyramid_age_sex_all_continent', '_', week_report, '.png')),
       plot = pyramid_age_sex_all_continent,
       width = 8,
       height = 8)


pyramid_age_sex_all_continent
```

### Comorbidities

```{r tbl-symtopms-tbl_comcond_status, layout = "l-page"}

dta_comcond <- prepare_msf_dta_comcond(dta_linelist)

dta_comcond <- dta_comcond %>% 
  select(-c(Comcond_other, Comcond_count, Comcond_01)) %>% 
  mutate(across(c(starts_with('Comcond_'),'hiv_status','hypertension', 'malaria', 'malnutrition', 'smoking', 'tb_active'), function(x){na_if(x,'Unknown')}))


tbl_comcond_status <- names(dta_comcond)[4:ncol(dta_comcond)] %>% 
  map_df(~{
    dta_comcond %>% 
      drop_na(any_of(.x)) %>% 
      tbl_prop(.x, 'covid_status', drop_levels = TRUE) %>% 
      rename('value'= .x) %>% 
      mutate(
        type_comorbidity = .x)
  }) %>% 
  filter(value == 'Yes') %>% 
  mutate(
    type_comorbidity = factor(type_comorbidity, levels = df_labels_comcond$levels, labels = df_labels_comcond$labels))


gtbl_comcond_status <- tbl_comcond_status %>% 
  gt() %>% 
  cols_hide('value') %>% 
  cols_move_to_start(columns = vars(type_comorbidity)) %>% 
  cols_label(
    type_comorbidity = "Comorbidities/Underlying conditions", 
    n_Confirmed    = 'n', 
    n_Probable     = 'n',
    n_Suspected    = 'n', 
    `n_Not a case` = 'n', 
    `n_(Unknown)`  = 'n', 
    n_Total        = 'n', 
    N_Confirmed    = 'N', 
    N_Probable     = 'N',
    N_Suspected    = 'N', 
    `N_Not a case` = 'N', 
    `N_(Unknown)`  = 'N', 
    N_Total        = 'N',
    p_Confirmed    = '(%)', 
    p_Probable     = '(%)', 
    p_Suspected    = '(%)', 
    `p_Not a case` = '(%)', 
    `p_(Unknown)`  = '(%)', 
    p_Total        = '(%)') %>% 
  cols_align(
    align = 'left', 
    columns = vars(type_comorbidity)) %>% 
  cols_align(
    align = 'right',
    columns = starts_with(c('n_', '.p_'))) %>%
  fmt_number(
    columns = starts_with('p_'), 
    decimals = 1, 
    scale_by = 100, 
    pattern = "({x})") %>% 
  fmt_missing(
    columns = starts_with(c('n_', 'p_')),
    missing_text = "---") %>%
  tab_spanner(
    label = 'Confirmed', 
    columns = ends_with('Confirmed')) %>% 
  tab_spanner(
    label = 'Probable', 
    columns = ends_with('Probable')) %>% 
  tab_spanner(
    label = 'Suspected', 
    columns = ends_with('Suspected')) %>% 
  tab_spanner(
    label = 'Not a case', 
    columns = ends_with('Not a case')) %>% 
  tab_spanner(
    label = 'Unknown', 
    columns = ends_with('(Unknown)')) %>% 
  tab_spanner(
    label = 'All', 
    columns = ends_with('Total')) %>% 
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = starts_with(c('n_', 'p_')))) %>%
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_comcond_status,
       file.path(path.local.msf.tables.oc, paste0('gtbl_comcond_status','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_comcond_status,
       file.path(path.local.msf.tables.oc, paste0('gtbl_comcond_status', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_comcond_status %>% 
  tab_header(
    title = paste('Frequency and proportion of comorbidities among patients an MSF supported Covid-19 health service by Covid status as of', format(date_max_report, '%d %B %Y')))
```

### Symptoms at consultation/admission

<!-- Table - Frequency and proportion of symptoms by Covid status -->

```{r tbl-symtopms-all, layout = "l-page"}
# DONE by Francesco

dta_sympt <- dta_linelist %>% 
  select(covid_status, tidyselect::vars_select(names(dta_linelist), starts_with('symptom_') & !ends_with('_date_onset')))

names_sympt <- grep('^symptom_', names(dta_sympt), perl = TRUE, value = TRUE) %>% sort()

names(names_sympt) <- names_sympt %>%
  gsub('^symptom_','', .) %>%
  gsub('_', ' ', .) %>%
  gsub('anosmia', 'loss of smell', .) %>%
  gsub('loss taste', 'loss of taste', .) %>%
  gsub('sorethoat', 'sorethroat', .) %>%
  stringr::str_to_sentence()

dta_sympt <- rename(dta_sympt, all_of(names_sympt))


tbl_sympt_status <- names(dta_sympt)[2:ncol(dta_sympt)] %>% 
  map_df(~{
    dta_sympt %>% 
      drop_na(any_of(.x)) %>% 
      tbl_prop(.x, 'covid_status', drop_levels = FALSE) %>% 
      rename('value'= .x) %>% 
      mutate(
        type_symptom = .x)
  }) %>% 
  filter(value == 'Yes')


gtbl_sympt_all <- tbl_sympt_status %>%
  gt() %>% 
  cols_hide('value') %>% 
  cols_move_to_start(columns = vars(type_symptom)) %>% 
  cols_label(
    type_symptom = 'Signes/Symptoms',
    n_Confirmed    = 'n',
    n_Probable     = 'n',
    n_Suspected    = 'n',
    `n_Not a case` = 'n',
    `n_(Unknown)`  = 'n',
    n_Total        = 'n',
    N_Confirmed    = 'N',
    N_Probable     = 'N',
    N_Suspected    = 'N',
    `N_Not a case` = 'N',
    `N_(Unknown)`  = 'N',
    N_Total        = 'N',
    p_Confirmed    = '(%)',
    p_Probable     = '(%)',
    p_Suspected    = '(%)',
    `p_Not a case` = '(%)',
    `p_(Unknown)`  = '(%)',  
    p_Total        = '(%)') %>%
  tab_spanner(
    label = "Confirmed",
    columns = ends_with('_Confirmed')) %>%
  tab_spanner(
    label = "Probable",
    columns = ends_with('_Probable')) %>%
  tab_spanner(
    label = "Suspected",
    columns = ends_with('_Suspected')) %>%
  tab_spanner(
    label = "Not a case",
    columns = ends_with('_Not a case')) %>%
  tab_spanner(
    label = "(Unknown)",
    columns = ends_with('_(Unknown)')) %>%
  tab_spanner(
    label = "Total",
    columns = ends_with('_Total')) %>%
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100,
    pattern = "({x})") %>%
  fmt_missing(
    columns = starts_with('p_'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(type_symptom)) %>%
  cols_align(
    align = 'right',
    columns = starts_with(c('n_', 'p_'))) %>%
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = starts_with(c('n_', 'p_')))) %>%
  cols_width(
    vars(type_symptom) ~ px(140),
    starts_with('n_') ~ px(55),
    starts_with("p_") ~ px(50)) %>%
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_sympt_all,
       file.path(path.local.msf.tables.oc, paste0('gtbl_sympt_all','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_sympt_all,
       file.path(path.local.msf.tables.oc, paste0('gtbl_sympt_all', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_sympt_all %>% 
  tab_header(
    title = paste('Frequency and proportion of symptoms among patients an MSF supported Covid-19 health service by Covid status as of', format(date_max_report, '%d %B %Y')))
```

### Severity by Covid status

<!-- Table - Frequency and proportion of patients wit severity -->

```{r}
# by Francesco

dta_severity <- dta_linelist %>% 
  select(covid_status, severity) %>% 
  mutate(
    severity = factor(severity, levels = c('Mild', 'Moderate', 'Severe', 'Critical'))
  )

tbl_severity_status <- dta_severity %>% 
  drop_na(severity) %>% 
  tbl_prop('severity', 'covid_status', drop_levels = FALSE)


gtbl_severity_status <- tbl_severity_status %>% 
  gt(rowname_col = "severity") %>% 
  cols_hide(
    columns = starts_with('N_', ignore.case = FALSE)) %>% 
  cols_label(
    severity = "Level of severity", 
    n_Confirmed    = 'n', 
    n_Probable     = 'n',
    n_Suspected    = 'n', 
    `n_Not a case` = 'n', 
    `n_(Unknown)`  = 'n', 
    n_Total        = 'n', 
    p_Confirmed    = '(%)', 
    p_Probable     = '(%)', 
    p_Suspected    = '(%)', 
    `p_Not a case` = '(%)', 
    `p_(Unknown)`  = '(%)', 
    p_Total        = '(%)') %>% 
  cols_align(
    align = 'left', 
    columns = vars(severity)) %>% 
  cols_align(
    align = 'right',
    columns = starts_with(c('n_', 'p_'))) %>%
  fmt_number(
    columns = starts_with('p_'), 
    decimals = 1, 
    scale_by = 100, 
    pattern = "({x})") %>% 
  fmt_missing(
    columns = starts_with(c('n_', 'p_')),
    missing_text = "---") %>%
  tab_spanner(
    label = 'Confirmed', 
    columns = ends_with('Confirmed')) %>% 
  tab_spanner(
    label = 'Probable', 
    columns = ends_with('Probable')) %>% 
  tab_spanner(
    label = 'Suspected', 
    columns = ends_with('Suspected')) %>% 
  tab_spanner(
    label = 'Not a case', 
    columns = ends_with('Not a case')) %>% 
  tab_spanner(
    label = 'Unknown', 
    columns = ends_with('(Unknown)')) %>% 
  tab_spanner(
    label = 'All', 
    columns = ends_with('Total')) %>% 
  summary_rows(
    groups = NULL,
    columns = starts_with('n_', ignore.case = FALSE),
    fns = list('Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
  #  tab_footnote(
  #    footnote = paste0("Missing values = ", sum(is.na(dta_severity$severity))),
  #    locations = cells_summary(
  #      groups = NULL, 
  #      columns = vars(severity), 
  #      rows = 1)) %>% 
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = starts_with(c('n_', 'p_')))) %>%
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_severity_status,
       file.path(path.local.msf.tables.oc, paste0('gtbl_severity_status','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_severity_status,
       file.path(path.local.msf.tables.oc, paste0('gtbl_severity_status', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_severity_status %>% 
  tab_header(
    title = paste('Frequency and proportion of level of severity among patients consulted at an MSF supported Covid-19 health service as of', format(date_max_report, '%d %B %Y')))
```

### Severity of confirmed cases by continent

```{r}
dta_severity_confirmed_continent <- dta_linelist %>% 
  select(continent, covid_status, severity) %>% 
  filter(covid_status == 'Confirmed') %>% 
  mutate(
    severity = factor(severity, levels = c('Mild', 'Moderate', 'Severe', 'Critical'))
  )


tbl_severity_confirmed_continent <- dta_severity_confirmed_continent %>% 
  drop_na(severity) %>% 
  tbl_prop('severity', 'continent', drop_levels = FALSE)

gtbl_severity_confirmed_continent <- tbl_severity_confirmed_continent %>% 
  gt(rowname_col = "severity") %>% 
  cols_hide(
    columns = starts_with('N_', ignore.case = FALSE)) %>% 
  cols_label(
    n_Africa   = 'n', 
    n_Americas = 'n',
    n_Asia     = 'n', 
    n_Europe   = 'n', 
    n_Total    = 'n', 
    p_Africa   = '(%)', 
    p_Americas = '(%)', 
    p_Asia     = '(%)', 
    p_Europe   = '(%)', 
    p_Total    = '(%)') %>% 
  fmt_number(
    columns = starts_with('p_'), 
    decimals = 1, 
    scale_by = 100, 
    pattern = "({x})") %>% 
  fmt_missing(
    columns = starts_with(c('n_', 'p_')),
    missing_text = "---") %>% 
  cols_align(
    align = 'right',
    columns = starts_with(c('n_', 'p_'))) %>%
  tab_spanner(
    label = 'Africa',
    columns = ends_with('_Africa')) %>% 
  tab_spanner(
    label = 'Americas',
    columns = ends_with('_Americas')) %>% 
  tab_spanner(
    label = 'Asia',
    columns = ends_with('_Asia')) %>% 
  tab_spanner(
    label = 'Europe',
    columns = ends_with('_Europe')) %>% 
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>% 
  summary_rows(
    groups = NULL,
    columns = starts_with('n_', ignore.case = FALSE),
    fns = list('Total' = ~ sum(.)),
    missing_text = "",
    formatter = fmt_number,
    decimals = 0) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_severity_confirmed_continent,
       file.path(path.local.msf.tables.oc, paste0('gtbl_severity_confirmed_continent','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_severity_confirmed_continent,
       file.path(path.local.msf.tables.oc, paste0('gtbl_severity_confirmed_continent', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_severity_confirmed_continent %>% 
  tab_header(
    title = paste('Frequency and proportion of level of severity among Covid confirmed patients consulted at an MSF supported Covid-19 health service as of', format(date_max_report, '%d %B %Y')))
```

### Case-fatality by Covid status

<!-- Table Case-fatality risk by Covid status and by continent -->

```{r tbl-cfr-status}
# DONE by Francesco

dta_cfr_status <- dta_linelist %>% 
  select(continent, covid_status, outcome_status) %>%
  filter(outcome_status %in% c('Cured', 'Died'))

tbl_cfr_status_continent <- levels(dta_cfr_status$covid_status) %>% 
  map_df(~{
    dta_cfr_status %>% 
      filter(covid_status == .x) %>% 
      tbl_prop('outcome_status', 'continent', drop_levels = FALSE) %>% 
      mutate(
        covid_status = .x)
  }) %>% 
  filter(outcome_status == 'Died') 


gtbl_cfr_status_continent <- tbl_cfr_status_continent %>%
  gt() %>% 
  cols_hide('outcome_status') %>% 
  cols_move_to_start(columns = vars(covid_status)) %>% 
  cols_label(
    covid_status = 'Covid status',
    n_Africa   = 'n', 
    n_Americas = 'n',
    n_Asia     = 'n', 
    n_Europe   = 'n', 
    n_Total    = 'n', 
    N_Africa   = 'N', 
    N_Americas = 'N',
    N_Asia     = 'N', 
    N_Europe   = 'N', 
    N_Total    = 'N', 
    p_Africa   = '(%)', 
    p_Americas = '(%)', 
    p_Asia     = '(%)', 
    p_Europe   = '(%)', 
    p_Total    = '(%)') %>% 
  tab_spanner(
    label = 'Africa',
    columns = ends_with('_Africa')) %>%
  tab_spanner(
    label = 'Americas',
    columns = ends_with('_Americas')) %>%
  tab_spanner(
    label = 'Asia',
    columns = ends_with('_Asia')) %>% 
  tab_spanner(
    label = 'Europe',
    columns = ends_with('_Europe')) %>%
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>%
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100,
    pattern = '({x})') %>%
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  fmt_missing(
    columns = starts_with('p_'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(covid_status)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('n_')) %>%
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_cfr_status_continent,
       file.path(path.local.msf.tables.oc, paste0('gtbl_cfr_status_continent','_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_cfr_status_continent,
       file.path(path.local.msf.tables.oc, paste0('gtbl_cfr_status_continent','_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_cfr_status_continent %>% 
  tab_header(
    title = 'Case-fatality risk by Covid status and continent among patients an MSF supported Covid-19 health service', 
    subtitle = 'In the denominator only patients with outcome as recovered or died'
  )


# CFR text
cfr_confirmed_probable_suspected <- dta_linelist %>%
  select(covid_status, outcome_status) %>% 
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>% 
  filter(outcome_status %in% c('Cured', 'Died'), ) %>% 
  summarise(cfr = mean(outcome_status == 'Died')) %>% 
  pull()
```

------------------------------------------------------------------------

# Covid-19 confirmed patients

### Weekly number of confirmed patients consulted/admitted

```{r, eval = FALSE}

dta_linelist_confirmed <- dta_linelist %>% 
  filter(covid_status == 'Confirmed')

tbl_epicurve_consultation_continent <- dta_linelist_confirmed %>%
  filter(merge_admit != "Unknown") %>% 
  count(continent, epi_week_consultation, merge_admit) %>%
  drop_na() %>%
  mutate(merge_admit = recode(merge_admit, "Yes" = "Admitted", "No" = "Not Admitted"))

tbl_admit_prop_continent <- dta_linelist_confirmed %>%
  filter(merge_admit != "Unknown") %>% 
  drop_na(epi_week_consultation) %>%
  group_by(continent, epi_week_consultation) %>%
  summarise(
    n = n(),
    total = sum(merge_admit %in% c("Yes", "No")),
    admitted = sum(merge_admit == "Yes"),
    admit_prop = admitted / total
  ) %>%
  ungroup()

n_max <- max(tbl_admit_prop_continent$n, na.rm = TRUE)
cfr_max <- rounder(max(tbl_admit_prop_continent$admit_prop, na.rm = TRUE), .1)
cfr_max <- ifelse(cfr_max > 1, 1, cfr_max)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

missing_consultation <- sum(is.na(dta_linelist_confirmed$epi_week_consultation))
missing_admission    <- sum(dta_linelist_confirmed$merge_admit == "Unknown")

hist_epicurve_consult_admit_confirmed_continent <- tbl_epicurve_consultation_continent %>% 
  ggplot(aes(epi_week_consultation, n)) +
  facet_wrap(~continent) +
  geom_col(aes(fill = merge_admit)) +
  geom_line(data = tbl_admit_prop_continent,
            aes(y = admit_prop / scaling_factor, colour = "Admitted %"),
            key_glyph = "timeseries", size = 0.5) +
  ggthemes::scale_fill_tableau(name = NULL, palette = "Tableau 20") +
  scale_x_date(name = "Week of Consultation", date_breaks = "3 week", date_labels = "%V", 
               sec.axis = ggplot2::sec_axis(trans = ~ .), expand = expansion(mult = c(0.01, 0.01))) +
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Admitted", labels = scales::percent_format(accuracy = 1)),
                     expand = expansion(mult = c(0, 0.02))) +
  labs(y = "Patients", colour = NULL, caption = glue::glue("Missing data: Consultation Date {missing_consultation}, Admission: {missing_admission}")) + 
  theme_light() + 
  theme(legend.position = "top", panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())

ggsave(file.path(path.local.msf.graphs.oc, paste0('hist_epicurve_consult_admit_confirmed_continent', '_', week_report, '.png')),
       plot = hist_epicurve_consult_admit_confirmed_continent,
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)


hist_epicurve_consult_admit_confirmed_continent
```

### Age and sex distribution of Covid confirmed patients

```{r gtbl-age-distribution-by-sex-confirmed-only}

dta_age_sex_confirmed <- dta_linelist %>% 
  select(covid_status, age_in_years, age_5gp, sex) %>% 
  filter(covid_status == 'Confirmed') %>% 
  drop_na() %>% 
  transform(sex = factor(sex, levels = c('F', 'M'), labels = c('Female', 'Male')))

tbl_age_distribution_by_sex_confirmed_only <- dta_age_sex_confirmed %>% 
  group_by(sex) %>% 
  summarise(
    age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)), 
    age_mean    = round(mean(age_in_years, na.rm = TRUE), digits = 1), 
    age_median  = round(median(age_in_years, na.rm = TRUE), digits = 1)) %>% 
  add_row(
    dta_age_sex_confirmed %>% 
      summarise(
        sex = 'All', 
        age_min_max = paste0(min(age_in_years, na.rm = TRUE), ' - ', max(age_in_years, na.rm = TRUE)), 
        age_mean    = round(mean(age_in_years, na.rm = TRUE), digits = 1), 
        age_median  = round(median(age_in_years, na.rm = TRUE), digits = 1)))

gtbl_age_distribution_by_sex_confirmed_only <- tbl_age_distribution_by_sex_confirmed_only %>% 
  gt() %>% 
  cols_label(
    sex = 'Sex', 
    age_min_max = 'Min-Max', 
    age_mean = 'Mean', 
    age_median = 'Median') %>% 
  tab_header(
    title = 'Covid-confirmed patients consulted/admitted')

gtbl_age_distribution_by_sex_confirmed_only

```

<!-- Age/sex pyramid -->

```{r pyramid-age-sex-confirmed, fig.cap = 'Age pyramid of Covid-confirmed patients consulted/admitted to an MSF supported health service', fig.width = 8, fig.height = 8}
# Done by Paul

missing_age_sex <- dta_linelist %>% filter(covid_status == "Confirmed") %>% summarise(age = sum(is.na(age_in_years)), sex = sum(is.na(sex)))

tbl_pyramid_confirmed <- dta_linelist %>% 
  drop_na(sex, age_in_years) %>% 
  filter(covid_status %in% c("Confirmed")) %>% 
  count(sex, age_9gp) %>% 
  mutate(n = if_else(sex == "M", -n, n))

pyramid_age_sex_confirmed <- ggplot(tbl_pyramid_confirmed, aes(x = age_9gp, y = n, fill = sex)) +
  geom_col() +
  geom_hline(yintercept = 0, colour = "black") +
  #geom_text(aes(label = abs(n), hjust = if_else(n >= 0, 1.1, -0.1)), colour = "white", size = 4) +
  coord_flip() +
  scale_fill_manual(name = NULL, values = c("#4E79A7FF", "#A0CBE8FF"), breaks = c("M", "F"), labels = c("Males", "Females")) +
  scale_y_continuous(limits = pyramid_limits, breaks = pyramid_brks, label = abs) + 
  theme(legend.position = "top") +
  labs(x = "Age Group", y = "Confirmed Patients", caption = glue::glue("Missing Data: Age {missing_age_sex$age}, Sex {missing_age_sex$sex}"))  +
  guides(y.sec = guide_axis_label_trans(~paste(.x))) # show age group labels on both axis

ggsave(file.path(path.local.msf.graphs.oc, paste0('pyramid_age_sex_confirmed', '_', week_report, '.png')),
       plot = pyramid_age_sex_confirmed,
       width = 8,
       height = 6)


pyramid_age_sex_confirmed

```

### Age and sex distribution of Covid confirmed patients by continent

<!-- Age/sex pyramid by continent -->

```{r pyramid-age-sex-confirmed-continent, fig.cap = 'Age pyramid of patients consulted/admitted to an MSF supported Covid-19 health service by continent', fig.width = 8, fig.height = 8}
# Done by Paul

missing_age_sex <- dta_linelist %>% filter(covid_status == "Confirmed") %>% summarise(age = sum(is.na(age_in_years)), sex = sum(is.na(sex)))

tbl_pyramid_confirmed_continent <- dta_linelist %>% 
  drop_na(sex, age_in_years) %>% 
  filter(covid_status %in% c("Confirmed")) %>% 
  count(continent, sex, age_9gp) %>% 
  mutate(n = if_else(sex == "M", -n, n))

pyramid_age_sex_confirmed_continent <- ggplot(tbl_pyramid_confirmed_continent, aes(x = age_9gp, y = n, fill = sex)) +
  facet_wrap(~continent, ncol = 2, scales = "free_x") +
  geom_col() +
  geom_hline(yintercept = 0, colour = "black") +
  geom_text(aes(label = abs(n), hjust = if_else(n >= 0, 1.1, -0.1)), colour = "white", size = 3.5) +
  coord_flip() +
  scale_fill_manual(name = NULL, values = c("#4E79A7FF", "#A0CBE8FF"), breaks = c("M", "F"), labels = c("Males", "Females")) +
  scale_y_continuous(label = abs, limits = pyramid_limits) + 
  theme(legend.position = "top") +
  labs(x = "Age Group", y = "Confirmed Patients", caption = glue::glue("Missing Data: Age {missing_age_sex$age}, Sex {missing_age_sex$sex}")) 

ggsave(file.path(path.local.msf.graphs.oc, paste0('pyramid_age_sex_confirmed_continent', '_', week_report, '.png')),
       plot = pyramid_age_sex_confirmed_continent,
       width = 8,
       height = 8)


pyramid_age_sex_confirmed_continent
```

### Patients care

```{=html}
<!-- 
Table Patient’s care 1
- Admitted to a hospital/inpatient department,
- received oxygen,
- admitted to ICU,
- supported with ventilator,
- supported with ECMO
-->
```
```{r tbl-care-procedures}
# DONE by Francesco

dta_care <- dta_linelist %>% 
  filter(covid_status %in% c('Confirmed')) %>%
  select(continent, country, starts_with('merge_'))

# # Correct error on ECMO
# dta_care <- dta_care %>%
#   mutate(
#     merge_ecmo = as.character(merge_ecmo),
#     merge_ecmo = case_when(
#       merge_ecmo == "Yes" ~ "No at any time",
#       TRUE ~ merge_ecmo)) %>% 
#   mutate(merge_ecmo = factor(merge_ecmo, levels = c('Yes', 'No at admission then not reported', 'No at any time', 'Not reported')))


tbl_care_admitted <- tbl_prop(dta_care, 'merge_admit', 'continent') %>% 
  mutate(name_var = 'Admitted')

tbl_care_oxygen <- tbl_prop(dta_care, 'merge_oxygen', 'continent') %>% 
  mutate(name_var = 'Received oxygen')

tbl_care_icu <- tbl_prop(dta_care, 'merge_icu', 'continent') %>% 
  mutate(name_var = 'Admitted to the Intensive Care Unit')

tbl_care_vent <- tbl_prop(dta_care, 'merge_vent', 'continent') %>% 
  mutate(name_var = 'Supported by a ventilator')

#tbl_care_ecmo <- tbl_prop(dta_care, 'merge_ecmo', 'continent') %>% 
#  drop_na(merge_ecmo) %>% 
#  mutate(name_var = 'Supported by extracorporeal membrane oxygenation (ECMO)')


tbl_care <- tbl_care_admitted %>% rename(values_var = merge_admit) %>% 
  add_row(tbl_care_oxygen %>% rename(values_var = merge_oxygen)) %>% 
  add_row(tbl_care_icu %>% rename(values_var = merge_icu)) %>%
  add_row(tbl_care_vent %>% rename(values_var = merge_vent))
#  add_row(tbl_care_ecmo %>% rename(values_var = merge_ecmo))


gtbl_care <- tbl_care %>% 
  gt(rowname_col = "values_var",
     groupname_col = "name_var") %>% 
  cols_hide(
    columns = starts_with('N_', ignore.case = FALSE)) %>% 
  cols_label(
    n_Africa   = 'n', 
    n_Americas = 'n',
    n_Asia     = 'n', 
    n_Europe   = 'n', 
    n_Total    = 'n', 
    p_Africa   = '(%)', 
    p_Americas = '(%)', 
    p_Asia     = '(%)', 
    p_Europe   = '(%)', 
    p_Total    = '(%)') %>% 
  fmt_number(
    columns = starts_with('p_'), 
    decimals = 1, 
    scale_by = 100, 
    pattern = "({x})") %>% 
  tab_spanner(
    label = 'Africa',
    columns = ends_with('_Africa')) %>% 
  tab_spanner(
    label = 'Americas',
    columns = ends_with('_Americas')) %>% 
  tab_spanner(
    label = 'Asia',
    columns = ends_with('_Asia')) %>% 
  tab_spanner(
    label = 'Europe',
    columns = ends_with('_Europe')) %>% 
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>% 
  tab_options(
    column_labels.font.weight = "bold",
    row_group.font.weight = 'bold',
    data_row.padding = px(2),
    row_group.padding = px(2))

gtsave(gtbl_care,
       file.path(path.local.msf.tables.oc, paste0('gtbl_care', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_care,
       file.path(path.local.msf.tables.oc, paste0('gtbl_care', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_care %>% 
  tab_header(
    title = "Major care procedures to Covid confirmed patient's in MSF heatlth facilities, by location")
```

### Age and sex of patients by outcome

```{r tbl-age-sex-outcome}
# DONE by Francesco

dta_age_sex_outcome <- dta_linelist %>% 
  select(site_name, covid_status, outcome_status, sex = sex, age_in_years) %>% 
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) 

tbl_age_sex_outcome <- dta_age_sex_outcome %>% 
  group_by(outcome_status) %>% 
  summarise(
    age_median = median(age_in_years, na.rm = TRUE), 
    age__prcl  = glue('[{quantile(age_in_years, na.rm = TRUE)[[2]]} - {quantile(age_in_years, na.rm = TRUE)[[4]]}]'), 
    age_range  = glue('[{min(age_in_years, na.rm = TRUE)} - {max(age_in_years, na.rm = TRUE)}]'), 
    sex_males   = sum(sex == 'M', na.rm = TRUE),
    sex_females = sum(sex == 'F', na.rm = TRUE), 
    sex_ratio   = sex_males/sex_females)

tbl_age_sex_outcome$sex_ratio[is.infinite(tbl_age_sex_outcome$sex_ratio)] <- NA

gtbl_age_sex_outcome <- tbl_age_sex_outcome %>% 
  gt() %>% 
  cols_label(
    outcome_status = 'Status',
    age_median = 'Median', 
    age__prcl = '[25% - 75%]', 
    age_range = '[min - max]', 
    sex_males = 'Males', 
    sex_females = 'Females', 
    sex_ratio = 'M/F ratio') %>% 
  fmt_number(
    columns = vars(sex_ratio), 
    decimals = 1) %>% 
  fmt_missing(
    columns = vars(sex_ratio), 
    missing_text = '---') %>% 
  tab_spanner(
    label = 'Age (years)', 
    columns = starts_with('age_')) %>% 
  tab_spanner(
    label = 'Sex', 
    columns = starts_with('sex_')) %>% 
  cols_align(
    align = 'left', 
    columns = vars(outcome_status)) %>% 
  cols_align(
    align = 'right', 
    columns = starts_with('sex_')) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    data_row.padding = px(2))

gtsave(gtbl_age_sex_outcome, 
       file.path(path.local.msf.tables.oc, paste0('gtbl_age_sex_outcome', '_', week_report, '.png'))) %>% 
  invisible()

gtsave(gtbl_age_sex_outcome, 
       file.path(path.local.msf.tables.oc, paste0('gtbl_age_sex_outcome', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_age_sex_outcome %>% 
  tab_header(
    title = 'Age and sex ditribution by type of patient outcome among confirmed, probable and suspected Covid cases')
```

### Case fatality by age, sex and number of comorbidities

<!-- CFR by age, sex and number of comorbidities -->

```{r tbl-cfr-age-sex-comorbidities}
# DONE by Francesco
# function tbl_prop in utils_vis.R

dta_cfr_age <- dta_linelist %>% 
  mutate(age_5gp = fct_explicit_na(age_5gp)) 

tbl_cfr_age <- levels(dta_cfr_age$age_5gp) %>% 
  map_df(~{
    dta_cfr_age %>% 
      filter(age_5gp == .x) %>% 
      tbl_prop('outcome_status', 'continent', drop_levels = FALSE) %>% 
      mutate(
        age_5gp = .x)
  }) %>% 
  filter(outcome_status == 'Died') 


dta_cfr_sex <- dta_linelist %>% 
  mutate(sex = factor(sex, levels = c('F', 'M'), labels = c('Females', 'Males'))) %>% 
  mutate(sex = fct_explicit_na(sex)) 

tbl_cfr_sex <- levels(dta_cfr_sex$sex) %>% 
  map_df(~{
    dta_cfr_sex %>% 
      filter(sex == .x) %>% 
      tbl_prop('outcome_status', 'continent', drop_levels = FALSE) %>% 
      mutate(
        sex = .x)
  }) %>% 
  filter(outcome_status == 'Died') 

dta_cfr_comorbidities <- dta_linelist %>% 
  mutate(Comcond_count = as.factor(Comcond_count)) %>% 
  mutate(Comcond_count = fct_explicit_na(Comcond_count)) 

tbl_cfr_comorbidities <- levels(dta_cfr_comorbidities$Comcond_count) %>% 
  map_df(~{
    dta_cfr_comorbidities %>% 
      filter(Comcond_count == .x) %>% 
      tbl_prop('outcome_status', 'continent', drop_levels = FALSE) %>% 
      mutate(
        Comcond_count = .x)
  }) %>% 
  filter(outcome_status == 'Died') %>% 
  arrange(Comcond_count)


tbl_cfr_age_sex_comorbidities <- tbl_cfr_age %>% 
  rename(var = age_5gp) %>% 
  mutate(label_var = 'Age (years)') %>% 
  add_row(tbl_cfr_sex %>% 
            rename(var = sex) %>% 
            mutate(label_var = 'Sex')) %>% 
  add_row(tbl_cfr_comorbidities %>% 
            rename(var = Comcond_count) %>% 
            mutate(label_var = 'Number of comorbidities'))

gtbl_cfr_age_sex_comorbidities <- tbl_cfr_age_sex_comorbidities %>% 
  gt(rowname_col = "var", 
     groupname_col = "label_var") %>% 
  cols_hide(
    columns = vars('outcome_status')) %>% 
  cols_label(
    n_Africa   = 'n', 
    n_Americas = 'n', 
    n_Asia     = 'n', 
    n_Europe   = 'n', 
    n_Total    = 'n', 
    N_Africa   = 'N', 
    N_Americas = 'N', 
    N_Asia     = 'N', 
    N_Europe   = 'N', 
    N_Total    = 'N', 
    p_Africa   = '(%)', 
    p_Americas = '(%)', 
    p_Asia     = '(%)', 
    p_Europe   = '(%)', 
    p_Total    = '(%)') %>%
  tab_spanner(
    label = 'Africa',
    columns = ends_with('_Africa')) %>%
  tab_spanner(
    label = 'Americas',
    columns = ends_with('_Americas')) %>%
  tab_spanner(
    label = 'Asia',
    columns = ends_with('_Asia')) %>% 
  tab_spanner(
    label = 'Europe',
    columns = ends_with('_Europe')) %>%
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>%
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100,
    pattern = '({x})') %>%
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  fmt_missing(
    columns = starts_with('p_'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(var)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('n_')) %>%
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2))

gtsave(gtbl_cfr_age_sex_comorbidities, 
       file.path(path.local.msf.tables.oc, paste0('gtbl_cfr_age_sex_comorbidities', '_', week_report, '.png'))) %>% 
  invisible()

gtsave(gtbl_cfr_age_sex_comorbidities, 
       file.path(path.local.msf.tables.oc, paste0('gtbl_cfr_age_sex_comorbidities', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_cfr_age_sex_comorbidities %>% 
  tab_header(
    title = 'Case fatality risk by age, sex and number of comorbidities'
  )


# Numbers for editing report
cfr_confirmed_no_comorbidities <- tbl_cfr_comorbidities %>% 
  filter(Comcond_count == 0) %>% 
  pull(p_Total)

cfr_confirmed_3_comorbidities <- tbl_cfr_comorbidities %>% 
  filter(Comcond_count == 3) %>% 
  pull(p_Total)

```

```{=html}
<!-- 
Table Outcome 2 - Count of cured, deaths, transferred… by Admitted/Not Admitted
This table is NOT displayed any more 
-->
```
```{r, eval = FALSE}
# DONE by Francesco

dta_outcome_admission <- dta_linelist %>%
  select(covid_status, merge_admit, tidyselect::vars_select(names(dta_linelist), starts_with('outcome_')))

tbl_outcome_admission <- dta_outcome_admission %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  count(merge_admit, outcome_status, .drop = FALSE) %>%
  pivot_wider(names_from = merge_admit, values_from = n, values_fill = list(n = 0)) %>%
  adorn_totals('col') %>%
  mutate(
    prct_yes = round(Yes / sum(Yes) * 100, 1),
    prct_no  = round(No / sum(No) * 100, 1),
    prct_ukn = round(`(Unknown)` / sum(`(Unknown)`) * 100, 1),
    prct_tot = round(Total / sum(Total) * 100, 1)) %>%
  adorn_totals('row')

gtbl_outcome_admission <- tbl_outcome_admission %>%
  gt() %>%
  cols_label(
    outcome_status = 'Status',
    Yes     = 'N',
    No      = 'N',
    `(Unknown)` = 'N',
    Total   = 'N',
    prct_yes = '(%)',
    prct_no  = '(%)',
    prct_ukn = '(%)',
    prct_tot = '(%)') %>%
  tab_spanner(
    label = "Admitted",
    columns = vars(Yes, prct_yes)) %>%
  tab_spanner(
    label = "Non admitted",
    columns = vars(No, prct_no)) %>%
  tab_spanner(
    label = "Unknown",
    columns = vars(`(Unknown)`, prct_ukn)) %>%
  tab_spanner(
    label = "Total",
    columns = vars(Total, prct_tot)) %>%
  fmt_missing(
    columns = starts_with('prct_'),
    missing_text = "--") %>%
  text_transform(
    locations = cells_body(
      columns = starts_with('prct_')),
    fn = function(x) {
      x = paste0('(',x,')')}) %>%
  text_transform(
    locations = cells_body(
      columns = starts_with('prct_'),
      rows = outcome_status == 'Total'),
    fn = function(x) {
      x = '---'}) %>%
  cols_align(
    align = 'right',
    columns = vars(Yes, No, `(Unknown)`, Total)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('prct_')) %>%
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = vars(Yes, No, `(Unknown)`, Total))) %>%
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(columns = starts_with('prct_'))) %>%
  cols_width(
    vars(outcome_status) ~ px(210),
    vars(Yes, No, `(Unknown)` , Total) ~ px(70),
    starts_with("prct_") ~ px(50)) %>%
  tab_options(
    column_labels.font.weight = "bold",
    data_row.padding = px(2))

gtsave(gtbl_outcome_admission,
       file.path(path.local.msf.tables.oc, paste0('gtbl_outcome_admission', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_outcome_admission,
       file.path(path.local.msf.tables.oc, paste0('gtbl_outcome_admission', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_outcome_admission %>% 
  tab_header(
    title = 'Count of patients outcome by Admitted/Not Admitted'
  )

```


### Case fatality by level of care received


```{r tbl-cfr-status-hospi-icu-oxy-venti}
dta_cfr_status_hospi_icu <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  filter(outcome_status %in% c('Cured', 'Died')) %>% 
  # filter(merge_admit != "(Unknown)") %>% 
  select(covid_status, merge_admit, outcome_status, merge_icu, merge_oxygen,
         merge_vent) %>%
  mutate(merge_admit = recode(merge_admit, "Yes" = "Admitted", "No" = "Not Admitted"))


# Hospi
dta_cfr_status_hospi <- unique(dta_cfr_status_hospi_icu$merge_admit) %>% 
  map_df(~{
    dta_cfr_status_hospi_icu %>% 
      filter(merge_admit == .x) %>% 
      tbl_prop('outcome_status', 'covid_status', drop_levels = FALSE) %>% 
      mutate(
        merge_admit = .x)
  })  %>% 
  filter(outcome_status == 'Died') 

# ICU
dta_cfr_status_icu <- unique(dta_cfr_status_hospi_icu$merge_icu) %>% 
  map_df(~{
    dta_cfr_status_hospi_icu %>% 
      filter(merge_icu == .x) %>% 
      tbl_prop('outcome_status', 'covid_status', drop_levels = FALSE) %>% 
      mutate(
        merge_icu = .x)
  })  %>% 
  filter(outcome_status == 'Died') 


# O2
dta_cfr_status_o2 <- unique(dta_cfr_status_hospi_icu$merge_oxygen) %>% 
  map_df(~{
    dta_cfr_status_hospi_icu %>% 
      filter(merge_oxygen == .x) %>% 
      tbl_prop('outcome_status', 'covid_status', drop_levels = FALSE) %>% 
      mutate(
        merge_oxygen = .x)
  })  %>% 
  filter(outcome_status == 'Died')


# Ventilation
dta_cfr_status_ventilation <- unique(dta_cfr_status_hospi_icu$merge_vent) %>% 
  map_df(~{
    dta_cfr_status_hospi_icu %>% 
      filter(merge_vent == .x) %>% 
      tbl_prop('outcome_status', 'covid_status', drop_levels = FALSE) %>% 
      mutate(
        merge_vent = .x)
  })  %>% 
  filter(outcome_status == 'Died')



tbl_cfr_status_hospi_icu_oxy <- dta_cfr_status_hospi %>% 
  rename(var = merge_admit) %>% 
  mutate(label_var = 'Admission status') %>%
  
  add_row(dta_cfr_status_icu %>% 
            rename(var = merge_icu) %>% 
            mutate(label_var = 'ICU')) %>% 
  
  add_row(dta_cfr_status_o2 %>% 
            rename(var = merge_oxygen) %>% 
            mutate(label_var = 'Oxygen')) %>% 
  
  add_row(dta_cfr_status_ventilation %>% 
            rename(var = merge_vent) %>% 
            mutate(label_var = 'Non invasive ventilation'))



gtbl_cfr_status_hospi_icu_oxy_venti <- tbl_cfr_status_hospi_icu_oxy %>% 
  gt(rowname_col = "var", 
     groupname_col = "label_var") %>% 
  cols_hide(
    columns = vars('outcome_status', 'n_Not a case', 'n_(Unknown)', 
                   'N_Not a case', 'N_(Unknown)', 'p_Not a case', 'p_(Unknown)')) %>% 
  cols_label(
    n_Confirmed = 'n', 
    n_Probable  = 'n', 
    n_Suspected = 'n', 
    n_Total     = 'n', 
    
    N_Confirmed = 'N', 
    N_Probable  = 'N', 
    N_Suspected = 'N', 
    N_Total     = 'N', 
    
    p_Confirmed = '(%)', 
    p_Probable  = '(%)', 
    p_Suspected = '(%)',
    p_Total     = '(%)') %>%
  
  tab_spanner(
    label = 'Confirmed',
    columns = ends_with('_Confirmed')) %>%
  tab_spanner(
    label = 'Probable',
    columns = ends_with('_Probable')) %>%
  tab_spanner(
    label = 'Suspected',
    columns = ends_with('_Suspected')) %>% 
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>% 
  
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100,
    pattern = '({x})') %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  fmt_missing(
    columns = starts_with('p_'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(var)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('n_')) %>%
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2))


gtsave(gtbl_cfr_status_hospi_icu_oxy_venti, 
       file.path(path.local.msf.tables.oc, paste0('gtbl_cfr_status_hospi_icu_oxy_venti', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtbl_cfr_status_hospi_icu_oxy_venti %>% 
  tab_header(
    title = 'Case fatality risk by status, admission and ICU ')
```

### Case fatality by type of comorbidity

<!-- CFR by type of comorbidity among confirmed patients -->

```{r tbl-cfr-type-comorbidity}
# DONE by Francesco

dta_cfr_comcond <- prepare_msf_dta_comcond(dta_linelist) %>% 
  mutate(
    Comcond_other = case_when(
      !is.na(Comcond_other) ~ 'Yes', 
      TRUE ~ NA_character_)) %>% 
  filter(covid_status == 'Confirmed', outcome_status %in% c('Cured', 'Died')) %>% 
  pivot_longer(-c(covid_status, outcome_status, continent, Comcond_count, Comcond_01), names_to = "type_comorbidity") %>%
  mutate(
    type_comorbidity = factor(type_comorbidity, levels = df_labels_comcond$levels, labels = df_labels_comcond$labels)) %>% 
  filter(!is.na(value), value == 'Yes')

tbl_cfr_type_comcond <- levels(dta_cfr_comcond$type_comorbidity) %>% 
  map_df(~{
    dta_cfr_comcond %>% 
      filter(type_comorbidity == .x) %>% 
      tbl_prop('outcome_status', 'continent', drop_levels = FALSE) %>% 
      mutate(
        type_comorbidity = .x)
  }) %>% 
  filter(outcome_status == 'Died') %>% 
  arrange(desc(p_Total))

gtbl_cfr_type_comcond <- tbl_cfr_type_comcond %>%
  gt() %>% 
  cols_hide('outcome_status') %>% 
  cols_move_to_start(columns = vars(type_comorbidity)) %>% 
  cols_label(
    type_comorbidity = "Comorbidities/Underlying conditions", 
    n_Africa   = 'n', 
    n_Americas = 'n',
    n_Asia     = 'n', 
    n_Europe   = 'n', 
    n_Total    = 'n', 
    N_Africa   = 'N', 
    N_Americas = 'N',
    N_Asia     = 'N', 
    N_Europe   = 'N', 
    N_Total    = 'N', 
    p_Africa   = '(%)', 
    p_Americas = '(%)', 
    p_Asia     = '(%)', 
    p_Europe   = '(%)', 
    p_Total    = '(%)')  %>%
  tab_spanner(
    label = 'Africa',
    columns = ends_with('_Africa')) %>%
  tab_spanner(
    label = 'Americas',
    columns = ends_with('_Americas')) %>%
  tab_spanner(
    label = 'Asia',
    columns = ends_with('_Asia')) %>% 
  tab_spanner(
    label = 'Europe',
    columns = ends_with('_Europe')) %>% 
  tab_spanner(
    label = 'Total',
    columns = ends_with('_Total')) %>%
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100,
    pattern = '({x})') %>%
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0/0") %>%
  fmt_missing(
    columns = starts_with('p_'),
    missing_text = "---") %>%
  cols_align(
    align = 'left',
    columns = vars(type_comorbidity)) %>%
  cols_align(
    align = 'right',
    columns = starts_with('n_')) %>%
  tab_options(
    column_labels.font.weight = "bold", 
    data_row.padding = px(2),
    row_group.padding = px(2))


gtsave(gtbl_cfr_type_comcond,
       file.path(path.local.msf.tables.oc, paste0('gtbl_cfr_type_comcond', '_', week_report, '.png'))) %>%
  invisible()

#gtsave(gtbl_cfr_type_comcond,
#       file.path(path.local.msf.tables, paste0('gtbl_cfr_type_comcond', '_', week_report, '.html')),
#       inline_css = TRUE) %>%
#  invisible()


gtbl_cfr_type_comcond %>% 
  tab_header(
    title = 'Case fatality risk by type of comorbidities among confirmed patients'
  )
```

<!-- CFR by age-group -->

```{r tbl-cfr-agegroup, fig.cap = 'Case fatality risk by age-group among confirmed patients'}
age_cut <- c(seq(0, 80, 10), Inf)
age_labs <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

df_severity <- dta_linelist %>% 
  mutate(age_group = cut(age_in_years, breaks = age_cut, labels = age_labs, right = FALSE, include.lowest = TRUE)) %>% 
  filter(!is.na(age_group), covid_status == "Confirmed") %>% 
  group_by(age_group) %>% 
  summarize(
    n = n(),
    n_hosp = sum(admit == "Yes", na.rm = TRUE),
    n_hosp_known = sum(admit %in% c("Yes", "No"), na.rm = TRUE),
    p_hosp = n_hosp / n_hosp_known,
    p_hosp_low95 = as.numeric(binom.test(n_hosp, n_hosp_known)$conf.int)[1],
    p_hosp_upp95 = as.numeric(binom.test(n_hosp, n_hosp_known)$conf.int)[2],
    n_died = sum(outcome_status == "Died", na.rm = TRUE),
    n_died_known = sum(outcome_status %in% c("Died", "Cured"), na.rm = TRUE),
    p_died_low95 = as.numeric(binom.test(n_died, n_died_known)$conf.int)[1],
    p_died_upp95 = as.numeric(binom.test(n_died, n_died_known)$conf.int)[2],
    p_died = n_died / n_died_known,
    # hosp_lab = paste0("(", n_hosp_known, ")"),
    # died_lab = paste0("(", n_died_known, ")"),
    hosp_lab = paste0("(", n_hosp, "/", n_hosp_known, ")"),
    died_lab = paste0("(", n_died, "/", n_died_known, ")")
  ) %>% 
  ungroup()

# p1 <- ggplot(severity, aes(x = age_group)) +
#   geom_point(aes(y = p_hosp)) +
#   geom_linerange(aes(ymin = p_hosp_low95, ymax = p_hosp_upp95)) +
#   geom_text(aes(label = hosp_lab, y = p_hosp_upp95 + 0.06), size = 4.2) +
#   scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2), labels = scales::percent_format(accuracy = 1)) +
#   labs(x = NULL, y = "Hospitalisés")

dots_cfr_agegroup <- ggplot(df_severity, aes(x = age_group)) +
  geom_point(aes(y = p_died), size = 2) +
  geom_linerange(aes(ymin = p_died_low95, ymax = p_died_upp95)) +
  geom_text(aes(label = died_lab, y = p_died_upp95 + 0.02), size = 4.2) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0, 1), labels = scales::percent_format(accuracy = 1), sec.axis = dup_axis(name = NULL)) +  
  labs(x = "Age Group", y = "CFR", caption = "CFR = deaths / known outcomes (cured + died)\nLine range shows binomial 95% confidence intervals") 

ggsave(file.path(path.local.msf.graphs.oc, paste0('dots_cfr_agegroup', '_', week_report, '.png')),
       plot = dots_cfr_agegroup,
       scale = 1.1,
       dpi = 320)


dots_cfr_agegroup
```

------------------------------------------------------------------------

# Indicators overtime among Covid19 confirmed cases

### Weekly case fatality risk

```{=html}
<!--
**With all confirmed cases as denominator: time-series and trends plot** with week as time unit of the following indicator:

Time-series plot:
- Proportion of admitted over the confirmed - line
- Proportion of patients with severe symptoms - line
- Delay from symptoms onset to consultation/admission - boxplot
- Length of staying for patients hospitalised - boxplot
- Case fatality risk for patients hospitalised - line
-->
```
<!-- CFR by week overall -->

```{r line-cfr-week, fig.cap = 'Evolution overtime of the case fatality risk among Covid confirmed patients consulted/admitted to an MSF supported health facility'}
# DONE by Paul
# Only including outcomes of cured or died as CFR denominator - is this ok? FG: Yes

# 2 most recent epi weeks to remove from chart
latest_2_epiweeks <- max_2(dta_linelist$epi_week_consultation)

tbl_cfr_epiweek_prop <- dta_linelist %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epiweeks
  ) %>%
  drop_na(epi_week_consultation) %>%
  group_by(epi_week_consultation) %>%
  summarise(
    total = sum(!is.na(outcome_status)),
    dead = sum(outcome_status == "Died", na.rm = T),
    prop_dead = (dead / total) #* 100
  ) %>%
  ungroup()

tbl_cfr_epiweek <- dta_linelist %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epiweeks
  ) %>%
  count(epi_week_consultation, outcome_status) %>%
  drop_na() %>%
  ungroup()

n_max <- max(tbl_cfr_epiweek_prop$total, na.rm = TRUE)
cfr_max <- rounder(max(tbl_cfr_epiweek_prop$prop_dead, na.rm = TRUE), .1)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

line_cfr_week <- ggplot(tbl_cfr_epiweek, aes(epi_week_consultation, n)) +
  geom_col(aes(fill = outcome_status)) +
  geom_line(data = tbl_cfr_epiweek_prop,
            aes(y = prop_dead / scaling_factor, colour = "CFR"),
            key_glyph = "timeseries", size = 1) +
  scale_x_date(name = "Week of Admission", date_breaks = "2 weeks", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .),
               expand = expansion(mult = c(0.01, 0.01))) + #, labels = function(x) format(x, "%b-%Y")
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Case Fatality Risk", labels = scales::percent_format(accuracy = 1)),
                     expand = expansion(mult = c(0, 0.02))) +
  ggthemes::scale_fill_tableau(palette = "Tableau 20") +
  labs(y = "Patients", colour = NULL, fill = "Outcome", caption = "Latest 2 weeks omitted for data completeness purposes") +
  theme(legend.position = "top", panel.grid.minor = element_blank())

ggsave(file.path(path.local.msf.graphs.oc, paste0('line_cfr_week', '_', week_report, '.png')),
       plot = line_cfr_week, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

line_cfr_week

```

<!-- CFR by week and by continent -->

```{r line-cfr-week-continent, fig.cap = 'Evolution overtime of the case fatality risk among Covid confirmed patients consulted/admitted to an MSF supported health facility, separated by continent', fig.width = 8, fig.height = 8}
# DONE by Paul
# Only including outcomes of cured or died as CFR denominator - is this ok? FG: Yes

# 2 most recent epi-weeks to remove from chart
latest_2_epiweeks <- max_2(dta_linelist$epi_week_consultation)

tbl_cfr_epiweek_continent_prop <- dta_linelist %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epiweeks
  ) %>%
  group_by(continent, epi_week_consultation) %>%
  summarise(
    total = sum(!is.na(outcome_status)),
    dead = sum(outcome_status == "Died", na.rm = T),
    prop_dead = (dead / total) #* 100
  ) %>%
  ungroup()

tbl_cfr_epiweek_continent <- dta_linelist %>%
  filter(
    covid_status %in% c("Confirmed", "Suspected", "Probable"),
    outcome_status %in% c("Cured", "Died"),
    !epi_week_consultation %in% latest_2_epiweeks
  ) %>%
  count(continent, epi_week_consultation, outcome_status) %>%
  drop_na()

n_max <- max(tbl_cfr_epiweek_continent_prop$total, na.rm = TRUE)
cfr_max <- rounder(max(tbl_cfr_epiweek_continent_prop$prop_dead, na.rm = TRUE), .1)
cfr_max <- ifelse(cfr_max > 1, 1, cfr_max)
scaling_factor <- cfr_max / n_max # sets the y limit of CFR rounded up to nearest 10% above cfr max

line_cfr_week_continent <- ggplot(tbl_cfr_epiweek_continent, aes(epi_week_consultation, n)) +
  facet_wrap(~continent, ncol = 2) +
  geom_col(aes(fill = outcome_status)) +
  geom_line(data = tbl_cfr_epiweek_continent_prop,
            aes(y = prop_dead / scaling_factor, colour = "CFR"),
            key_glyph = "timeseries", size = 1) +
  scale_x_date(name = "Week of Admission", date_breaks = "3 weeks", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .),
               expand = expansion(mult = c(0.01, 0.01))) + #, labels = function(x) format(x, "%b-%Y")
  scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . * scaling_factor, name = "Case Fatality Risk", labels = scales::percent_format(accuracy = 1)),
                     expand = expansion(mult = c(0, 0.02))) +
  ggthemes::scale_fill_tableau(palette = "Tableau 20") +
  labs(y = "Patients", colour = NULL, fill = "Outcome", caption = "Latest 2 weeks omitted for data completeness purposes") +
  theme(legend.position = "top", panel.grid.minor = element_blank())

ggsave(file.path(path.local.msf.graphs.oc, paste0('line_cfr_week_continent', '_', week_report, '.png')),
       plot = line_cfr_week_continent, 
       width = 8, 
       height = 8, 
       scale = 1.1,
       dpi = 320)


line_cfr_week_continent

```

### Delay from onset of symptpoms to consultation/admission

```{r boxplot-delay-admission-week, fig.cap = 'Evolution overtime of the delay to admission among Covid confirmed patients consulted/admitted to an MSF supported health facility'}
# DONE by Paul

dta_delay <- dta_linelist %>% 
  filter(covid_status %in% c("Confirmed")) %>% 
  select(epi_week_consultation, dateonset, date_consultation, covid_status) %>% 
  drop_na(epi_week_consultation) %>% 
  mutate(
    delay_before_consultation = as.numeric(date_consultation - dateonset)) %>% 
  filter(between(delay_before_consultation, left = 0, right = 50)) # filter any delays negative or over 50 days


boxplot_delay_before_consultation <- ggplot(dta_delay, aes(x = epi_week_consultation, y = delay_before_consultation)) + 
  geom_boxplot(aes(group = epi_week_consultation)) + 
  #geom_smooth(fill = "lightblue") + 
  scale_x_date(name = "Week of Consultation", date_breaks = "2 weeks", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .)) +
  labs(y = "Delay to consultation (days)")

ggsave(file.path(path.local.msf.graphs.oc, paste0('boxplot_delay_before_consultation', '_', week_report, '.png')),
       plot = boxplot_delay_before_consultation, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

boxplot_delay_before_consultation

```

### Length of stay in hospital

```{r boxplot-length-stay-week, fig.cap = 'Evolution overtime of of length of stay among Covid confirmed, probable and suspected patients in an MSF supported health facility'}
# DONE by Paul

# 2 most recent epi weeks to remove from chart
latest_2_epiweeks <- max_2(dta_linelist$epi_week_consultation)

# length stay
dta_length_stay <- dta_linelist %>% 
  select(epi_week_consultation, covid_status, merge_admit, length_stay) %>% 
  filter(covid_status %in% c('Confirmed'), merge_admit == 'Yes') %>% 
  drop_na(epi_week_consultation, length_stay) %>% 
  filter(between(length_stay, left = 0, right = 50), !epi_week_consultation %in% latest_2_epiweeks)


boxplot_length_stay_week <- ggplot(dta_length_stay, aes(epi_week_consultation, length_stay, group = epi_week_consultation)) + 
  geom_boxplot() + 
  #geom_jitter(colour = "red", alpha = 0.3) +
  scale_x_date(name = "Week of Admission", date_breaks = "2 weeks", date_labels = "%V", sec.axis = ggplot2::sec_axis(trans = ~ .)) +
  labs(y = "Length of stay in hospital (days)", caption = "Latest 2 weeks omitted for data completeness purposes")

ggsave(file.path(path.local.msf.graphs.oc, paste0('boxplot_length_stay', '_', week_report, '.png')),
       plot = boxplot_length_stay_week, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

boxplot_length_stay_week

```

# Analysis of non-cases

```{r tbl-non-cases-diagnosis, layout="l-body-outset"}

dta_non_cases_diagt <- dta_linelist %>% 
  filter(covid_status == 'Not a case') %>% 
  select(main_diagnosis, outcome_status) %>% 
  mutate(
    main_diagnosis = fct_explicit_na(main_diagnosis, na_level = "Not reported"))

tbl_non_cases_diagt <- tbl_prop(dta_non_cases_diagt, 'main_diagnosis', 'outcome_status', prop_by = 'row')

gtbl_non_cases_diagt <- tbl_non_cases_diagt %>% 
  gt() %>% 
  cols_hide(
    columns = starts_with('N_', ignore.case = FALSE)) %>% 
  cols_label(
    main_diagnosis = '', 
    n_Cured = 'n', 
    n_Died = 'n', 
    `n_Left against medical advice` = 'n', 
    n_Transferred = 'n', 
    `n_Sent back home` = 'n', 
    n_Other = 'n', 
    `n_(Pending/Unknown)` = 'n', 
    n_Total = 'n',
    p_Cured = '(%)', 
    p_Died = '(%)', 
    `p_Left against medical advice` = '(%)', 
    p_Transferred = '(%)', 
    `p_Sent back home` = '(%)', 
    p_Other = '(%)', 
    `p_(Pending/Unknown)` = '(%)', 
    p_Total = '(%)') %>% 
  tab_spanner(
    label = 'Recovered', 
    columns = ends_with('_Cured')) %>% 
  tab_spanner(
    label = 'Died', 
    columns = ends_with('_Died')) %>% 
  tab_spanner(
    label = html('Left against<br>medical advice'), 
    columns = ends_with('_Left against medical advice')) %>% 
  tab_spanner(
    label = 'Transferred', 
    columns = ends_with('_Transferred')) %>% 
  tab_spanner(
    label = html('Sent<br>back home'), 
    columns = ends_with('_Sent back home')) %>% 
  tab_spanner(
    label = 'Other', 
    columns = ends_with('_Other')) %>% 
  tab_spanner(
    label = html('Pending/<br>Unknown'), 
    columns = ends_with('_Pending/Unknown')) %>% 
  tab_spanner(
    label = 'Total', 
    columns = ends_with('_Total')) %>% 
  fmt_number(
    columns = starts_with('p_'), 
    decimals = 1, 
    scale_by = 100, 
    pattern = "({x})") %>% 
  cols_align(
    align = 'right', 
    columns = starts_with('n_')) %>% 
  cols_align(
    align = 'left', 
    columns = starts_with('p_')) %>% 
  cols_align(
    align = 'left', 
    columns = vars(main_diagnosis)) %>% 
  tab_style(
    style = list(
      cell_text(align = "right")),
    locations = cells_column_labels(starts_with('n_'))) %>% 
  tab_style(
    style = list(
      cell_text(align = "left")),
    locations = cells_column_labels(starts_with('p_'))) %>% 
  tab_options(
    column_labels.font.weight = "bold", 
    data_row.padding = px(5))


gtsave(gtbl_non_cases_diagt,
       file.path(path.local.msf.tables.oc, paste0('gtbl_non_cases_diagt', '_', week_report, '.png'))) %>%
  invisible()

gtsave(gtbl_non_cases_diagt,
       file.path(path.local.msf.tables.oc, paste0('gtbl_non_cases_diagt', '_', week_report, '.html')),
       inline_css = TRUE) %>%
  invisible()


gtbl_non_cases_diagt %>% 
  tab_header(
    title = 'Frequency of main diagnoses among non confirmed patients who attended an MSF Covid facility'
  )

```


# Additional analyses by project

Inclusion criteria: patients were included in the study if COVID suspected or probable or confirmed case independently of level of care provided in the project.

## Figure 1

Weekly evolution of the total number of patients by covid19 status and by project

Figures will be generated automatically for each project and stored online with the supplementary analyses (link to come).

```{r Fig1, eval=FALSE, include=FALSE}

plot_epicurve_project <- function(data, 
                                  ncols_facet = 3,
                                  project = "",
                                  # continent = "",
                                  path_save = "") {
  
  data <- data %>% 
  mutate(site_name2 = stringr::str_remove(site_name, pattern = " \\(*\\)") %>% 
                      stringr::str_replace_all(" ", "_") %>% 
                      stringr::str_to_lower()
         )
  
  country <- unique(data$country)
  project <- unique(site_name2)
  
  
  fig_data <- data %>% 
    ggplot(aes(x = epi_week_consultation, 
               y = n, 
               fill = covid_status)) +
    geom_col() +
    
    labs(title = "Weekly evolution of the total number of patients by covid19",
         caption = "Individual and aggregated data are displayed") +
    
    scale_x_date(name = "Week of Consultation", 
                 date_breaks = "2 week", 
                 date_labels = "%V", 
                 expand = expansion(mult = c(0.01, 0.01)),
                 sec.axis = ggplot2::sec_axis(trans = ~ as.Date(.))) + 
    
    scale_y_continuous(name = "Patients", expand = expansion(mult = c(0, 0.02))) +
    
    # facet_wrap(~ site_name, ncol = ncols_facet, scales = "free_y") +
    # 
    ggthemes::scale_fill_tableau(name = "Status", palette = "Tableau 20") +
    theme_light() + 
    theme(legend.position = 'top', 
          panel.grid.major.x = element_blank(), 
          panel.grid.minor.x = element_blank())
  
  
  ggsave(filename = paste0(country, '_', project, '_', 'hist_epicurve_status', '_', week_report, '.png'),
         path = path.local.msf.graphs.oc,
         plot = fig_data, 
         width = 6,
         height = 4,
         scale = 1.1,
         dpi = 320
  )
  
  return(fig_data)
}




dta_linelist_with_aggregated$site_name %>% 
  clean_names(site_name) %>% 
  distinct(site_name)


tbl_epicurve_status_p <- dta_linelist_with_aggregated %>%
  count(site_name, covid_status, epi_week_consultation) %>% 
  group_by(site_name) %>% 
  nest() %>% 
  mutate(plot = map2(.x = data, 
                     .y = site_name,
                     ~ plot_epicurve_project(data = .x,
                                             # ncols_facet = 3,
                                             project = .y,
                                             path_save = path.local.msf.graphs.oc.per.project))) 

print(tbl_epicurve_status_p$plot) 
```


## Table 1

Number of patient visits and hospitalisation status at admission and over course of disease, by project (includes confirmed, suspect, probable cases only).

```{r tble1}
tble1 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, admit, outcome_admit, merge_admit) %>%
  group_by(country, project) %>% 
  summarise(n_patients           = n(),
            
            n_admitted_admission = sum(admit == "Yes", na.rm = TRUE),
            p_admitted_admission = n_admitted_admission / n_patients,
            
            n_admited_post       = sum(outcome_admit == "Yes" & admit != "Yes", na.rm = TRUE),
            p_admited_post       = n_admited_post / n_patients,
            
            n_admit_all          = sum(merge_admit == "Yes", na.rm = TRUE),
            p_admit_all          = n_admit_all / n_patients)


gtble1 <- tble1 %>% 
  gt() %>%
  cols_label(
    country              = 'Country',
    project              = 'Project',
    n_patients           = 'Visits',
    n_admitted_admission = 'N',
    p_admitted_admission = "%",
    n_admited_post       = 'N',
    p_admited_post       = "%",
    n_admit_all          = 'N',
    p_admit_all          = "%") %>% 
  
  tab_spanner(
    label = 'Hospitalised at presentation',
    columns = ends_with('_admitted_admission')) %>%
  
  tab_spanner(
    label = 'Hospitalised during course of disease',
    columns = ends_with('_admited_post')) %>%
  
  tab_spanner(
    label = 'Hospitalised (any time)',
    columns = ends_with('_admit_all')) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100) %>%
  
  # cols_align(
  #   align = 'right',
  #   columns = starts_with('n_')) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = vars(n_patients, n_admitted_admission, n_admited_post, n_admit_all),
    fns = list(Total = "sum"),
    decimals = 0)


gtsave(gtble1, 
       file.path(path.local.msf.tables.oc, paste0('gtble1', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble1 %>% 
  tab_header(
    title = 'Patient visits and hospitalisation status at admission and over course of disease, by project')
```


## Table 2

Number of patient visits and hospitalisation by project and severity (includes confirmed, suspect, probable cases only)


```{r tble2}
tble2 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, admit, merge_admit, severity, length_stay) %>%
  group_by(country, project) %>% 
  summarise(n_patients = n(),
            n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
            
            n_mild       = sum(severity == "Mild", na.rm = TRUE),
            n_mild_admis = sum(severity == "Mild" & merge_admit == "Yes"),
            p_mild_admis = n_mild_admis / n_mild,
            
            n_moderate       = sum(severity == "Moderate", na.rm = TRUE),
            n_moderate_admis = sum(severity == "Moderate" & merge_admit == "Yes", na.rm = TRUE),
            p_moderate_admis = n_moderate_admis / n_moderate,
            
            n_severe       = sum(severity == "Severe", na.rm = TRUE),
            n_severe_admis  = sum(severity == "Severe" & merge_admit == "Yes", na.rm = TRUE),
            p_severe_admis = n_severe_admis / n_severe,
            
            n_critical        = sum(severity == "Critical", na.rm = TRUE),
            n_critical_admis  = sum(severity == "Critical" & merge_admit == "Yes", na.rm = TRUE),
            p_critical_admis  = n_critical_admis / n_critical,
            
            n_na       = sum(is.na(severity)),
            p_na       = n_na / n_patients)


gtble2 <- tble2 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    n_patients = 'Visits',
    n_admis    = 'Admissions',
    
    n_mild       = 'N visits',
    n_mild_admis = 'N admissions',
    p_mild_admis = "% admitted",
    
    n_moderate       = 'N visits',
    n_moderate_admis = 'N admissions',
    p_moderate_admis = "% admitted",
    
    n_severe       = 'N visits',
    n_severe_admis = 'N admissions',
    p_severe_admis = "% admitted",
    
    n_critical       = 'N visits',
    n_critical_admis = 'N admissions',
    p_critical_admis = "% admitted",
    
    n_na = 'Severity',
    p_na = "% non-available") %>% 
  
  tab_spanner(
    label = 'All severity',
    columns = vars(n_patients, n_admis)) %>%
  tab_spanner(
    label = 'Mild',
    columns = contains('_mild')) %>%
  tab_spanner(
    label = 'Moderate',
    columns = contains('_moderate')) %>%
  tab_spanner(
    label = 'Severe',
    columns = contains('_severe')) %>%
  tab_spanner(
    label = 'Critical',
    columns = contains('_critical')) %>%
  tab_spanner(
    label = 'Missing data',
    columns = ends_with('_na')) %>% 
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  fmt_number(
    columns = starts_with('p_'),
    decimals = 1,
    scale_by = 100) %>%
  
  cols_align(
    align = 'center') %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding  = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)

gtsave(gtble2, 
       file.path(path.local.msf.tables.oc, paste0('gtble2', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble2 %>%
  tab_header(
    title = 'Patient visits and hospitalisation by project and severity')
```



## Table 3

Median length of stay according to severity 

```{r tble3}
tble3 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, severity, length_stay) %>%
  group_by(country, project) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    q_mild_25 = quantile(length_stay[merge_admit == "Yes" & severity == "Mild"], c(0.25), na.rm = TRUE),
    q_mild_50 = quantile(length_stay[merge_admit == "Yes" & severity == "Mild"], c(0.5), na.rm = TRUE),
    q_mild_75 = quantile(length_stay[merge_admit == "Yes" & severity == "Mild"], c(0.75), na.rm = TRUE),
    
    q_moderate_25 = quantile(length_stay[merge_admit == "Yes" & severity == "Moderate"], c(0.25), na.rm = TRUE),
    q_moderate_50 = quantile(length_stay[merge_admit == "Yes" & severity == "Moderate"], c(0.5), na.rm = TRUE),
    q_moderate_75 = quantile(length_stay[merge_admit == "Yes" & severity == "Moderate"], c(0.75), na.rm = TRUE),
    
    q_critical_25 = quantile(length_stay[merge_admit == "Yes" & severity == "Critical"], c(0.25), na.rm = TRUE),
    q_critical_50 = quantile(length_stay[merge_admit == "Yes" & severity == "Critical"], c(0.5), na.rm = TRUE),
    q_critical_75 = quantile(length_stay[merge_admit == "Yes" & severity == "Critical"], c(0.75), na.rm = TRUE),
    
    q_severe_25 = quantile(length_stay[merge_admit == "Yes" & severity == "Severe"], c(0.25), na.rm = TRUE),
    q_severe_50 = quantile(length_stay[merge_admit == "Yes" & severity == "Severe"], c(0.5), na.rm = TRUE),
    q_severe_75 = quantile(length_stay[merge_admit == "Yes" & severity == "Severe"], c(0.75), na.rm = TRUE),
    
    na_severity = sum(is.na(severity)),
    na_length_of_stay = sum(is.na(length_stay)),
    na_both = sum(is.na(severity) & is.na(length_stay))
  ) %>% 
  
  mutate(iqr_mild     = glue("{q_mild_50} [{q_mild_25} - {q_mild_75}]"),
         iqr_moderate = glue("{q_moderate_50} [{q_moderate_25} - {q_moderate_75}]"),
         iqr_severe   = glue("{q_critical_50} [{q_critical_25} - {q_critical_75}]"),
         iqr_critical = glue("{q_severe_50} [{q_severe_25} - {q_severe_75}]")) %>% 
  select(-starts_with("q_")) %>% 
  relocate(country, project,
           starts_with("n_"), 
           starts_with("iqr_"), 
           starts_with("na_"))  %>% 
  group_by(country)


gtble3 <- tble3 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    
    n_patients = 'Visits',
    n_admis    = 'Admissions',
    
    iqr_mild     = 'Mild',
    iqr_moderate = 'Moderate',
    iqr_severe   = 'Severe',
    iqr_critical = 'Critical',
    
    na_severity       = "Severity",
    na_length_of_stay = "Length of stay",
    na_both           = "Both") %>% 
  
  tab_spanner(
    label = 'Length  of Stay (Median [IQR])',
    columns = starts_with('iqr_')) %>% 
  tab_spanner(
    label = 'Missing data',
    columns = starts_with('na')) %>% 
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center') %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0)


gtsave(gtble3, 
       file.path(path.local.msf.tables.oc, paste0('gtble3', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble3 %>%
  tab_header(
    title = 'Median length of stay according to severity')
```



## Figure 4

Median [IQR] time between onset of symptoms and presentations

```{r fig4}
fig4 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  mutate(delay_before_consultation = as.numeric(date_consultation - dateonset)) %>% 
  filter(between(delay_before_consultation, left = 0, right = 50)) %>% 
  # select(country, project, merge_admit, severity, length_stay) %>%
  group_by(continent, country, project) %>%
  summarise(x = quantile(delay_before_consultation, c(0.25, 0.5, 0.75), na.rm = TRUE),
            q = c(0.25, 0.5, 0.75),
            n = n()) %>%
  pivot_wider(names_from = q, 
              values_from =x,
              names_prefix = "q_") %>%
   mutate(project = paste(country, project, sep = " - ")) %>% 
  
  ggplot(aes(x = fct_reorder(project, desc(q_0.5)),
             y = q_0.5,
             colour = continent)) +
  geom_point(aes(size = n),
             shape = 19) +
  geom_errorbar(aes(ymin = q_0.25, 
                    ymax = q_0.75),
                width = 0) +
  coord_flip() +
  labs(x = "",
       y = "Median time",
       title = "Median time between symptom onset\nand presentation",
       subtitle = "Median and interquartile range") +
  ggthemes::scale_colour_tableau(name = "Continent", palette = "Red-Blue-Brown") +
  scale_size_continuous(name = "Number of\npresentations",
                        breaks = c(10, 100, 1000, 5000)) +
  theme_light() + 
  theme(legend.position = 'right', 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())

ggsave(file.path(path.local.msf.graphs.oc, paste0('fig4', '_', week_report, '.png')),
       plot = fig4, 
       width = 6, 
       height = 4, 
       scale = 1.1,
       dpi = 320)

fig4
```


## Table 4
History of medical care before presentation, by project and hospitalisation

Data unavailable (unrecorded)

## Table 5
Oxygen saturation at admission, by project

Data unavailable

## Table 6

Median age stratified by gender, project and hospitalisation status

```{r tble6}
tble6 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, covid_status, merge_admit, sex, age_in_years) %>%
  group_by(country, project, sex) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_probable_admis    = sum(covid_status == "Probable" & merge_admit == "Yes", na.rm = TRUE),
    q_probable_25_admis = quantile(age_in_years[covid_status == "Probable" & merge_admit == "Yes"], c(0.25), na.rm = TRUE),
    q_probable_05_admis = quantile(age_in_years[covid_status == "Probable" & merge_admit == "Yes"], c(0.5), na.rm = TRUE),
    q_probable_75_admis = quantile(age_in_years[covid_status == "Probable" & merge_admit == "Yes"], c(0.75), na.rm = TRUE),
    f_probable_admis    = format_med(q_probable_05_admis, q_probable_25_admis, q_probable_75_admis),
    
    n_confirmed_admis    = sum(covid_status == "Confirmed" & merge_admit == "Yes", na.rm = TRUE),
    q_confirmed_25_admis = quantile(age_in_years[covid_status == "Confirmed" & merge_admit == "Yes"], c(0.25), na.rm = TRUE),
    q_confirmed_05_admis = quantile(age_in_years[covid_status == "Confirmed" & merge_admit == "Yes"], c(0.5), na.rm = TRUE),
    q_confirmed_75_admis = quantile(age_in_years[covid_status == "Confirmed" & merge_admit == "Yes"], c(0.75), na.rm = TRUE),
    f_confirmed_admis = format_med(q_confirmed_05_admis, q_confirmed_25_admis, q_confirmed_75_admis),
    
    n_probable_out    = sum(covid_status == "Probable" & merge_admit == "No", na.rm = TRUE),
    q_probable_25_out = quantile(age_in_years[covid_status == "Probable" & merge_admit == "No"], c(0.25), na.rm = TRUE),
    q_probable_05_out = quantile(age_in_years[covid_status == "Probable" & merge_admit == "No"], c(0.5), na.rm = TRUE),
    q_probable_75_out = quantile(age_in_years[covid_status == "Probable" & merge_admit == "No"], c(0.75), na.rm = TRUE),
    f_probable_out    = format_med(q_probable_05_out, q_probable_25_out, q_probable_75_out),
    
    n_confirmed_out    = sum(covid_status == "Confirmed" & merge_admit == "No", na.rm = TRUE),
    q_confirmed_25_out = quantile(age_in_years[covid_status == "Confirmed" & merge_admit == "No"], c(0.25), na.rm = TRUE),
    q_confirmed_05_out = quantile(age_in_years[covid_status == "Confirmed" & merge_admit == "No"], c(0.5), na.rm = TRUE),
    q_confirmed_75_out = quantile(age_in_years[covid_status == "Confirmed" & merge_admit == "No"], c(0.75), na.rm = TRUE),
    f_confirmed_out    = format_med(q_confirmed_05_out, q_confirmed_25_out, q_confirmed_75_out)
  ) %>% 
  select(-starts_with("q_"))


gtble6 <- tble6 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    n_patients = 'Visits',
    n_admis    = 'Admissions',
    
    n_probable_admis = 'N probable',
    f_probable_admis = 'Median age probable [IQR]',
    
    n_confirmed_admis = 'N confirmed',
    f_confirmed_admis = 'Median age confirmed [IQR]',
    
    n_probable_out = 'N probable',
    f_probable_out = 'Median age probable [IQR]',
    
    n_confirmed_out = 'N confirmed',
    f_confirmed_out = 'Median age confirmed [IQR]',
  ) %>% 
  
  tab_spanner(
    label = 'Hospitalised',
    columns = ends_with("_admis")) %>%  
  tab_spanner(
    label = 'Never hospitalised',
    columns = ends_with('_out')) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 

gtsave(gtble6, 
       file.path(path.local.msf.tables.oc, paste0('gtble6', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble6 %>% 
  tab_header(
    title = 'Median age stratified by gender, project and hospitalisation status')

```


## Figure 5 

Median [IQR] of age per project, stratified by gender

```{r fig5}
fig5 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  drop_na(sex) %>% 
  mutate(Sex = factor(sex, 
                      levels = c('M', 'F'), 
                      labels = c('Male', 'Female'))) %>% 
  group_by(continent, country, project, Sex) %>%
  summarise(x = quantile(age_in_years, c(0.25, 0.5, 0.75), na.rm = TRUE),
            q = c(0.25, 0.5, 0.75),
            n = n()) %>%
  pivot_wider(names_from = q, 
              values_from =x,
              names_prefix = "q_") %>% 
   mutate(project = paste(country, project, sep = " - ")) %>% 
  
  ggplot(aes(x = fct_reorder(project, desc(q_0.5)),
             y = q_0.5,
             colour = Sex,
             shape = Sex
  )) +
  geom_point(aes(size = n),
             position = position_dodge(width=0.9)) +
  geom_errorbar(aes(ymin = q_0.25, 
                    ymax = q_0.75),
                width = 0,
                position = position_dodge(width=0.9)) +
  coord_flip() +
  labs(x = "",
       y = "Median age",
       title = "Median age (in years) of all presentations",
       subtitle = "Median and interquartile range") +
  
  scale_colour_manual(name = "Sex", 
                      values = c("#4E79A7FF", "#A0CBE8FF"), 
                      breaks = c("Male", "Female"), 
                      labels = c("Male", "Female")) +
  
  scale_size_continuous(name = "Visits",
                        breaks = c(10, 100, 1000, 5000)) +
  
  theme_light() + 
  theme(legend.position = 'right', 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())


ggsave(file.path(path.local.msf.graphs.oc, paste0('fig5', '_', week_report, '.png')),
       plot = fig5, 
       width = 8, 
       height = 6, 
       scale = 1.1,
       dpi = 320)

fig5
```


## Table 7

Total number of patient visits by case status, ICU admission status, by project


```{r tble7}
tble7 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, icu, merge_icu) %>%
  group_by(country, project) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_icu_admission = sum(merge_admit == "Yes" & icu == "Yes", na.rm = TRUE),
    p_icu_admission = n_icu_admission / n_admis,
    m_icu_admission = format_nbp(n_icu_admission, p_icu_admission),
    
    n_icu_later  = sum(merge_admit == "Yes" & icu != "Yes" & merge_icu == "Yes", na.rm = TRUE),
    p_icu_later = n_icu_later / n_admis,
    m_icu_later = format_nbp(n_icu_later, p_icu_later)
  ) %>% 
  select(country, project, n_patients, n_admis, 
         m_icu_admission,  m_icu_later)



gtble7 <-  tble7 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    n_patients = 'Visits',
    n_admis    = 'Admissions',
    
    m_icu_admission = 'ICU at adm.',
    m_icu_later     = 'ICU later',
  ) %>% 
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 

gtsave(gtble7, 
       file.path(path.local.msf.tables.oc, paste0('gtble7', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble7 %>% 
  tab_header(
    title = 'Total number of patient visits, admitted, and admitted in ICU')
```
## Table 8

Total number of patient visits by case status, ICU admission status, by project (includes confirmed, suspect, probable cases only)

```{r tble8}
tble8 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, covid_status, merge_admit, icu, merge_icu) %>%
  group_by(country, project) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_probable            = sum(covid_status == "Probable", na.rm = TRUE),
    n_probable_admis      = sum(covid_status == "Probable" & merge_admit == "Yes", na.rm = TRUE),
    p_probable_admis      = n_probable_admis / n_probable,
    m_probable_admis      = format_nbp(n_probable_admis, p_probable_admis),
    
    n_probable_icu_admis  = sum(covid_status == "Probable" & merge_admit == "Yes" & icu == "Yes", na.rm = TRUE),
    p_probable_icu_admis  = n_probable_icu_admis / n_probable_admis,
    m_probable_icu_admis  = format_nbp(n_probable_icu_admis, p_probable_icu_admis),
    
    n_probable_icu_later  = sum(covid_status == "Probable" & merge_admit == "Yes" & icu != "Yes" & merge_icu == "Yes", na.rm = TRUE),
    p_probable_icu_later  = n_probable_icu_later / n_probable_admis,
    m_probable_icu_later  = format_nbp(n_probable_icu_later, p_probable_icu_later),
    
    n_suspected            = sum(covid_status == "Suspected", na.rm = TRUE),
    n_suspected_admis      = sum(covid_status == "Suspected" & merge_admit == "Yes", na.rm = TRUE),
    p_suspected_admis      = n_suspected_admis / n_suspected,
    m_suspected_admis      = format_nbp(n_suspected_admis, p_suspected_admis),
    
    n_suspected_icu_admis  = sum(covid_status == "Suspected" & merge_admit == "Yes" & icu == "Yes", na.rm = TRUE),
    p_suspected_icu_admis  = n_suspected_icu_admis / n_suspected_admis,
    m_suspected_icu_admis  = format_nbp(n_suspected_icu_admis, p_suspected_icu_admis),
    
    n_suspected_icu_later  = sum(covid_status == "Suspected" & merge_admit == "Yes" & icu != "Yes" & merge_icu == "Yes", na.rm = TRUE),
    p_suspected_icu_later  = n_suspected_icu_later / n_suspected_admis,
    m_suspected_icu_later  = format_nbp(n_suspected_icu_later, p_suspected_icu_later),
    
    n_confirmed            = sum(covid_status == "Confirmed", na.rm = TRUE),
    n_confirmed_admis      = sum(covid_status == "Confirmed" & merge_admit == "Yes", na.rm = TRUE),
    p_confirmed_admis      = n_confirmed_admis / n_confirmed,
    m_confirmed_admis      = format_nbp(n_confirmed_admis, p_confirmed_admis),
    
    n_confirmed_icu_admis  = sum(covid_status == "Confirmed" & merge_admit == "Yes" & icu == "Yes", na.rm = TRUE),
    p_confirmed_icu_admis  = n_confirmed_icu_admis / n_confirmed_admis,
    m_confirmed_icu_admis  = format_nbp(n_confirmed_icu_admis, p_confirmed_icu_admis),
    
    n_confirmed_icu_later  = sum(covid_status == "Confirmed" & merge_admit == "Yes" & icu != "Yes" & merge_icu == "Yes", na.rm = TRUE),
    p_confirmed_icu_later  = n_confirmed_icu_later / n_confirmed_admis,
    m_confirmed_icu_later  = format_nbp(n_confirmed_icu_later, p_confirmed_icu_later),
  ) %>% 
  select(country, project, n_patients,
         # n_admis, 
         n_probable,  m_probable_admis,  m_probable_icu_admis,  m_probable_icu_later,  
         n_suspected, m_suspected_admis, m_suspected_icu_admis, m_suspected_icu_later, 
         n_confirmed, m_confirmed_admis, m_confirmed_icu_admis, m_confirmed_icu_later)




gtble8 <-  tble8 %>% 
  gt() %>%
  cols_label(
    country          = 'Country',
    project          = 'Project',
    n_patients       = 'Visits',
    # n_admited        = 'Admissions',
    
    n_probable            = 'Visits',
    m_probable_admis      = 'Hospit.',
    m_probable_icu_admis  = 'ICU at adm.',
    m_probable_icu_later  = 'ICU after adm.',
    
    n_suspected            = 'Visits',
    m_suspected_admis      = 'Hospit.',
    m_suspected_icu_admis  = 'ICU at adm.',
    m_suspected_icu_later  = 'ICU after adm.',
    
    n_confirmed            = 'Visits',
    m_confirmed_admis      = 'Hospit.',
    m_confirmed_icu_admis  = 'ICU at adm.',
    m_confirmed_icu_later  = 'ICU after adm.') %>% 
  
  tab_spanner(
    label = 'Probable',
    columns = contains("_probable")) %>%  
  tab_spanner(
    label = 'Suspected',
    columns = contains('_suspected')) %>%
  tab_spanner(
    label = 'Confirmed',
    columns = contains('_confirmed')) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 

gtsave(gtble8, 
       file.path(path.local.msf.tables.oc, paste0('gtble8', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble8 %>% 
  tab_header(
    title = 'Total number of patient visits by case status and ICU admission status')

```


## Table 9

Total number of patient visits patients admitted and patients given oxygen on admission and over course of disease (confirmed, suspect, probable cases only)

```{r tble9}
tble9 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, received_oxygen, merge_oxygen) %>%
  group_by(country, project) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_oxygen_admission = sum(merge_admit == "Yes" & received_oxygen == "Yes", na.rm = TRUE),
    p_oxygen_admission = n_oxygen_admission / n_admis,
    m_oxygen_admission = format_nbp(n_oxygen_admission, p_oxygen_admission),
    
    n_oxygen_later  = sum(merge_admit == "Yes" & received_oxygen != "Yes" & merge_oxygen == "Yes", na.rm = TRUE),
    p_oxygen_later  = n_oxygen_later / n_admis,
    m_oxygen_later  = format_nbp(n_oxygen_later, p_oxygen_later)
  ) %>% 
  select(country, project, n_patients, n_admis, 
         m_oxygen_admission,  m_oxygen_later)




gtble9 <-  tble9 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    n_patients = 'Visits',
    n_admis    = 'Admissions',
    
    m_oxygen_admission = 'Oxygen at adm.',
    m_oxygen_later     = 'Oxygen later',
  ) %>% 
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 

gtsave(gtble9, 
       file.path(path.local.msf.tables.oc, paste0('gtble9', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble9 %>% 
  tab_header(
    title = 'Total number of patient visits and oxygen status')

```


## Table 10

Total number of patient visits patients admitted and patients given oxygen on admission and during hospitalization, by case status 

```{r tble10}
tble10 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, covid_status, merge_admit, received_oxygen, merge_oxygen) %>%
  group_by(country, project) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_probable            = sum(covid_status == "Probable", na.rm = TRUE),
    n_probable_admis      = sum(covid_status == "Probable" & merge_admit == "Yes", na.rm = TRUE),
    p_probable_admis      =  n_probable_admis / n_probable,
    m_probable_admis         = format_nbp(n_probable_admis, p_probable_admis),
    
    n_probable_oxygen_admis  = sum(covid_status == "Probable" & merge_admit == "Yes" & received_oxygen == "Yes", na.rm = TRUE),
    p_probable_oxygen_admis  = n_probable_oxygen_admis / n_probable_admis,
    m_probable_oxygen_admis  = format_nbp(n_probable_oxygen_admis, p_probable_oxygen_admis),
    
    n_probable_oxygen_later  = sum(covid_status == "Probable" & merge_admit == "Yes" & received_oxygen != "Yes" & merge_oxygen == "Yes", na.rm = TRUE),
    p_probable_oxygen_later  = n_probable_oxygen_later / n_probable_admis,
    m_probable_oxygen_later  = format_nbp(n_probable_oxygen_later, p_probable_oxygen_later),
    
    n_suspected            = sum(covid_status == "Suspected", na.rm = TRUE),
    n_suspected_admis      = sum(covid_status == "Suspected" & merge_admit == "Yes", na.rm = TRUE),
    p_suspected_admis      = n_suspected_admis / n_suspected,
    m_suspected_admis      = format_nbp(n_suspected_admis, p_suspected_admis),
    
    n_suspected_oxygen_admis  = sum(covid_status == "Suspected" & merge_admit == "Yes" & received_oxygen == "Yes", na.rm = TRUE),
    p_suspected_oxygen_admis  = n_suspected_oxygen_admis / n_suspected_admis,
    m_suspected_oxygen_admis  = format_nbp(n_suspected_oxygen_admis, p_suspected_oxygen_admis),
    
    n_suspected_oxygen_later  = sum(covid_status == "Suspected" & merge_admit == "Yes" & received_oxygen != "Yes" & merge_oxygen == "Yes", na.rm = TRUE),
    p_suspected_oxygen_later  = n_suspected_oxygen_later / n_suspected_admis,
    m_suspected_oxygen_later  = format_nbp(n_suspected_oxygen_later, p_suspected_oxygen_later),
    
    
    n_confirmed            = sum(covid_status == "Confirmed", na.rm = TRUE),
    n_confirmed_admis      = sum(covid_status == "Confirmed" & merge_admit == "Yes", na.rm = TRUE),
    p_confirmed_admis      = n_confirmed_admis / n_confirmed,
    m_confirmed_admis      = format_nbp(n_confirmed_admis, p_confirmed_admis),
    
    n_confirmed_oxygen_admis  = sum(covid_status == "Confirmed" & merge_admit == "Yes" & received_oxygen == "Yes", na.rm = TRUE),
    p_confirmed_oxygen_admis  = n_confirmed_oxygen_admis / n_confirmed_admis,
    m_confirmed_oxygen_admis  = format_nbp(n_confirmed_oxygen_admis, p_confirmed_oxygen_admis),
    
    n_confirmed_oxygen_later  = sum(covid_status == "Confirmed" & merge_admit == "Yes" & received_oxygen != "Yes" & merge_oxygen == "Yes", na.rm = TRUE),
    p_confirmed_oxygen_later  = n_confirmed_oxygen_later / n_confirmed_admis,
    m_confirmed_oxygen_later  = format_nbp(n_confirmed_oxygen_later, p_confirmed_oxygen_later),
  ) %>% 
  select(country, project, n_patients,
         n_probable,  m_probable_admis,  m_probable_oxygen_admis,  m_probable_oxygen_later,
         n_suspected, m_suspected_admis, m_suspected_oxygen_admis, m_suspected_oxygen_later,
         n_confirmed, m_confirmed_admis, m_confirmed_oxygen_admis, m_confirmed_oxygen_later)



gtble10 <- tble10 %>% 
  gt() %>%
  cols_label(
    country          = 'Country',
    project          = 'Project',
    n_patients       = 'Visits',
    
    n_probable               = 'Visits',
    m_probable_admis         = 'Hospit.',
    m_probable_oxygen_admis  = 'Oxygen at adm.',
    m_probable_oxygen_later  = 'Oxygen after adm.',
    
    n_suspected               = 'Visits',
    m_suspected_admis         = 'Hospit.',
    m_suspected_oxygen_admis  = 'Oxygen at adm.',
    m_suspected_oxygen_later  = 'Oxygen after adm.',
    
    n_confirmed               = 'Visits',
    m_confirmed_admis         = 'Hospit.',
    m_confirmed_oxygen_admis  = 'Oxygen at adm.',
    m_confirmed_oxygen_later  = 'Oxygen after adm.') %>% 
  
  tab_spanner(
    label = 'Probable',
    columns = contains("_probable")) %>%  
  tab_spanner(
    label = 'Suspected',
    columns = contains('_suspected')) %>%
  tab_spanner(
    label = 'Confirmed',
    columns = contains('_confirmed')) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 


gtsave(gtble10, 
       file.path(path.local.msf.tables.oc, paste0('gtble10', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble10 %>% 
  tab_header(
    title = 'Total number of patient visits by case status and received_oxygen admission status')
```



## Table 11

Total number of patient visits by Maximal Oxygen requirement

Data currently non available.




## Table 12

Total number of patient visits, patients admitted and patients mechanically ventilated by type of ventilation

```{r tble12}
tble12 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, vent, merge_vent) %>%
  group_by(country, project) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_vent_admission = sum(merge_admit == "Yes" & vent == "Yes", na.rm = TRUE),
    p_vent_admission = n_vent_admission / n_admis,
    m_vent_admission = format_nbp(n_vent_admission, p_vent_admission),
    
    n_vent_later  = sum(merge_admit == "Yes" & vent != "Yes" & merge_vent == "Yes", na.rm = TRUE),
    p_vent_later  = n_vent_later / n_admis,
    m_vent_later  = format_nbp(n_vent_later, p_vent_later)
  ) %>% 
  select(country, project, n_patients, n_admis, 
         m_vent_admission,  m_vent_later)


gtble12 <-  tble12 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    n_patients = 'Visits',
    n_admis    = 'Admissions',
    
    m_vent_admission = 'Ventilation at adm.',
    m_vent_later     = 'Ventilation later',
  ) %>% 
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 

gtsave(gtble12, 
       file.path(path.local.msf.tables.oc, paste0('gtble12', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble12 %>% 
  tab_header(
    title = 'Total number of patient visits and ventilation status')

```



## Table 13

Total number of patient visits, patients admitted and patients mechanically ventilated at admission and other time during hospitalization by project and case status

```{r tble13}
tble13 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, covid_status, merge_admit, vent, merge_vent) %>%
  group_by(country, project) %>% 
  summarise(
    n_patients = n(),
    n_admis    = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_probable            = sum(covid_status == "Probable", na.rm = TRUE),
    n_probable_admis      = sum(covid_status == "Probable" & merge_admit == "Yes", na.rm = TRUE),
    p_probable_admis      =  n_probable_admis / n_probable,
    m_probable_admis      = format_nbp(n_probable_admis, p_probable_admis),
    
    n_probable_vent_admis  = sum(covid_status == "Probable" & merge_admit == "Yes" & vent == "Yes", na.rm = TRUE),
    p_probable_vent_admis  = n_probable_vent_admis / n_probable_admis,
    m_probable_vent_admis  = format_nbp(n_probable_vent_admis, p_probable_vent_admis),
    
    n_probable_vent_later  = sum(covid_status == "Probable" & merge_admit == "Yes" & vent != "Yes" & merge_vent == "Yes", na.rm = TRUE),
    p_probable_vent_later  = n_probable_vent_later / n_probable_admis,
    m_probable_vent_later  = format_nbp(n_probable_vent_later, p_probable_vent_later),
    
    n_suspected            = sum(covid_status == "Suspected", na.rm = TRUE),
    n_suspected_admis      = sum(covid_status == "Suspected" & merge_admit == "Yes", na.rm = TRUE),
    p_suspected_admis      = n_suspected_admis / n_suspected,
    m_suspected_admis      = format_nbp(n_suspected_admis, p_suspected_admis),
    
    n_suspected_vent_admis  = sum(covid_status == "Suspected" & merge_admit == "Yes" & vent == "Yes", na.rm = TRUE),
    p_suspected_vent_admis  = n_suspected_vent_admis / n_suspected_admis,
    m_suspected_vent_admis  = format_nbp(n_suspected_vent_admis, p_suspected_vent_admis),
    
    n_suspected_vent_later  = sum(covid_status == "Suspected" & merge_admit == "Yes" & vent != "Yes" & merge_vent == "Yes", na.rm = TRUE),
    p_suspected_vent_later  = n_suspected_vent_later / n_suspected_admis,
    m_suspected_vent_later  = format_nbp(n_suspected_vent_later, p_suspected_vent_later),
    
    
    n_confirmed            = sum(covid_status == "Confirmed", na.rm = TRUE),
    n_confirmed_admis      = sum(covid_status == "Confirmed" & merge_admit == "Yes", na.rm = TRUE),
    p_confirmed_admis      = n_confirmed_admis / n_confirmed,
    m_confirmed_admis      = format_nbp(n_confirmed_admis, p_confirmed_admis),
    
    n_confirmed_vent_admis  = sum(covid_status == "Confirmed" & merge_admit == "Yes" & vent == "Yes", na.rm = TRUE),
    p_confirmed_vent_admis  = n_confirmed_vent_admis / n_confirmed_admis,
    m_confirmed_vent_admis  = format_nbp(n_confirmed_vent_admis, p_confirmed_vent_admis),
    
    n_confirmed_vent_later  = sum(covid_status == "Confirmed" & merge_admit == "Yes" & vent != "Yes" & merge_vent == "Yes", na.rm = TRUE),
    p_confirmed_vent_later  = n_confirmed_vent_later / n_confirmed_admis,
    m_confirmed_vent_later  = format_nbp(n_confirmed_vent_later, p_confirmed_vent_later),
  ) %>% 
  select(country, project, n_patients,
         n_probable,  m_probable_admis,  m_probable_vent_admis,  m_probable_vent_later,
         n_suspected, m_suspected_admis, m_suspected_vent_admis, m_suspected_vent_later,
         n_confirmed, m_confirmed_admis, m_confirmed_vent_admis, m_confirmed_vent_later)



gtble13 <- tble13 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    n_patients = 'Visits',
    
    n_probable             = 'Visits',
    m_probable_admis       = 'Hospit.',
    m_probable_vent_admis  = 'Ventilation at adm.',
    m_probable_vent_later  = 'Ventilation after adm.',
    
    n_suspected             = 'Visits',
    m_suspected_admis       = 'Hospit.',
    m_suspected_vent_admis  = 'Ventilation at adm.',
    m_suspected_vent_later  = 'Ventilation after adm.',
    
    n_confirmed             = 'Visits',
    m_confirmed_admis       = 'Hospit.',
    m_confirmed_vent_admis  = 'Ventilation at adm.',
    m_confirmed_vent_later  = 'Ventilation after adm.') %>% 
  
  tab_spanner(
    label = 'Probable',
    columns = contains("_probable")) %>%  
  tab_spanner(
    label = 'Suspected',
    columns = contains('_suspected')) %>%
  tab_spanner(
    label = 'Confirmed',
    columns = contains('_confirmed')) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 


gtsave(gtble13, 
       file.path(path.local.msf.tables.oc, paste0('gtble13', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble13 %>% 
  tab_header(
    title = 'Total number of patient visits by case status and ventilation status')
```



## Table 14

Case severity per project

```{r tble14}
tble14 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, covid_status, severity) %>%
  group_by(country, project) %>% 
  summarise(
    n_suspected = sum(covid_status == "Suspected", na.rm = TRUE),
    n_probable  = sum(covid_status == "Probable", na.rm = TRUE),
    n_confirmed = sum(covid_status == "Confirmed", na.rm = TRUE),
    
    n_admis = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_mild     = sum(severity == "Mild", na.rm = TRUE),
    n_moderate = sum(severity == "Moderate", na.rm = TRUE),
    n_severe   = sum(severity == "Severe", na.rm = TRUE),
    n_critical = sum(severity == "Critical", na.rm = TRUE),
    
    n_missing_severity = sum(is.na(severity)),
    
    n_patients = n())


gtble14 <- tble14 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    
    n_suspected = "Suspected",
    n_probable  = "Probable",
    n_confirmed = "Confirmed",
    
    n_admis = "Hospitalised",
    
    n_mild     = "Mild",
    n_moderate = "Moderate",
    n_severe   = "Severe",
    n_critical = "Critical",
    
    n_missing_severity = "Missing data severity",
    n_patients = "Total visits") %>% 
  
  tab_spanner(
    label = 'Total presentation',
    columns = vars(n_suspected, n_probable, n_confirmed)) %>%  
  tab_spanner(
    label = 'Severity',
    columns = vars(n_mild, n_moderate, n_severe, n_critical)) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 

gtsave(gtble14, 
       file.path(path.local.msf.tables.oc, paste0('gtble14', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble14 %>% 
  tab_header(
    title = 'Case severity per project')

```


## Table 15

Mortality by severity

```{r tble15}
tble15 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, covid_status, severity, outcome_status, merge_icu) %>%
  group_by(country, project) %>% 
  summarise(
    n_suspected = sum(covid_status == "Suspected" & outcome_status == "Died", na.rm = TRUE),
    n_probable  = sum(covid_status == "Probable"  & outcome_status == "Died", na.rm = TRUE),
    n_confirmed = sum(covid_status == "Confirmed" & outcome_status == "Died", na.rm = TRUE),
    
    n_admis = sum(merge_admit == "Yes", na.rm = TRUE),
    
    n_mild     = sum(severity == "Mild", na.rm = TRUE),
    n_moderate = sum(severity == "Moderate", na.rm = TRUE),
    n_severe   = sum(severity == "Severe", na.rm = TRUE),
    n_critical = sum(severity == "Critical", na.rm = TRUE),
    
    n_deaths_icu = sum(outcome_status == "Died" & merge_icu == "Yes", na.rm = TRUE),
    
    n_patients = n())


gtble15 <- tble15 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    
    n_suspected = "Suspected",
    n_probable  = "Probable",
    n_confirmed = "Confirmed",
    
    n_admis = "Hospitalised",
    
    n_mild     = "Mild",
    n_moderate = "Moderate",
    n_severe   = "Severe",
    n_critical = "Critical",
    
    n_deaths_icu = "Death amond ICU patients",
    n_patients = "Total visits") %>% 
  
  tab_spanner(
    label = 'Total presentation',
    columns = vars(n_suspected, n_probable, n_confirmed)) %>%  
  tab_spanner(
    label = 'Death by severity',
    columns = vars(n_mild, n_moderate, n_severe, n_critical)) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)  %>% 
  
  summary_rows(
    columns = starts_with("n_"),
    fns = list(Total = "sum"),
    decimals = 0) 

gtsave(gtble15, 
       file.path(path.local.msf.tables.oc, paste0('gtble15', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble15 %>% 
  tab_header(
    title = 'Mortality by severity')
```


## Fig6

Mortality by therapy received, by project

```{r fig6}
fig6 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected'),
         merge_admit == "Yes") %>% 
 
  group_by(continent, country, project) %>%
  
  summarise(
    n_admit = n(),
    
    n_oxy       = sum(merge_oxygen == "Yes", na.rm = TRUE),
    n_death_oxy = sum(merge_oxygen == "Yes" & outcome_status == "Died", na.rm = TRUE),
    p_Oxygen    = round(100 * n_death_oxy / n_oxy, 1),
    
    n_vent        = sum(merge_vent == "Yes", na.rm = TRUE),
    n_death_vent  = sum(merge_vent == "Yes" & outcome_status == "Died", na.rm = TRUE),
    p_Ventilated = round(100 * n_death_vent / n_vent, 1),
    
    n_icu       = sum(merge_icu == "Yes", na.rm = TRUE),
    n_death_icu = sum(merge_icu == "Yes" & outcome_status == "Died", na.rm = TRUE),
    p_ICU       = round(100 * n_death_icu / n_icu, 1)
    ) %>% 
  mutate(project = paste(country, project, sep = " - ")) %>% 
  pivot_longer(cols = c(p_Oxygen, p_Ventilated, p_ICU),
               names_to = "therapy",
               names_prefix = "p_",
               values_to = "mortality") %>% 
  mutate(therapy = factor(therapy, 
                          levels = c("Oxygen", "Ventilated", "ICU")))  %>% 

  ggplot(aes(x = reorder(project, desc(country)),
             y = mortality,
             size = n_admit,
             colour = therapy)) +
  geom_point(alpha = 0.8,
             position = position_dodge2(0.2)) +
  coord_flip() +
  facet_wrap(~therapy, ncol = 1, scales = "free") +
  labs(x = "",
       y = "Mortality (% of deceased among cases)",
       title = "Mortality by therapy received, by project") +
  
  ggthemes::scale_colour_tableau(name = "Therapy received", palette = "Tableau 20") +
  
  scale_size_continuous(name = "Number of hosp. cases\nin project",
                        # breaks = c(10, 100, 1000, 4000, 6000)
  ) +
  
  theme_light() + 
  theme(legend.position = 'right', 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank())


ggsave(file.path(path.local.msf.graphs.oc, paste0('fig6', '_', week_report, '.png')),
       plot = fig6, 
       width = 8, 
       height = 10, 
       scale = 1.1,
       dpi = 320)

fig6
```



## Table 16

Number of patients with comorbidities and proportion of hospitalizations and deaths

```{r tble16}
list_comorb <- c("obesity", "Comcond_diabetes", "hypertension", "Comcond_renal")


tble16 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, Comcond_01, Comcond_diabetes, hypertension,
         Comcond_renal, outcome_status, obesity) %>%
  group_by(country, project) %>% 
  summarise(
    n_all = n(), # Visits (cases) at project level
    
    n_comorb = sum(Comcond_01 == 1, na.rm = TRUE), # at least one comorb (cases)
    p_comorb = n_comorb / n_all,
    a_comorb = format_nbp(n_comorb, p_comorb),
            
    n_comorb_hospi = sum(Comcond_01 == 1 & merge_admit == "Yes", na.rm = TRUE), #hospitalised, at least one comorb
    p_comorb_hospi = n_comorb_hospi / n_comorb,
    a_comorb_hospi = format_nbp(n_comorb_hospi, p_comorb_hospi),
            
    n_comorb_death = sum(Comcond_01 == 1 & outcome_status == "Died", na.rm = TRUE), 
    p_comorb_death = n_comorb_death / n_comorb_hospi,
    a_comorb_death = format_nbp(n_comorb_death, p_comorb_death),
            
            
            n_obesity = sum(obesity == "Yes", na.rm = TRUE),
            p_obesity = n_obesity / n_comorb,
            a_obesity = format_nbp(n_obesity, p_obesity),
            
            n_obesity_hospi = sum(obesity == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_obesity_hospi = n_obesity_hospi / n_obesity,
            a_obesity_hospi = format_nbp(n_obesity_hospi, p_obesity_hospi),
            
            n_obesity_death = sum(obesity == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_obesity_death = n_obesity_death / n_obesity_hospi,
            a_obesity_death = format_nbp(n_obesity_death, p_obesity_death),
            
            
            n_diabetes = sum(Comcond_diabetes == "Yes", na.rm = TRUE),
            p_diabetes = n_diabetes / n_comorb,
            a_diabetes = format_nbp(n_diabetes, p_diabetes),
            
            n_diabetes_hospi = sum(Comcond_diabetes == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_diabetes_hospi = n_diabetes_hospi / n_diabetes,
            a_diabetes_hospi = format_nbp(n_diabetes_hospi, p_diabetes_hospi),
            
            n_diabetes_death = sum(Comcond_diabetes == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_diabetes_death = n_diabetes_death / n_diabetes_hospi,
            a_diabetes_death = format_nbp(n_diabetes_death, p_diabetes_death),
            
            
            n_hypertension  = sum(hypertension == "Yes", na.rm = TRUE),
            p_hypertension  = n_hypertension / n_comorb,
            a_hypertension  = format_nbp(n_hypertension, p_hypertension),
            
            n_hypertension_hospi  = sum(hypertension == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_hypertension_hospi  = n_hypertension_hospi / n_hypertension,
            a_hypertension_hospi  = format_nbp(n_hypertension_hospi, p_hypertension_hospi),
            
            n_hypertension_death  = sum(hypertension == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_hypertension_death  = n_hypertension_death / n_hypertension_hospi,
            a_hypertension_death  = format_nbp(n_hypertension_death, p_hypertension_death),
            
            
            n_chronic_renal = sum(Comcond_renal == "Yes", na.rm = TRUE),
            p_chronic_renal = n_chronic_renal / n_comorb,
            a_chronic_renal = format_nbp(n_chronic_renal, p_chronic_renal),
            
            n_chronic_renal_hospi = sum(Comcond_renal == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_chronic_renal_hospi = n_chronic_renal_hospi / n_chronic_renal,
            a_chronic_renal_hospi = format_nbp(n_chronic_renal_hospi, p_chronic_renal_hospi),
            
            n_chronic_renal_death = sum(Comcond_renal == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_chronic_renal_death = n_chronic_renal_death / n_chronic_renal_hospi,
            a_chronic_renal_death = format_nbp(n_chronic_renal_death, p_chronic_renal_death)
  ) %>% 
  select(country, project, starts_with("a_")) 



gtble16 <- tble16 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    
    a_comorb       = 'N',
    a_comorb_hospi = 'Hospitalised',
    a_comorb_death = 'Deceased',
    
    a_obesity       = 'N',
    a_obesity_hospi = 'Hospitalised',
    a_obesity_death = 'Deceased',
    
    a_diabetes       = 'N',
    a_diabetes_hospi = 'Hospitalised',
    a_diabetes_death = 'Deceased',
    
    a_hypertension       = 'N',
    a_hypertension_hospi = 'Hospitalised',
    a_hypertension_death = 'Deceased',
    
    a_chronic_renal       = 'N',
    a_chronic_renal_hospi = 'Hospitalised',
    a_chronic_renal_death = 'Deceased') %>% 
  
  tab_spanner(
    label = 'At least one documented comorbidity',
    columns = vars(a_comorb, a_comorb_hospi, a_comorb_death)) %>%  
   tab_spanner(
    label = 'Obesity',
    columns = contains("_obesity")) %>%
  tab_spanner(
    label = 'Diabete',
    columns = contains("_diabetes")) %>%
  tab_spanner(
    label = 'Hypertension',
    columns = contains("_hypertension")) %>%
  tab_spanner(
    label = 'Chronic renal',
    columns = contains("_chronic_renal")) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)

gtsave(gtble16, 
       file.path(path.local.msf.tables.oc, paste0('gtble16', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble16 %>% 
  tab_header(
    title = 'Number of patients with comorbidities and proportion of hospitalizations and deaths')
```

## Figure 7 TODO

Comorbidities by severity and project


## Table 17

Number of patients with coinfections and proportion of hospitalizations and death

```{r tble17}

list_coinf <- c("malaria", "hiv_status", "tb_active", "tb_treatment_past", "malnutrition")


tble17 <- dta_linelist %>%
  filter(covid_status %in% c('Confirmed', 'Probable', 'Suspected')) %>%
  select(country, project, merge_admit, outcome_status, malaria, hiv_status, 
         tb_active, tb_treatment_past, malnutrition) %>%
  group_by(country, project) %>% 
  mutate(coinf = ifelse(malaria == "Yes" | hiv_status == "Yes" | tb_active == "Yes" |
                          tb_treatment_past == "Yes" | malnutrition == "Yes",
                        1, 0)) %>% 
  summarise(n_coinf = sum(coinf == 1, na.rm = TRUE),
            p_coinf = n_coinf / n(),
            a_coinf = format_nbp(n_coinf, p_coinf),
            
            n_coinf_hospi = sum(coinf == 1 & merge_admit == "Yes", na.rm = TRUE), 
            p_coinf_hospi = n_coinf_hospi / n_coinf,
            a_coinf_hospi = format_nbp(n_coinf_hospi, p_coinf_hospi),
            
            n_coinf_death = sum(coinf == 1 & outcome_status == "Died", na.rm = TRUE), 
            p_coinf_death = n_coinf_death / n_coinf,
            a_coinf_death = format_nbp(n_coinf_death, p_coinf_death),
            
            
            n_malaria = sum(malaria == "Yes", na.rm = TRUE),
            p_malaria = n_malaria / n_coinf,
            a_malaria = format_nbp(n_malaria, p_malaria),
            
            n_malaria_hospi = sum(malaria == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_malaria_hospi = n_malaria_hospi / n_malaria,
            a_malaria_hospi = format_nbp(n_malaria_hospi, p_malaria_hospi),
            
            n_malaria_death = sum(malaria == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_malaria_death = n_malaria_death / n_malaria,
            a_malaria_death = format_nbp(n_malaria_death, p_malaria_death),
            
            
            n_hiv = sum(hiv_status == "Yes", na.rm = TRUE),
            p_hiv = n_hiv / n_coinf,
            a_hiv = format_nbp(n_hiv, p_hiv),
            
            n_hiv_hospi = sum(hiv_status == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_hiv_hospi = n_hiv_hospi / n_hiv,
            a_hiv_hospi = format_nbp(n_hiv_hospi, p_hiv_hospi),
            
            n_hiv_death = sum(hiv_status == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_hiv_death = n_hiv_death / n_hiv,
            a_hiv_death = format_nbp(n_hiv_death, p_hiv_death),
            
            
            n_tb_active = sum(tb_active == "Yes", na.rm = TRUE),
            p_tb_active = n_tb_active / n_coinf,
            a_tb_active = format_nbp(n_tb_active, p_tb_active),
            
            n_tb_active_hospi = sum(tb_active == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_tb_active_hospi = n_tb_active_hospi / n_tb_active,
            a_tb_active_hospi = format_nbp(n_tb_active_hospi, p_tb_active_hospi),
            
            n_tb_active_death = sum(tb_active == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_tb_active_death = n_tb_active_death / n_tb_active,
            a_tb_active_death = format_nbp(n_tb_active_death, p_tb_active_death),
            
            
            n_tb_past = sum(tb_treatment_past == "Yes", na.rm = TRUE),
            p_tb_past = n_tb_past / n_coinf,
            a_tb_past = format_nbp(n_tb_past, p_tb_past),
            
            n_tb_past_hospi = sum(tb_treatment_past == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_tb_past_hospi = n_tb_past_hospi / n_tb_past,
            a_tb_past_hospi = format_nbp(n_tb_past_hospi, p_tb_past_hospi),
            
            n_tb_past_death = sum(tb_treatment_past == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_tb_past_death = n_tb_past_death / n_tb_past,
            a_tb_past_death = format_nbp(n_tb_past_death, p_tb_past_death),
            
            n_malnutrition = sum(malnutrition == "Yes", na.rm = TRUE),
            p_malnutrition = n_malnutrition / n_coinf,
            a_malnutrition = format_nbp(n_malnutrition, p_malnutrition),
            
            n_malnutrition_hospi = sum(malnutrition == "Yes" & merge_admit == "Yes", na.rm = TRUE),
            p_malnutrition_hospi = n_malnutrition_hospi / n_malnutrition,
            a_malnutrition_hospi = format_nbp(n_malnutrition_hospi, p_malnutrition_hospi),
            
            n_malnutrition_death = sum(malnutrition == "Yes" & outcome_status == "Died", na.rm = TRUE),
            p_malnutrition_death = n_malnutrition_death / n_malnutrition,
            a_malnutrition_death = format_nbp(n_malnutrition_death, p_malnutrition_death),
            
  ) %>% 
  select(country, project, starts_with("a_")) 



gtble17 <- tble17 %>% 
  gt() %>%
  cols_label(
    country    = 'Country',
    project    = 'Project',
    
    a_coinf       = 'N' ,
    a_coinf_hospi = 'Hospitalised',
    a_coinf_death = 'Deceased',
    
    a_malaria       = 'N' ,
    a_malaria_hospi = 'Hospitalised',
    a_malaria_death = 'Deceased',
    
    a_hiv       = 'N',
    a_hiv_hospi = 'Hospitalised',
    a_hiv_death = 'Deceased',
    
    a_tb_active       = 'N',
    a_tb_active_hospi = 'Hospitalised',
    a_tb_active_death = 'Deceased',
    
    a_tb_past        = 'N',
    a_tb_past_hospi  = 'Hospitalised',
    a_tb_past_death = 'Deceased',
    
    a_malnutrition       = 'N',
    a_malaria_hospi      = 'Hospitalised',
    a_malnutrition_death = 'Deceased') %>% 
  
  tab_spanner(
    label = 'At least one documented co-infection',
    columns = vars(a_coinf, a_coinf_hospi, a_coinf_death)) %>%  
  tab_spanner(
    label = 'Malaria',
    columns = contains("_malaria")) %>%
  tab_spanner(
    label = 'HIV',
    columns = contains("_hiv")) %>%
  tab_spanner(
    label = 'Tuberculosis active',
    columns = contains("_tb_active")) %>%
  tab_spanner(
    label = 'Tuberculosis treatment in the past',
    columns = contains("_tb_past")) %>%
  tab_spanner(
    label = 'Malnutrition',
    columns = contains("_malnutrition")) %>%
  
  fmt_missing(
    columns = starts_with('n_'),
    missing_text = "0") %>%
  
  cols_align(
    align = 'center',
    columns = everything()) %>%
  
  tab_options(
    column_labels.font.weight = "bold", 
    row_group.font.weight = "bold", 
    data_row.padding = px(2), 
    row_group.padding = px(2),
    row.striping.include_table_body = TRUE)

gtsave(gtble17, 
       file.path(path.local.msf.tables.oc, paste0('gtble17', '_', week_report, '.html')), 
       inline_css = TRUE) %>% 
  invisible()


gtble17 %>% 
  tab_header(
    title = 'Number of patients with coinfections and proportion of hospitalizations and death')
```



## Figure 8 TODO
Coinfections by severity and project

## Table 18
Number of patients with complications, by project

Data non available
